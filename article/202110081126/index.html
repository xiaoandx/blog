<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Egg.js 开发常用框架整合 | 大眼睛工程师</title>
  <meta name="description" content="概述Egg.js 为企业级框架和应用而生，我们希望由 Egg.js 孕育出更多上层框架，帮助开发团队和开发人员降低开发和维护成本。 起步api 开发配置 关闭csrf{app_root} &#x2F; config &#x2F; config.default.js  123456&#x2F;&#x2F; close csrfconfig.security &#x3D; &amp;#123;        csrf: &amp;#123;            e">
<meta property="og:type" content="article">
<meta property="og:title" content="Egg.js 开发常用框架整合">
<meta property="og:url" content="https://blog.xiaoandx.club/article/202110081126/index.html">
<meta property="og:site_name" content="一个拥有像素眼的后端工程师">
<meta property="og:description" content="概述Egg.js 为企业级框架和应用而生，我们希望由 Egg.js 孕育出更多上层框架，帮助开发团队和开发人员降低开发和维护成本。 起步api 开发配置 关闭csrf{app_root} &#x2F; config &#x2F; config.default.js  123456&#x2F;&#x2F; close csrfconfig.security &#x3D; &amp;#123;        csrf: &amp;#123;            e">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/203749/1/10204/8569/615fd0d9Ea5ec0343/b2c8eb3e321aee64.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/206752/24/4037/85477/615fd0a7E6848c542/d24db78678726981.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/197016/14/11916/74577/615fd2a8E11a29f37/17e79d037c080963.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/203333/15/9895/4190/615fd512E3130bc82/707220bcbde9945c.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/204888/28/9965/4416/615fd52dE98229b16/f8ffa4011eeadfd1.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/204225/3/10138/6453/615fd545E30a17745/9242a5aede4ac7ec.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/204161/37/10083/17098/615fde9fE31f4be30/fde296b9f495314a.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/92081/36/18938/17670/615fdf71E7f48d61d/70d024de3285817a.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/201411/20/10482/3174/615fdf95E1471feae/0d6d58b8bb3b0fa9.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/208424/28/4107/9331/615fdf9bE8abf5c51/6dacbf9689bda1cf.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/152513/18/22823/17812/615fe058E53894b7e/56a6d6afa1582e71.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/109109/6/19823/108833/615fe067E7949496c/935c86355f731637.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/209552/17/4258/64268/615fe06dEee0923f2/126c8173a5a02c9a.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/205661/22/10103/49539/615fe17cE89c8a408/a87276ba1ca37e7b.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/112322/4/19179/29102/615fe60eEc5ee6bc1/3596b453106f7407.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/207195/15/4204/12995/615fe614E3f83cf17/224e53962e7ced58.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/108841/29/20167/41783/615fe61aE777f4285/e053856d85785484.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/198351/14/12064/33381/615fe621E9b04051c/6b3544f166682c66.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/209181/35/4065/14205/615fe62dE7a75e350/acc47710f3b4eb68.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/200603/34/11881/6193/615fe68bE53065cce/195808094e0f6f74.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/200887/37/10802/14137/615fe6aeE1a9d8ba3/a13b4b4d66f0cbdc.png">
<meta property="og:image" content="https://box.kancloud.cn/0d3cfa1f406928101ea7d3094ee017e7_801x189.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/207920/30/4116/48611/615fe7e4E30551f2d/f6e16f56e85c5aba.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/201943/22/10238/40306/615fe7e9Ec8d61fb4/4006fe1c5a285398.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/205095/27/10045/37975/615fe7f3Ea3c76960/c31fda846f433ec0.png">
<meta property="og:image" content="https://dd-static.jd.com/ddimg/jfs/t1/210765/12/4110/10887/615fe7c7E44446d09/519474834cc0172f.png">
<meta property="article:published_time" content="2021-10-07T16:00:00.000Z">
<meta property="article:modified_time" content="2021-10-08T06:43:13.000Z">
<meta property="article:author" content="XIAOANDX">
<meta property="article:tag" content="RESTful">
<meta property="article:tag" content="NodeJs">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://dd-static.jd.com/ddimg/jfs/t1/203749/1/10204/8569/615fd0d9Ea5ec0343/b2c8eb3e321aee64.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://blog.xiaoandx.club/article/202110081126/index.html">
  
    <link rel="alternate" href="/atom.xml" title="一个拥有像素眼的后端工程师" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.0"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/xiaoandx" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.png" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">WEI.ZHOU</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">大眼睛工程师</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> ChengDu, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/xiaoandx" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="https://www.xiaoandx.club" target="_blank" title="Resume" data-toggle=tooltip data-placement=top><i class="icon icon-resume"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>2021年新开始新起点</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E9%9D%A2%E8%AF%95/">Java面试</a><span class="category-list-count">103</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/NodeJs/">NodeJs</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%A3%E7%A0%81%E5%88%86%E4%BA%AB/">代码分享</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">学习记录</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/">学习资料</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7/">实用工具</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%80%E5%B7%A7%E5%88%86%E4%BA%AB/">技巧分享</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%A5%E9%94%99%E6%80%BB%E7%BB%93/">报错总结</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/API/" rel="tag">API</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C-or-C/" rel="tag">C or C++</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/" rel="tag">CSS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IDEA/" rel="tag">IDEA</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a><span class="tag-list-count">102</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaWeb/" rel="tag">JavaWeb</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Maven/" rel="tag">Maven</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NodeJs/" rel="tag">NodeJs</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pc/" rel="tag">Pc</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RESTful/" rel="tag">RESTful</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VMware/" rel="tag">VMware</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WPS%E5%8E%BB%E5%B9%BF%E5%91%8A/" rel="tag">WPS去广告</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/baidu/" rel="tag">baidu</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/free/" rel="tag">free</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gitignore/" rel="tag">gitignore</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/object-fit/" rel="tag">object-fit</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/replaced-element/" rel="tag">replaced element</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reset/" rel="tag">reset</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/" rel="tag">shell</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows%E6%88%AA%E5%9B%BE%E8%BD%AF%E4%BB%B6/" rel="tag">windows截图软件</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86/" rel="tag">前端知识</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%88%AA%E5%9B%BE%E8%BD%AF%E4%BB%B6/" rel="tag">截图软件</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/" rel="tag">数据结构和算法</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BE%A4%E5%8F%91%E9%82%AE%E4%BB%B6/" rel="tag">群发邮件</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%E6%A6%82%E8%AE%BA/" rel="tag">软件工程概论</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E6%8C%87%E5%8D%97/" rel="tag">面试指南</a><span class="tag-list-count">103</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/API/" style="font-size: 13.11px;">API</a> <a href="/tags/C/" style="font-size: 13px;">C</a> <a href="/tags/C-or-C/" style="font-size: 13.78px;">C or C++</a> <a href="/tags/C/" style="font-size: 13px;">C++</a> <a href="/tags/CSS/" style="font-size: 13px;">CSS</a> <a href="/tags/IDEA/" style="font-size: 13px;">IDEA</a> <a href="/tags/Java/" style="font-size: 13.89px;">Java</a> <a href="/tags/JavaWeb/" style="font-size: 13.56px;">JavaWeb</a> <a href="/tags/Linux/" style="font-size: 13.11px;">Linux</a> <a href="/tags/Maven/" style="font-size: 13px;">Maven</a> <a href="/tags/NodeJs/" style="font-size: 13.56px;">NodeJs</a> <a href="/tags/Pc/" style="font-size: 13px;">Pc</a> <a href="/tags/Python/" style="font-size: 13.33px;">Python</a> <a href="/tags/RESTful/" style="font-size: 13.11px;">RESTful</a> <a href="/tags/Spring/" style="font-size: 13px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 13.22px;">SpringBoot</a> <a href="/tags/VMware/" style="font-size: 13px;">VMware</a> <a href="/tags/WPS%E5%8E%BB%E5%B9%BF%E5%91%8A/" style="font-size: 13px;">WPS去广告</a> <a href="/tags/Web/" style="font-size: 13px;">Web</a> <a href="/tags/baidu/" style="font-size: 13px;">baidu</a> <a href="/tags/free/" style="font-size: 13.56px;">free</a> <a href="/tags/git/" style="font-size: 13.67px;">git</a> <a href="/tags/gitignore/" style="font-size: 13px;">gitignore</a> <a href="/tags/object-fit/" style="font-size: 13px;">object-fit</a> <a href="/tags/replaced-element/" style="font-size: 13px;">replaced element</a> <a href="/tags/reset/" style="font-size: 13px;">reset</a> <a href="/tags/shell/" style="font-size: 13.11px;">shell</a> <a href="/tags/windows%E6%88%AA%E5%9B%BE%E8%BD%AF%E4%BB%B6/" style="font-size: 13px;">windows截图软件</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 13.44px;">前端</a> <a href="/tags/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86/" style="font-size: 13.22px;">前端知识</a> <a href="/tags/%E6%88%AA%E5%9B%BE%E8%BD%AF%E4%BB%B6/" style="font-size: 13px;">截图软件</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/" style="font-size: 13.11px;">数据结构和算法</a> <a href="/tags/%E7%BE%A4%E5%8F%91%E9%82%AE%E4%BB%B6/" style="font-size: 13px;">群发邮件</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 13.11px;">设计模式</a> <a href="/tags/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%E6%A6%82%E8%AE%BA/" style="font-size: 13px;">软件工程概论</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E6%8C%87%E5%8D%97/" style="font-size: 14px;">面试指南</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a><span class="archive-list-count">103</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">16</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E6%8A%80%E5%B7%A7%E5%88%86%E4%BA%AB/">技巧分享</a>
              </p>
              <p class="item-title">
                <a href="/article/202110081126/" class="title">Egg.js 开发常用框架整合</a>
              </p>
              <p class="item-date">
                <time datetime="2021-10-07T16:00:00.000Z" itemprop="datePublished">2021-10-08</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E4%BB%A3%E7%A0%81%E5%88%86%E4%BA%AB/">代码分享</a>
              </p>
              <p class="item-title">
                <a href="/article/202110061446/" class="title">Egg.js自定义插件(xml解析器)</a>
              </p>
              <p class="item-date">
                <time datetime="2021-10-05T16:00:00.000Z" itemprop="datePublished">2021-10-06</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">学习记录</a>
              </p>
              <p class="item-title">
                <a href="/article/202110061639/" class="title">软件设计模式实现一个医院系统的部分功能</a>
              </p>
              <p class="item-date">
                <time datetime="2021-10-05T16:00:00.000Z" itemprop="datePublished">2021-10-06</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">学习记录</a>
              </p>
              <p class="item-title">
                <a href="/article/202110051125/" class="title">ApiDoc APi开发文档生成器</a>
              </p>
              <p class="item-date">
                <time datetime="2021-10-04T16:00:00.000Z" itemprop="datePublished">2021-10-05</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">学习记录</a>
              </p>
              <p class="item-title">
                <a href="/article/202109301232/" class="title">RESTful API 状态码</a>
              </p>
              <p class="item-date">
                <time datetime="2021-09-29T16:00:00.000Z" itemprop="datePublished">2021-09-30</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%B7%E6%AD%A5"><span class="toc-number">2.</span> <span class="toc-text">起步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#api-%E5%BC%80%E5%8F%91%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">api 开发配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1"><span class="toc-number">3.</span> <span class="toc-text">路由</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#api%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6"><span class="toc-number">3.1.</span> <span class="toc-text">api版本控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#resfulApi-%E8%B7%AF%E7%94%B1%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6"><span class="toc-number">3.2.</span> <span class="toc-text">resfulApi 路由版本控制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%92%8C%E5%BC%82%E5%B8%B8"><span class="toc-number">4.</span> <span class="toc-text">错误和异常</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">4.1.</span> <span class="toc-text">全局异常处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#egg-resfulAPI-%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">4.2.</span> <span class="toc-text">egg resfulAPI 全局异常处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">4.3.</span> <span class="toc-text">统一错误处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">5.</span> <span class="toc-text">数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#egg-js-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB"><span class="toc-number">5.1.</span> <span class="toc-text">egg.js 数据库迁移</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sequelize-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB%E5%91%BD%E4%BB%A4"><span class="toc-number">5.1.1.</span> <span class="toc-text">sequelize 数据库迁移命令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">5.1.2.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E8%A1%A8"><span class="toc-number">5.1.3.</span> <span class="toc-text">创建数据迁移表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.1.4.</span> <span class="toc-text">创建数据模型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sequelize%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.2.</span> <span class="toc-text">sequelize数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sequelize-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.2.1.</span> <span class="toc-text">sequelize 数据类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-1"><span class="toc-number">5.3.</span> <span class="toc-text">配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sequelize-%E6%95%B0%E6%8D%AE%E5%BA%93%E9%85%8D%E7%BD%AE"><span class="toc-number">5.3.1.</span> <span class="toc-text">sequelize 数据库配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95"><span class="toc-number">5.3.2.</span> <span class="toc-text">索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E9%85%8D%E7%BD%AE"><span class="toc-number">5.3.3.</span> <span class="toc-text">连接配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E"><span class="toc-number">5.4.</span> <span class="toc-text">新增</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sequelize-%E6%96%B0%E5%A2%9E%E4%B8%80%E6%9D%A1%E6%95%B0%E6%8D%AE"><span class="toc-number">5.4.1.</span> <span class="toc-text">sequelize 新增一条数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.5.</span> <span class="toc-text">查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.5.1.</span> <span class="toc-text">条件查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.5.2.</span> <span class="toc-text">模糊查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.5.3.</span> <span class="toc-text">排序查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E5%AD%A6%E6%88%90%E7%BB%A9%E4%BB%8E%E9%AB%98%E5%88%B0%E4%BD%8E%E6%8E%92%E5%BA%8F"><span class="toc-number">5.5.3.1.</span> <span class="toc-text">数学成绩从高到低排序</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%89%E7%85%A7%E6%95%B0%E5%AD%A6%E6%88%90%E7%BB%A9%E6%8E%92%E5%BA%8F%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%95%B0%E5%AD%A6%E6%88%90%E7%BB%A9%E4%B8%80%E6%A0%B7%EF%BC%8C%E6%89%8D%E6%8C%89%E7%85%A7%E8%8B%B1%E8%AF%AD%E6%88%90%E7%BB%A9%E5%80%92%E5%BA%8F%E6%8E%92%E5%BA%8F"><span class="toc-number">5.5.3.2.</span> <span class="toc-text">按照数学成绩排序，如果数学成绩一样，才按照英语成绩倒序排序</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.5.4.</span> <span class="toc-text">聚合查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#COUNT-%E8%AE%A1%E7%AE%97%E6%95%B0%E9%87%8F"><span class="toc-number">5.5.4.1.</span> <span class="toc-text">COUNT 计算数量</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MAX-%E8%AE%A1%E7%AE%97%E6%9C%80%E5%A4%A7%E5%80%BC"><span class="toc-number">5.5.4.2.</span> <span class="toc-text">MAX 计算最大值</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MIN-%E8%AE%A1%E7%AE%97%E6%9C%80%E5%B0%8F%E5%80%BC"><span class="toc-number">5.5.4.3.</span> <span class="toc-text">MIN 计算最小值</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SUN-%E6%B1%82%E5%92%8C"><span class="toc-number">5.5.4.4.</span> <span class="toc-text">SUN 求和</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AVG-%E5%B9%B3%E5%9D%87%E5%80%BC"><span class="toc-number">5.5.4.5.</span> <span class="toc-text">AVG 平均值</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%BB%84%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.5.5.</span> <span class="toc-text">分组查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#GROUP-%E5%88%86%E7%BB%84%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.5.5.1.</span> <span class="toc-text">GROUP 分组查询</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.5.6.</span> <span class="toc-text">分页查询</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#limt-%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.5.6.1.</span> <span class="toc-text">limt 分页查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9"><span class="toc-number">5.6.</span> <span class="toc-text">修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4"><span class="toc-number">5.7.</span> <span class="toc-text">删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%99%A8"><span class="toc-number">5.8.</span> <span class="toc-text">获取器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%99%A8"><span class="toc-number">5.9.</span> <span class="toc-text">修改器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%B1%9E%E6%80%A7"><span class="toc-number">5.10.</span> <span class="toc-text">静态属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E9%AA%8C%E8%AF%81"><span class="toc-number">5.11.</span> <span class="toc-text">字段验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E9%94%AE%E7%BA%A6%E6%9D%9F"><span class="toc-number">5.12.</span> <span class="toc-text">外键约束</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E6%A8%A1%E5%9E%8B"><span class="toc-number">5.13.</span> <span class="toc-text">关联模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E4%B8%80"><span class="toc-number">5.13.1.</span> <span class="toc-text">一对一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E5%AF%B9%E5%A4%9A"><span class="toc-number">5.13.2.</span> <span class="toc-text">一对多</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">5.14.</span> <span class="toc-text"></span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A6%E5%A4%96%E8%BF%9E%E6%8E%A5"><span class="toc-number">5.14.1.</span> <span class="toc-text">左外连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E5%AF%B9%E5%A4%9A"><span class="toc-number">5.14.2.</span> <span class="toc-text">多对多</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E3%80%81model-%E5%BB%BA%E7%AB%8B3%E5%BC%A0%E6%A8%A1%E5%9E%8B%E8%A1%A8"><span class="toc-number">5.14.2.1.</span> <span class="toc-text">一、model 建立3张模型表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%BB%BA%E7%AB%8B%E8%A1%A8%E5%85%B3%E7%B3%BB"><span class="toc-number">5.14.2.2.</span> <span class="toc-text">二、建立表关系</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%B7%BB%E5%8A%A0"><span class="toc-number">5.14.2.3.</span> <span class="toc-text">三、添加</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2"><span class="toc-number">5.14.2.4.</span> <span class="toc-text">四、关联查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%9B%B4%E6%96%B0"><span class="toc-number">5.14.2.5.</span> <span class="toc-text">五、更新</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E4%BA%8B%E5%8A%A1"><span class="toc-number">5.14.2.6.</span> <span class="toc-text">六、事务</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E6%98%BE%E7%A4%BA%E9%9A%90%E8%97%8F"><span class="toc-number">5.14.3.</span> <span class="toc-text">字段显示隐藏</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">5.14.4.</span> <span class="toc-text">事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E8%87%AA%E5%A2%9E"><span class="toc-number">5.14.5.</span> <span class="toc-text">字段自增</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE%E9%AA%8C%E8%AF%81"><span class="toc-number">5.15.</span> <span class="toc-text">请求数据验证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#egg-validate"><span class="toc-number">5.15.1.</span> <span class="toc-text">egg-validate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#indicative%E9%AA%8C%E8%AF%81%E5%99%A8"><span class="toc-number">5.15.2.</span> <span class="toc-text">indicative验证器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#egg-validate-plus"><span class="toc-number">5.15.3.</span> <span class="toc-text">egg-validate-plus</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#betterValidate"><span class="toc-number">5.15.4.</span> <span class="toc-text">betterValidate</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#egg-%E4%B8%AD%E4%BD%BF%E7%94%A8-BetterValidate"><span class="toc-number">5.15.4.1.</span> <span class="toc-text">egg 中使用 BetterValidate</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#BetterValidate-%E6%A0%A1%E9%AA%8C%E8%A7%84%E5%88%99"><span class="toc-number">5.15.4.2.</span> <span class="toc-text">BetterValidate 校验规则</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">6.</span> <span class="toc-text">中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">6.1.</span> <span class="toc-text">编写中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-2"><span class="toc-number">6.1.1.</span> <span class="toc-text">配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">6.2.</span> <span class="toc-text">使用中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E5%BA%94%E7%94%A8%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">6.2.1.</span> <span class="toc-text">在应用中使用中间件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E6%A1%86%E6%9E%B6%E5%92%8C%E6%8F%92%E4%BB%B6%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">6.2.2.</span> <span class="toc-text">在框架和插件中使用中间件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#router-%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">6.2.3.</span> <span class="toc-text">router 中使用中间件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%86%E6%9E%B6%E9%BB%98%E8%AE%A4%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">6.3.</span> <span class="toc-text">框架默认中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Koa-%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">6.4.</span> <span class="toc-text">使用 Koa 的中间件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">6.5.</span> <span class="toc-text">通用配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#enable"><span class="toc-number">6.5.1.</span> <span class="toc-text">enable</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#match-%E5%92%8C-ignore"><span class="toc-number">6.5.2.</span> <span class="toc-text">match 和 ignore</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E5%85%A8"><span class="toc-number">7.</span> <span class="toc-text">安全</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86"><span class="toc-number">7.1.</span> <span class="toc-text">数据加密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E5%90%91%E5%8A%A0%E5%AF%86"><span class="toc-number">7.2.</span> <span class="toc-text">单向加密</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#crypto-%E5%8A%A0%E5%AF%86%E5%AE%9E%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">7.2.1.</span> <span class="toc-text">crypto 加密实例代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%81%E8%A3%85Crypto%E4%BD%9C%E4%B8%BAegg-js-%E4%B8%93%E7%94%A8%E5%8A%A0%E5%AF%86%E5%87%BD%E6%95%B0"><span class="toc-number">7.2.2.</span> <span class="toc-text">封装Crypto作为egg.js 专用加密函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8A%E4%BC%A0"><span class="toc-number">8.</span> <span class="toc-text">上传</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#path%E6%A8%A1%E5%9D%97"><span class="toc-number">8.1.</span> <span class="toc-text">path模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#egg-%E5%8D%95%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">8.1.1.</span> <span class="toc-text">egg 单文件上传</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84%E5%88%86%E8%A7%A3-%E7%BB%84%E5%90%88"><span class="toc-number">8.1.2.</span> <span class="toc-text">文件路径分解&#x2F;组合</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">8.2.</span> <span class="toc-text">单文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#egg-%E5%8D%95%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0-1"><span class="toc-number">8.2.1.</span> <span class="toc-text">egg 单文件上传</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-pump-%E6%8F%92%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">8.2.2.</span> <span class="toc-text">使用 pump 插件上传</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">8.3.</span> <span class="toc-text">多文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#egg-%E5%A4%9A%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">8.3.1.</span> <span class="toc-text">egg 多文件上传</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%89%E7%85%A7%E6%97%A5%E6%9C%9F%E5%AD%98%E5%82%A8"><span class="toc-number">8.4.</span> <span class="toc-text">按照日期存储</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Eegg-%E5%B0%81%E8%A3%85%E5%85%AC%E5%85%B1%E4%B8%8A%E4%BC%A0%E7%B1%BB"><span class="toc-number">8.4.1.</span> <span class="toc-text">基于egg 封装公共上传类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E5%87%BD%E6%95%B0"><span class="toc-number">9.</span> <span class="toc-text">工具函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#egg%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E5%87%BD%E6%95%B0"><span class="toc-number">9.1.</span> <span class="toc-text">egg常用工具函数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E5%80%BC%E8%BD%AC%E6%95%B4%E5%BD%A2"><span class="toc-number">9.1.1.</span> <span class="toc-text">数值转整形</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AD%9B%E9%80%89%E5%AD%97%E6%AE%B5"><span class="toc-number">9.1.2.</span> <span class="toc-text">筛选字段</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98"><span class="toc-number">10.</span> <span class="toc-text">缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%BC%93%E5%AD%98%E6%8F%92%E4%BB%B6"><span class="toc-number">10.1.</span> <span class="toc-text">配置缓存插件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#egg-redis"><span class="toc-number">10.1.1.</span> <span class="toc-text">egg-redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%81%E8%A3%85%E5%B8%B8%E7%94%A8redis%E6%93%8D%E4%BD%9C%E7%B1%BB"><span class="toc-number">10.1.2.</span> <span class="toc-text">封装常用redis操作类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E7%BC%93%E5%AD%98"><span class="toc-number">10.2.</span> <span class="toc-text">设置缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#set-%E8%AE%BE%E7%BD%AE%E6%99%AE%E9%80%9A%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%80%BC"><span class="toc-number">10.2.1.</span> <span class="toc-text">set 设置普通类型的值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#expire-%E4%B8%BA%E4%B8%80%E4%B8%AAkey%E9%87%8D%E6%96%B0%E8%AE%BE%E7%BD%AE%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="toc-number">10.2.2.</span> <span class="toc-text">expire 为一个key重新设置过期时间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rpush-%E6%95%B0%E7%BB%84%E5%8F%B3%E4%BE%A7%E6%96%B0%E5%A2%9E"><span class="toc-number">10.2.3.</span> <span class="toc-text">rpush 数组右侧新增</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lpush-%E6%95%B0%E7%BB%84%E5%B7%A6%E8%BE%B9%E6%96%B0%E5%A2%9E"><span class="toc-number">10.2.4.</span> <span class="toc-text">lpush 数组左边新增</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sadd-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E9%9B%86%E5%90%88"><span class="toc-number">10.2.5.</span> <span class="toc-text">sadd 创建一个集合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hset-%E8%AE%BE%E7%BD%AE%E5%93%88%E5%B8%8C%E7%B1%BB%E5%9E%8B-%E5%B0%B1%E6%98%AF%E5%AD%98%E5%82%A8%E4%B8%80%E4%B8%AA%E5%AF%B9%E8%B1%A1"><span class="toc-number">10.2.6.</span> <span class="toc-text">hset 设置哈希类型 就是存储一个对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hmset-%E4%B8%80%E6%AC%A1%E6%80%A7%E8%AE%BE%E7%BD%AE%E5%A4%9A%E4%B8%AA%E5%80%BC"><span class="toc-number">10.2.7.</span> <span class="toc-text">hmset 一次性设置多个值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%BC%93%E5%AD%98"><span class="toc-number">10.3.</span> <span class="toc-text">获取缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#get-%E8%8E%B7%E5%8F%96%E6%99%AE%E9%80%9A%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%80%BC"><span class="toc-number">10.3.1.</span> <span class="toc-text">get 获取普通类型的值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#type-%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">10.3.2.</span> <span class="toc-text">type 获取数据类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lrange-%E8%8E%B7%E5%8F%96-list-%E7%B1%BB%E5%9E%8B%E4%B8%AD%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE"><span class="toc-number">10.3.3.</span> <span class="toc-text">lrange 获取 list 类型中所有数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#smembers-%E8%8E%B7%E5%8F%96%E9%9B%86%E5%90%88%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE"><span class="toc-number">10.3.4.</span> <span class="toc-text">smembers 获取集合中的所有数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hgetall-%E8%8E%B7%E5%8F%96%E5%93%88%E5%B8%8C%E7%B1%BB%E5%9E%8B%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE"><span class="toc-number">10.3.5.</span> <span class="toc-text">hgetall 获取哈希类型所有数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hget-%E8%8E%B7%E5%8F%96-Hash-%E6%8C%87%E5%AE%9A%E6%95%B0%E6%8D%AE"><span class="toc-number">10.3.6.</span> <span class="toc-text">hget 获取 Hash 指定数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#hmget-%E4%B8%80%E6%AC%A1%E6%80%A7%E8%8E%B7%E5%8F%96%E5%A4%9A%E4%B8%AA%E5%80%BC"><span class="toc-number">10.3.7.</span> <span class="toc-text">hmget 一次性获取多个值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98"><span class="toc-number">10.4.</span> <span class="toc-text">删除缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#del-%E6%B8%85%E7%A9%BA%E6%8C%87%E5%AE%9A%E7%BC%93%E5%AD%98"><span class="toc-number">10.4.1.</span> <span class="toc-text">del 清空指定缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#flushall-%E6%B8%85%E7%A9%BA%E6%89%80%E6%9C%89%E7%BC%93%E5%AD%98"><span class="toc-number">10.4.2.</span> <span class="toc-text">flushall 清空所有缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lpop-%E4%BB%8E%E6%95%B0%E7%BB%84%E6%9C%80%E5%B7%A6%E8%BE%B9%E5%88%A0%E9%99%A4%E4%B8%80%E9%A1%B9"><span class="toc-number">10.4.3.</span> <span class="toc-text">lpop 从数组最左边删除一项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rpop-%E4%BB%8E%E6%95%B0%E7%BB%84%E6%9C%80%E5%8F%B3%E8%BE%B9%E5%88%A0%E9%99%A4%E4%B8%80%E9%A1%B9"><span class="toc-number">10.4.4.</span> <span class="toc-text">rpop 从数组最右边删除一项</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-number">11.</span> <span class="toc-text">消息队列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#egg-amqplib"><span class="toc-number">11.1.</span> <span class="toc-text">egg-amqplib</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">11.2.</span> <span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rabbitMQ-%E5%AE%89%E8%A3%85"><span class="toc-number">11.2.1.</span> <span class="toc-text">rabbitMQ 安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E9%98%9F%E5%88%97"><span class="toc-number">11.3.</span> <span class="toc-text">简单队列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MQ-%E7%AE%80%E5%8D%95%E9%98%9F%E5%88%97%E5%AE%9E%E6%88%98"><span class="toc-number">11.3.1.</span> <span class="toc-text">MQ 简单队列实战</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97"><span class="toc-number">11.4.</span> <span class="toc-text">工作队列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rabbitMQ-%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97-%E8%BD%AE%E8%AF%A2%E5%88%86%E5%8F%91"><span class="toc-number">11.4.1.</span> <span class="toc-text">rabbitMQ 工作队列 轮询分发</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%BA%94%E7%AD%94"><span class="toc-number">11.5.</span> <span class="toc-text">消息应答</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E5%BA%94%E7%AD%94-ack"><span class="toc-number">11.5.1.</span> <span class="toc-text">消息应答 ack</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%82%AE%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">12.</span> <span class="toc-text">邮件系统</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nodeMailer"><span class="toc-number">12.1.</span> <span class="toc-text">nodeMailer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#egg-js-%E5%B0%81%E8%A3%85-nodeMailer-%E9%82%AE%E4%BB%B6%E5%8F%91%E9%80%81%E7%B1%BB"><span class="toc-number">12.1.1.</span> <span class="toc-text">egg.js 封装 nodeMailer 邮件发送类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E6%A8%A1%E5%9D%97"><span class="toc-number">13.</span> <span class="toc-text">第三方模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E9%9A%8F%E6%9C%BA%E6%95%B0"><span class="toc-number">13.1.</span> <span class="toc-text">生成随机数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT"><span class="toc-number">14.</span> <span class="toc-text">JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT%E9%89%B4%E6%9D%83"><span class="toc-number">14.1.</span> <span class="toc-text">JWT鉴权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EJSON-WEB-TOKEN-%E5%B0%81%E8%A3%85-%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%89%B4%E6%9D%83"><span class="toc-number">14.1.1.</span> <span class="toc-text">基于JSON WEB TOKEN 封装 中间件鉴权</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90Token"><span class="toc-number">14.2.</span> <span class="toc-text">生成Token</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JSON-WEB-TOKEN-%E7%94%9F%E6%88%90%E4%BB%A4%E7%89%8C"><span class="toc-number">14.2.1.</span> <span class="toc-text">JSON WEB TOKEN 生成令牌</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9F%AD%E4%BF%A1%E6%9C%8D%E5%8A%A1"><span class="toc-number">15.</span> <span class="toc-text">短信服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%BF%E9%87%8C%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-number">15.1.</span> <span class="toc-text">阿里短信验证码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1%E9%80%BB%E8%BE%91"><span class="toc-number">15.2.</span> <span class="toc-text">发送短信逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%BF%E9%87%8C%E7%9F%AD%E4%BF%A1Node%E7%B1%BB"><span class="toc-number">15.3.</span> <span class="toc-text">阿里短信Node类</span></a></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-202110081126" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Egg.js 开发常用框架整合
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/article/202110081126/" class="article-date">
	  <time datetime="2021-10-07T16:00:00.000Z" itemprop="datePublished">2021-10-08</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/%E6%8A%80%E5%B7%A7%E5%88%86%E4%BA%AB/">技巧分享</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/NodeJs/" rel="tag">NodeJs</a>, <a class="article-tag-link-link" href="/tags/RESTful/" rel="tag">RESTful</a>
  </span>


        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill" aria-hidden="true"></i>
	    <span id="busuanzi_container_page_pv">
			<span id="busuanzi_value_page_pv">0</span>
		</span>
	</span>


        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/article/202110081126/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>Egg.js 为企业级框架和应用而生</strong>，我们希望由 Egg.js 孕育出更多上层框架，帮助开发团队和开发人员降低开发和维护成本。</p>
<h2 id="起步"><a href="#起步" class="headerlink" title="起步"></a>起步</h2><h3 id="api-开发配置"><a href="#api-开发配置" class="headerlink" title="api 开发配置"></a>api 开发配置</h3><ol>
<li>关闭csrf<br>{app_root} / config / config.default.js</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// close csrf</span></span><br><span class="line">config.security = &#123;</span><br><span class="line">        <span class="attr">csrf</span>: &#123;</span><br><span class="line">            <span class="attr">enable</span>: <span class="literal">false</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<ol>
<li>安装mysql套件</li>
</ol>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save egg-sequelize mysql2</span><br></pre></td></tr></table></figure>

<ol>
<li>在<code>config/plugin.js</code>中引入 egg-sequelize 插件</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exports</span>.sequelize = &#123;</span><br><span class="line">  <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">package</span>: <span class="string">&#x27;egg-sequelize&#x27;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol>
<li>在<code>config/config.default.js</code>中编写 sequelize 配置</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">config.sequelize = &#123;</span><br><span class="line">    <span class="comment">// 数据库类型</span></span><br><span class="line">    <span class="attr">dialect</span>:  <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="comment">// 主机</span></span><br><span class="line">    <span class="attr">host</span>:  <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="comment">// 数据库密码</span></span><br><span class="line">    <span class="attr">password</span>:  <span class="string">&#x27;admin888&#x27;</span>,</span><br><span class="line">    <span class="comment">// 端口</span></span><br><span class="line">    <span class="attr">port</span>:  <span class="number">3306</span>,</span><br><span class="line">    <span class="comment">// 数据库</span></span><br><span class="line">    <span class="attr">database</span>:  <span class="string">&#x27;weibo&#x27;</span>,</span><br><span class="line">    <span class="comment">// 中国时区</span></span><br><span class="line">    <span class="attr">timezone</span>:  <span class="string">&#x27;+08:00&#x27;</span>,</span><br><span class="line">    <span class="comment">// 个性化配置</span></span><br><span class="line">    <span class="attr">define</span>: &#123;</span><br><span class="line">        <span class="comment">// 取消数据表名复数</span></span><br><span class="line">        <span class="attr">freezeTableName</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 自动写入时间戳 created_at updated_at</span></span><br><span class="line">        <span class="attr">timestamps</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 字段生成软删除时间戳 deleted_at</span></span><br><span class="line">        <span class="attr">paranoid</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">createdAt</span>: <span class="string">&#x27;created_at&#x27;</span>,</span><br><span class="line">        <span class="attr">updatedAt</span>: <span class="string">&#x27;updated_at&#x27;</span>,</span><br><span class="line">        <span class="attr">deletedAt</span>: <span class="string">&#x27;deleted_at&#x27;</span>,</span><br><span class="line">        <span class="comment">// 所有驼峰命名格式化</span></span><br><span class="line">        <span class="attr">underscored</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><h3 id="api版本控制"><a href="#api版本控制" class="headerlink" title="api版本控制"></a>api版本控制</h3><h3 id="resfulApi-路由版本控制"><a href="#resfulApi-路由版本控制" class="headerlink" title="resfulApi 路由版本控制"></a>resfulApi 路由版本控制</h3><ul>
<li>egg-router-plus</li>
<li>文档：<a target="_blank" rel="noopener" href="https://github.com/eggjs/egg-router-plus">https://github.com/eggjs/egg-router-plus</a></li>
<li>安装：<code>cnpm i -S egg-router-plus</code></li>
<li>配置</li>
</ul>
<ol>
<li>插件配置</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &#123;app_root&#125;/config/plugin.js</span></span><br><span class="line"><span class="built_in">exports</span>.routerPlus = &#123;</span><br><span class="line">  <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">package</span>: <span class="string">&#x27;egg-router-plus&#x27;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports =  <span class="function"><span class="params">app</span>  =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; router, controller &#125; = app;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> apiV1Router = router.namespace(<span class="string">&#x27;/api/v1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    apiV1Router.post(<span class="string">&#x27;/home&#x27;</span>, controller.home.index)</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="错误和异常"><a href="#错误和异常" class="headerlink" title="错误和异常"></a>错误和异常</h2><h3 id="全局异常处理"><a href="#全局异常处理" class="headerlink" title="全局异常处理"></a>全局异常处理</h3><h3 id="egg-resfulAPI-全局异常处理"><a href="#egg-resfulAPI-全局异常处理" class="headerlink" title="egg resfulAPI 全局异常处理"></a>egg resfulAPI 全局异常处理</h3><h3 id="统一错误处理"><a href="#统一错误处理" class="headerlink" title="统一错误处理"></a>统一错误处理</h3><ul>
<li>文档：<a target="_blank" rel="noopener" href="https://eggjs.org/zh-cn/tutorials/restful.html">https://eggjs.org/zh-cn/tutorials/restful.html</a></li>
</ul>
<hr>
<ol>
<li>自定义一个异常基类<br>app / exceptions / http_exceptions.js</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpExceptions</span> <span class="keyword">extends</span> <span class="title">Error</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">msg=<span class="string">&#x27;服务器异常&#x27;</span>, code=<span class="number">1</span>, httpCode=<span class="number">400</span></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>()</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">        <span class="built_in">this</span>.httpCode = httpCode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123; HttpExceptions &#125;;</span><br></pre></td></tr></table></figure>

<hr>
<ol>
<li>定义全局异常处理中间件<br>app / middleware / error_handler.js</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; HttpExceptions &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../exceptions/http_exceptions&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">errorHandler</span>(<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">await</span> next();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="comment">// 所有的异常都在 app 上触发一个 error 事件，框架会记录一条错误日志</span></span><br><span class="line">            ctx.app.emit(<span class="string">&#x27;error&#x27;</span>, err, ctx);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> status = err.status || <span class="number">500</span>;</span><br><span class="line">            <span class="keyword">let</span> error = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (err <span class="keyword">instanceof</span> HttpExceptions) &#123;</span><br><span class="line">                status = err.httpCode</span><br><span class="line">                error.requestUrl = <span class="string">`<span class="subst">$&#123;ctx.method&#125;</span> : <span class="subst">$&#123;ctx.path&#125;</span>`</span>;</span><br><span class="line">                error.msg = err.msg;</span><br><span class="line">                error.code = err.code;</span><br><span class="line">                error.httpCode = err.httpCode;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 未知异常，系统异常，线上不显示堆栈信息</span></span><br><span class="line">                <span class="comment">// 生产环境时 500 错误的详细错误内容不返回给客户端，因为可能包含敏感信息</span></span><br><span class="line">                error.errsInfo = status === <span class="number">500</span> &amp;&amp; ctx.app.config.env === <span class="string">&#x27;prod&#x27;</span></span><br><span class="line">                    ? <span class="string">&#x27;Internal Server Error&#x27;</span></span><br><span class="line">                    : err.message;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 从 error 对象上读出各个属性，设置到响应中</span></span><br><span class="line">            ctx.body = error;</span><br><span class="line">            <span class="keyword">if</span> (status === <span class="number">422</span>) &#123;</span><br><span class="line">                ctx.body.detail = err.errors;</span><br><span class="line">            &#125;</span><br><span class="line">            ctx.status = status;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><h3 id="egg-js-数据库迁移"><a href="#egg-js-数据库迁移" class="headerlink" title="egg.js 数据库迁移"></a>egg.js 数据库迁移</h3><p>文档：<a target="_blank" rel="noopener" href="https://eggjs.org/zh-cn/tutorials/sequelize.html">https://eggjs.org/zh-cn/tutorials/sequelize.html</a></p>
<h4 id="sequelize-数据库迁移命令"><a href="#sequelize-数据库迁移命令" class="headerlink" title="sequelize 数据库迁移命令"></a>sequelize 数据库迁移命令</h4><table>
<thead>
<tr>
<th align="left">命令</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">sequelize db:migrate</td>
<td align="left">运行迁移文件</td>
</tr>
<tr>
<td align="left">sequelize db:migrate:status</td>
<td align="left">列出所有迁移的状态</td>
</tr>
<tr>
<td align="left">sequelize db:migrate:undo</td>
<td align="left">隔离数据库：迁移：撤消</td>
</tr>
<tr>
<td align="left">sequelize db:migrate:undo:all</td>
<td align="left">还原所有运行的迁移</td>
</tr>
<tr>
<td align="left">sequelize db:create</td>
<td align="left">创建由配置指定的数据库</td>
</tr>
<tr>
<td align="left">sequelize db:drop</td>
<td align="left">删除由配置指定的数据库</td>
</tr>
</tbody></table>
<hr>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><ol>
<li>安装并配置<a target="_blank" rel="noopener" href="https://github.com/eggjs/egg-sequelize">egg-sequelize</a>插件（它会辅助我们将定义好的 Model 对象加载到 app 和 ctx 上）和<a target="_blank" rel="noopener" href="https://github.com/sidorares/node-mysql2">mysql2</a>模块：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save egg-sequelize mysql2</span><br></pre></td></tr></table></figure>

<ol>
<li>在<code>config/plugin.js</code>中引入 egg-sequelize 插件</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">exports.sequelize = &#123;</span><br><span class="line">  enable: true,</span><br><span class="line">  package: &#x27;egg-sequelize&#x27;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol>
<li>在<code>config/config.default.js</code>中编写 sequelize 配置<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/203749/1/10204/8569/615fd0d9Ea5ec0343/b2c8eb3e321aee64.png" alt="image.png"></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">config.sequelize = &#123;</span><br><span class="line">    <span class="attr">dialect</span>:  <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="attr">host</span>:  <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="attr">password</span>:  <span class="string">&#x27;xxxx&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>:  <span class="number">3306</span>,</span><br><span class="line">    <span class="attr">database</span>:  <span class="string">&#x27;friends&#x27;</span>,</span><br><span class="line">    <span class="attr">timezone</span>:  <span class="string">&#x27;+8:00&#x27;</span>,</span><br><span class="line">    <span class="attr">define</span>: &#123;</span><br><span class="line">        <span class="attr">freezeTableName</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol>
<li>sequelize 提供了<a target="_blank" rel="noopener" href="https://github.com/sequelize/cli">sequelize-cli</a>工具来实现<a target="_blank" rel="noopener" href="http://docs.sequelizejs.com/manual/tutorial/migrations.html">Migrations</a>，我们也可以在 egg 项目中引入 sequelize-cli。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev sequelize-cli</span><br></pre></td></tr></table></figure>

<ol>
<li>在 egg 项目中，我们希望将所有数据库 Migrations 相关的内容都放在<code>database</code>目录下，所以我们在项目根目录下新建一个<code>.sequelizerc</code>配置文件：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">config</span>: path.join(__dirname, <span class="string">&#x27;database/config.json&#x27;</span>),</span><br><span class="line">  <span class="string">&#x27;migrations-path&#x27;</span>: path.join(__dirname, <span class="string">&#x27;database/migrations&#x27;</span>),</span><br><span class="line">  <span class="string">&#x27;seeders-path&#x27;</span>: path.join(__dirname, <span class="string">&#x27;database/seeders&#x27;</span>),</span><br><span class="line">  <span class="string">&#x27;models-path&#x27;</span>: path.join(__dirname, <span class="string">&#x27;app/model&#x27;</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol>
<li>初始化 Migrations 配置文件和目录</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize init:config</span><br><span class="line">npx sequelize init:migrations</span><br><span class="line">npx sequelize init:models</span><br></pre></td></tr></table></figure>

<ol>
<li>执行完后会生成<code>database/config.json</code>文件和<code>database/migrations</code>目录，我们修改一下<code>database/config.json</code>中的内容，将其改成我们项目中使用的数据库配置：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;development&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&quot;database&quot;</span>: <span class="string">&quot;egg-sequelize-doc-default&quot;</span>,</span><br><span class="line">    <span class="string">&quot;host&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dialect&quot;</span>: <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line">    <span class="string">&quot;operatorsAliases&quot;</span>: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>创建数据库<br><code>npx sequelize db:create</code></li>
</ol>
<hr>
<h4 id="创建数据迁移表"><a href="#创建数据迁移表" class="headerlink" title="创建数据迁移表"></a>创建数据迁移表</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx sequelize migration:generate --name=init-users</span><br></pre></td></tr></table></figure>

<p>1.执行完命令后，会在database / migrations / 目录下生成数据表迁移文件，然后定义</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="attr">up</span>: <span class="keyword">async</span> (queryInterface, Sequelize) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; INTEGER, STRING, DATE, ENUM &#125; = Sequelize;</span><br><span class="line">        <span class="comment">// 创建表</span></span><br><span class="line">        <span class="keyword">await</span> queryInterface.createTable(<span class="string">&#x27;users&#x27;</span>, &#123;</span><br><span class="line">            <span class="attr">id</span>: &#123; <span class="attr">type</span>: INTEGER(<span class="number">20</span>).UNSIGNED, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">            <span class="attr">username</span>: &#123; <span class="attr">type</span>: STRING(<span class="number">30</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">comment</span>: <span class="string">&#x27;用户名称&#x27;</span>, <span class="attr">unique</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">            <span class="attr">email</span>: &#123; <span class="attr">type</span>: STRING(<span class="number">160</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>,  <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">comment</span>: <span class="string">&#x27;用户邮箱&#x27;</span>, <span class="attr">unique</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">            <span class="attr">password</span>: &#123; <span class="attr">type</span>: STRING(<span class="number">200</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">            <span class="attr">avatarUrl</span>: &#123; <span class="attr">type</span>: STRING(<span class="number">200</span>), <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">            <span class="attr">mobile</span>: &#123; <span class="attr">type</span>: STRING(<span class="number">20</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">comment</span>: <span class="string">&#x27;用户手机&#x27;</span>, <span class="attr">unique</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">            <span class="attr">prifix</span>: &#123; <span class="attr">type</span>: STRING(<span class="number">32</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">            <span class="attr">abstract</span>: &#123; <span class="attr">type</span>: STRING(<span class="number">255</span>), <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">            <span class="attr">gender</span>: &#123; <span class="attr">type</span>: ENUM, <span class="attr">values</span>: [<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;保密&#x27;</span>], <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;男&#x27;</span>, <span class="attr">comment</span>: <span class="string">&#x27;用户性别&#x27;</span>&#125;,</span><br><span class="line">            <span class="attr">createdAt</span>: DATE,</span><br><span class="line">            <span class="attr">updatedAt</span>: DATE</span><br><span class="line">        &#125;, &#123; <span class="attr">engine</span>: <span class="string">&#x27;MYISAM&#x27;</span> &#125;);</span><br><span class="line">        <span class="comment">// 添加索引</span></span><br><span class="line">        queryInterface.addIndex(<span class="string">&#x27;users&#x27;</span>, [<span class="string">&#x27;gender&#x27;</span>])</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">down</span>: <span class="keyword">async</span> queryInterface =&gt; &#123;</span><br><span class="line">        <span class="keyword">await</span> queryInterface.dropTable(<span class="string">&#x27;users&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="创建数据模型"><a href="#创建数据模型" class="headerlink" title="创建数据模型"></a>创建数据模型</h4><p>app / model / user.js<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/206752/24/4037/85477/615fd0a7E6848c542/d24db78678726981.png" alt="image.png"></p>
<blockquote>
<p>引入日期处理类库 Moment.js<br>npm install moment –save</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> moment =  <span class="built_in">require</span>(<span class="string">&#x27;moment&#x27;</span>)</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; STRING, INTEGER, DATE &#125; = app.Sequelize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> User = app.model.define(<span class="string">&#x27;users&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">id</span>: &#123; <span class="attr">type</span>: INTEGER(<span class="number">20</span>).UNSIGNED, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">        <span class="attr">username</span>: &#123; <span class="attr">type</span>: STRING(<span class="number">30</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">comment</span>: <span class="string">&#x27;用户名称&#x27;</span>, <span class="attr">unique</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">        <span class="attr">email</span>: &#123; <span class="attr">type</span>: STRING(<span class="number">160</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>,  <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">comment</span>: <span class="string">&#x27;用户邮箱&#x27;</span>, <span class="attr">unique</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">        <span class="attr">password</span>: &#123; <span class="attr">type</span>: STRING(<span class="number">200</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">        <span class="attr">avatarUrl</span>: &#123; <span class="attr">type</span>: STRING(<span class="number">200</span>), <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">        <span class="attr">mobile</span>: &#123; <span class="attr">type</span>: STRING(<span class="number">20</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">comment</span>: <span class="string">&#x27;用户手机&#x27;</span>, <span class="attr">unique</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">        <span class="attr">prifix</span>: &#123; <span class="attr">type</span>: STRING(<span class="number">32</span>), <span class="attr">allowNull</span>: <span class="literal">false</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">        <span class="attr">abstract</span>: &#123; <span class="attr">type</span>: STRING(<span class="number">255</span>), <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;&#x27;</span> &#125;,</span><br><span class="line">        <span class="attr">gender</span>: &#123; <span class="attr">type</span>: ENUM, <span class="attr">values</span>: [<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;保密&#x27;</span>], <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;男&#x27;</span>, <span class="attr">comment</span>: <span class="string">&#x27;用户性别&#x27;</span>&#125;,</span><br><span class="line">        <span class="attr">createdAt</span>: &#123;<span class="attr">type</span>: DATE, <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;<span class="keyword">return</span> moment(<span class="built_in">this</span>.getDataValue(<span class="string">&#x27;createdAt&#x27;</span>)).format(<span class="string">&#x27;YYYY-MM-DD HH:mm:ss&#x27;</span>)&#125;&#125;,</span><br><span class="line">        <span class="attr">updatedAt</span>: &#123;<span class="attr">type</span>: DATE, <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;<span class="keyword">return</span>  moment(<span class="built_in">this</span>.getDataValue(<span class="string">&#x27;updatedAt&#x27;</span>)).format(<span class="string">&#x27;YYYY-MM-DD HH:mm:ss&#x27;</span>)&#125;&#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> User;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="sequelize数据类型"><a href="#sequelize数据类型" class="headerlink" title="sequelize数据类型"></a>sequelize数据类型</h3><h4 id="sequelize-数据类型"><a href="#sequelize-数据类型" class="headerlink" title="sequelize 数据类型"></a>sequelize 数据类型</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">Sequelize.INTEGER.UNSIGNED              <span class="comment">// INTEGER UNSIGNED</span></span><br><span class="line">Sequelize.INTEGER(<span class="number">11</span>).UNSIGNED          <span class="comment">// INTEGER(11) UNSIGNED</span></span><br><span class="line">Sequelize.INTEGER(<span class="number">11</span>).ZEROFILL          <span class="comment">// INTEGER(11) ZEROFILL</span></span><br><span class="line">Sequelize.INTEGER(<span class="number">11</span>).ZEROFILL.UNSIGNED <span class="comment">// INTEGER(11) UNSIGNED ZEROFILL</span></span><br><span class="line">Sequelize.INTEGER(<span class="number">11</span>).UNSIGNED.ZEROFILL <span class="comment">// INTEGER(11) UNSIGNED ZEROFILL</span></span><br><span class="line"></span><br><span class="line">Sequelize.STRING                      <span class="comment">// VARCHAR(255)</span></span><br><span class="line">Sequelize.STRING(<span class="number">1234</span>)                <span class="comment">// VARCHAR(1234)</span></span><br><span class="line">Sequelize.STRING.BINARY               <span class="comment">// VARCHAR BINARY</span></span><br><span class="line">Sequelize.TEXT                        <span class="comment">// TEXT</span></span><br><span class="line">Sequelize.TEXT(<span class="string">&#x27;tiny&#x27;</span>)                <span class="comment">// TINYTEXT</span></span><br><span class="line">Sequelize.CITEXT                      <span class="comment">// CITEXT      仅 PostgreSQL 和 SQLite.</span></span><br><span class="line"></span><br><span class="line">Sequelize.INTEGER                     <span class="comment">// INTEGER</span></span><br><span class="line">Sequelize.BIGINT                      <span class="comment">// BIGINT</span></span><br><span class="line">Sequelize.BIGINT(<span class="number">11</span>)                  <span class="comment">// BIGINT(11)</span></span><br><span class="line"></span><br><span class="line">Sequelize.FLOAT                       <span class="comment">// FLOAT</span></span><br><span class="line">Sequelize.FLOAT(<span class="number">11</span>)                   <span class="comment">// FLOAT(11)</span></span><br><span class="line">Sequelize.FLOAT(<span class="number">11</span>, <span class="number">10</span>)               <span class="comment">// FLOAT(11,10)</span></span><br><span class="line"></span><br><span class="line">Sequelize.REAL                        <span class="comment">// REAL        仅 PostgreSQL.</span></span><br><span class="line">Sequelize.REAL(<span class="number">11</span>)                    <span class="comment">// REAL(11)    仅 PostgreSQL.</span></span><br><span class="line">Sequelize.REAL(<span class="number">11</span>, <span class="number">12</span>)                <span class="comment">// REAL(11,12) 仅 PostgreSQL.</span></span><br><span class="line"></span><br><span class="line">Sequelize.DOUBLE                      <span class="comment">// DOUBLE</span></span><br><span class="line">Sequelize.DOUBLE(<span class="number">11</span>)                  <span class="comment">// DOUBLE(11)</span></span><br><span class="line">Sequelize.DOUBLE(<span class="number">11</span>, <span class="number">10</span>)              <span class="comment">// DOUBLE(11,10)</span></span><br><span class="line"></span><br><span class="line">Sequelize.DECIMAL                     <span class="comment">// DECIMAL</span></span><br><span class="line">Sequelize.DECIMAL(<span class="number">10</span>, <span class="number">2</span>)              <span class="comment">// DECIMAL(10,2)</span></span><br><span class="line"></span><br><span class="line">Sequelize.DATE                        <span class="comment">// mysql / sqlite 为 DATETIME, postgres 为带时区的 TIMESTAMP</span></span><br><span class="line">Sequelize.DATE(<span class="number">6</span>)                     <span class="comment">// DATETIME(6) 适用 mysql 5.6.4+. 小数秒支持最多6位精度</span></span><br><span class="line">Sequelize.DATEONLY                    <span class="comment">// DATE 不带时间.</span></span><br><span class="line">Sequelize.BOOLEAN                     <span class="comment">// TINYINT(1)</span></span><br><span class="line"></span><br><span class="line">Sequelize.ENUM(<span class="string">&#x27;value 1&#x27;</span>, <span class="string">&#x27;value 2&#x27;</span>)  <span class="comment">// 一个允许值为&#x27;value 1&#x27;和&#x27;value 2&#x27;的ENUM</span></span><br><span class="line">Sequelize.ARRAY(Sequelize.TEXT)       <span class="comment">// 定义一个数组. 仅 PostgreSQL.</span></span><br><span class="line">Sequelize.ARRAY(Sequelize.ENUM)       <span class="comment">// 定义一个ENUM数组. 仅 PostgreSQL.</span></span><br><span class="line"></span><br><span class="line">Sequelize.JSON                        <span class="comment">// JSON 列. 仅 PostgreSQL, SQLite 和 MySQL.</span></span><br><span class="line">Sequelize.JSONB                       <span class="comment">// JSONB 列. 仅 PostgreSQL.</span></span><br><span class="line"></span><br><span class="line">Sequelize.BLOB                        <span class="comment">// BLOB (PostgreSQL 为 bytea)</span></span><br><span class="line">Sequelize.BLOB(<span class="string">&#x27;tiny&#x27;</span>)                <span class="comment">// TINYBLOB (PostgreSQL 为 bytea. 其余参数是 medium 和 long)</span></span><br><span class="line"></span><br><span class="line">Sequelize.UUID                        <span class="comment">// PostgreSQL 和 SQLite 的 UUID 数据类型,MySQL 的 CHAR(36) BINARY(使用defaultValue:Sequelize.UUIDV1 或 Sequelize.UUIDV4 来让 sequelize 自动生成 id).</span></span><br><span class="line"></span><br><span class="line">Sequelize.CIDR                        <span class="comment">// PostgreSQL 的 CIDR 数据类型</span></span><br><span class="line">Sequelize.INET                        <span class="comment">// PostgreSQL 的 INET 数据类型</span></span><br><span class="line">Sequelize.MACADDR                     <span class="comment">// PostgreSQL 的 MACADDR 数据类型</span></span><br><span class="line"></span><br><span class="line">Sequelize.RANGE(Sequelize.INTEGER)    <span class="comment">// 定义 int4range 范围. 仅 PostgreSQL.</span></span><br><span class="line">Sequelize.RANGE(Sequelize.BIGINT)     <span class="comment">// 定义 int8range 范围. 仅 PostgreSQL.</span></span><br><span class="line">Sequelize.RANGE(Sequelize.DATE)       <span class="comment">// 定义 tstzrange 范围. 仅 PostgreSQL.</span></span><br><span class="line">Sequelize.RANGE(Sequelize.DATEONLY)   <span class="comment">// 定义 daterange 范围. 仅 PostgreSQL.</span></span><br><span class="line">Sequelize.RANGE(Sequelize.DECIMAL)    <span class="comment">// 定义 numrange 范围. 仅 PostgreSQL.</span></span><br><span class="line"></span><br><span class="line">Sequelize.ARRAY(Sequelize.RANGE(Sequelize.DATE)) <span class="comment">// 定义 tstzrange 范围的数组. 仅 PostgreSQL.</span></span><br><span class="line"></span><br><span class="line">Sequelize.GEOMETRY                    <span class="comment">// Spatial 列. 仅 PostgreSQL (带有 PostGIS) 或 MySQL.</span></span><br><span class="line">Sequelize.GEOMETRY(<span class="string">&#x27;POINT&#x27;</span>)           <span class="comment">// 带有 geometry 类型的 spatial 列. 仅 PostgreSQL (带有 PostGIS) 或 MySQL.</span></span><br><span class="line">Sequelize.GEOMETRY(<span class="string">&#x27;POINT&#x27;</span>, <span class="number">4326</span>)     <span class="comment">// 具有 geometry 类型和 SRID 的 spatial 列. 仅 PostgreSQL (带有 PostGIS) 或 MySQL.</span></span><br></pre></td></tr></table></figure>



<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><h4 id="sequelize-数据库配置"><a href="#sequelize-数据库配置" class="headerlink" title="sequelize 数据库配置"></a>sequelize 数据库配置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">class Bar extends Model &#123;&#125;</span><br><span class="line">Bar.init(&#123; /* bla */ &#125;, &#123;</span><br><span class="line">  // 模型的名称. 该模型将以此名称存储在`sequelize.models`中.</span><br><span class="line">  // 在这种情况下,默认为类名,即Bar. </span><br><span class="line">  // 这将控制自动生成的foreignKey和关联命名的名称</span><br><span class="line">  modelName: &#x27;bar&#x27;,</span><br><span class="line">  // 不添加时间戳属性 (updatedAt, createdAt)</span><br><span class="line">  timestamps: false,</span><br><span class="line"></span><br><span class="line">  // 不删除数据库条目,但将新添加的属性deletedAt设置为当前日期(删除完成时). </span><br><span class="line">  // paranoid 只有在启用时间戳时才能工作</span><br><span class="line">  paranoid: true,</span><br><span class="line"></span><br><span class="line">  // 将自动设置所有属性的字段参数为下划线命名方式.</span><br><span class="line">  // 不会覆盖已经定义的字段选项</span><br><span class="line">  underscored: true,</span><br><span class="line"></span><br><span class="line">  // 禁用修改表名; 默认情况下,sequelize将自动将所有传递的模型名称(define的第一个参数)转换为复数. 如果你不想这样,请设置以下内容</span><br><span class="line">  freezeTableName: true,</span><br><span class="line"></span><br><span class="line">  // 定义表的名称</span><br><span class="line">  tableName: &#x27;my_very_custom_table_name&#x27;,</span><br><span class="line"></span><br><span class="line">  // 启用乐观锁定. 启用时,sequelize将向模型添加版本计数属性,</span><br><span class="line">  // 并在保存过时的实例时引发OptimisticLockingError错误.</span><br><span class="line">  // 设置为true或具有要用于启用的属性名称的字符串.</span><br><span class="line">    version: true,</span><br><span class="line"></span><br><span class="line">  // Sequelize 实例</span><br><span class="line">  sequelize,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>如果你希望sequelize处理时间戳,但只想要其中一部分,或者希望你的时间戳被称为别的东西,则可以单独覆盖每个列:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">class Foo extends Model &#123;&#125;</span><br><span class="line">Foo.init(&#123; /* bla */ &#125;, &#123;</span><br><span class="line">  // 不要忘记启用时间戳！</span><br><span class="line">  timestamps: true,</span><br><span class="line"></span><br><span class="line">  // 我不想要 createdAt</span><br><span class="line">  createdAt: false,</span><br><span class="line"></span><br><span class="line">  // 我想 updateAt 实际上被称为 updateTimestamp</span><br><span class="line">  updatedAt: &#x27;updateTimestamp&#x27;,</span><br><span class="line"></span><br><span class="line">  // 并且希望 deletedA t被称为 destroyTime(请记住启用paranoid以使其工作)</span><br><span class="line">  deletedAt: &#x27;destroyTime&#x27;,</span><br><span class="line">  paranoid: true,</span><br><span class="line"></span><br><span class="line">  sequelize,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>你也可以更改数据库引擎,例如 变更到到MyISAM, 默认值是InnoDB.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;&#125;</span><br><span class="line">Person.init(&#123; <span class="comment">/* attributes */</span> &#125;, &#123;</span><br><span class="line">  <span class="attr">engine</span>: <span class="string">&#x27;MYISAM&#x27;</span>,</span><br><span class="line">  sequelize</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或全局的</span></span><br><span class="line"><span class="keyword">const</span> sequelize = <span class="keyword">new</span> Sequelize(db, user, pw, &#123;</span><br><span class="line">  <span class="attr">define</span>: &#123; <span class="attr">engine</span>: <span class="string">&#x27;MYISAM&#x27;</span> &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>最后,你可以为MySQL和PG中的表指定注释</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;&#125;</span><br><span class="line">Person.init(&#123; <span class="comment">/* attributes */</span> &#125;, &#123;</span><br><span class="line">  <span class="attr">comment</span>: <span class="string">&quot;我是一个表注释!&quot;</span>,</span><br><span class="line">  sequelize</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h4><p>Sequelize支持在<code>Model.sync()</code>或<code>sequelize.sync</code>中创建的模型定义中添加索引.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;&#125;</span><br><span class="line">User.init(&#123;&#125;, &#123;</span><br><span class="line">  <span class="attr">indexes</span>: [</span><br><span class="line">    <span class="comment">// 在 email 上创建一个唯一索引</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">unique</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">fields</span>: [<span class="string">&#x27;email&#x27;</span>]</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在使用 jsonb_path_ops 的 operator 数据上创建一个 gin 索引</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">fields</span>: [<span class="string">&#x27;data&#x27;</span>],</span><br><span class="line">      <span class="attr">using</span>: <span class="string">&#x27;gin&#x27;</span>,</span><br><span class="line">      <span class="attr">operator</span>: <span class="string">&#x27;jsonb_path_ops&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认的索引名将是 [table]_[fields]</span></span><br><span class="line">    <span class="comment">// 创建多列局部索引</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;public_by_author&#x27;</span>,</span><br><span class="line">      <span class="attr">fields</span>: [<span class="string">&#x27;author&#x27;</span>, <span class="string">&#x27;status&#x27;</span>],</span><br><span class="line">      <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">status</span>: <span class="string">&#x27;public&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 具有有序字段的BTREE索引</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;title_index&#x27;</span>,</span><br><span class="line">      <span class="attr">method</span>: <span class="string">&#x27;BTREE&#x27;</span>,</span><br><span class="line">      <span class="attr">fields</span>: [<span class="string">&#x27;author&#x27;</span>, &#123;<span class="attr">attribute</span>: <span class="string">&#x27;title&#x27;</span>, <span class="attr">collate</span>: <span class="string">&#x27;en_US&#x27;</span>, <span class="attr">order</span>: <span class="string">&#x27;DESC&#x27;</span>, <span class="attr">length</span>: <span class="number">5</span>&#125;]</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  sequelize</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="连接配置"><a href="#连接配置" class="headerlink" title="连接配置"></a>连接配置</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">config.sequelize = &#123;</span><br><span class="line">    <span class="comment">// 数据库类型</span></span><br><span class="line">    <span class="attr">dialect</span>:  <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">    <span class="comment">// 主机</span></span><br><span class="line">    <span class="attr">host</span>:  <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="comment">// 数据库密码</span></span><br><span class="line">    <span class="attr">password</span>:  <span class="string">&#x27;admin888&#x27;</span>,</span><br><span class="line">    <span class="comment">// 端口</span></span><br><span class="line">    <span class="attr">port</span>:  <span class="number">3306</span>,</span><br><span class="line">    <span class="comment">// 数据库</span></span><br><span class="line">    <span class="attr">database</span>:  <span class="string">&#x27;weibo&#x27;</span>,</span><br><span class="line">    <span class="comment">// 中国时区</span></span><br><span class="line">    <span class="attr">timezone</span>:  <span class="string">&#x27;+08:00&#x27;</span>,</span><br><span class="line">    <span class="comment">// 个性化配置</span></span><br><span class="line">    <span class="attr">define</span>: &#123;</span><br><span class="line">        <span class="comment">// 取消数据表名复数</span></span><br><span class="line">        <span class="attr">freezeTableName</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 自动写入时间戳 created_at updated_at</span></span><br><span class="line">        <span class="attr">timestamps</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// 字段生成软删除时间戳 deleted_at</span></span><br><span class="line">        <span class="attr">paranoid</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">createdAt</span>: <span class="string">&#x27;created_at&#x27;</span>,</span><br><span class="line">        <span class="attr">updatedAt</span>: <span class="string">&#x27;updated_at&#x27;</span>,</span><br><span class="line">        <span class="attr">deletedAt</span>: <span class="string">&#x27;deleted_at&#x27;</span>,</span><br><span class="line">        <span class="comment">// 所有驼峰命名格式化</span></span><br><span class="line">        <span class="attr">underscored</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="新增"><a href="#新增" class="headerlink" title="新增"></a>新增</h3><h4 id="sequelize-新增一条数据"><a href="#sequelize-新增一条数据" class="headerlink" title="sequelize 新增一条数据"></a>sequelize 新增一条数据</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model.create( &#123;&#125; )</span><br></pre></td></tr></table></figure>

<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><h4 id="条件查询"><a href="#条件查询" class="headerlink" title="条件查询"></a>条件查询</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">const Op = Sequelize.Op</span><br><span class="line"></span><br><span class="line">[Op.and]: &#123;a: 5&#125;           // 且 (a = 5)</span><br><span class="line">[Op.or]: [&#123;a: 5&#125;, &#123;a: 6&#125;]  // (a = 5 或 a = 6)</span><br><span class="line">[Op.gt]: 6,                // id &gt; 6</span><br><span class="line">[Op.gte]: 6,               // id &gt;= 6</span><br><span class="line">[Op.lt]: 10,               // id &lt; 10</span><br><span class="line">[Op.lte]: 10,              // id &lt;= 10</span><br><span class="line">[Op.ne]: 20,               // id != 20</span><br><span class="line">[Op.eq]: 3,                // = 3</span><br><span class="line">[Op.not]: true,            // 不是 TRUE</span><br><span class="line">[Op.between]: [6, 10],     // 在 6 和 10 之间</span><br><span class="line">[Op.notBetween]: [11, 15], // 不在 11 和 15 之间</span><br><span class="line">[Op.in]: [1, 2],           // 在 [1, 2] 之中</span><br><span class="line">[Op.notIn]: [1, 2],        // 不在 [1, 2] 之中</span><br><span class="line">[Op.like]: &#x27;%hat&#x27;,         // 包含 &#x27;%hat&#x27;</span><br><span class="line">[Op.notLike]: &#x27;%hat&#x27;       // 不包含 &#x27;%hat&#x27;</span><br><span class="line">[Op.iLike]: &#x27;%hat&#x27;         // 包含 &#x27;%hat&#x27; (不区分大小写)  (仅限 PG)</span><br><span class="line">[Op.notILike]: &#x27;%hat&#x27;      // 不包含 &#x27;%hat&#x27;  (仅限 PG)</span><br><span class="line">[Op.startsWith]: &#x27;hat&#x27;     // 类似 &#x27;hat%&#x27;</span><br><span class="line">[Op.endsWith]: &#x27;hat&#x27;       // 类似 &#x27;%hat&#x27;</span><br><span class="line">[Op.substring]: &#x27;hat&#x27;      // 类似 &#x27;%hat%&#x27;</span><br><span class="line">[Op.regexp]: &#x27;^[h|a|t]&#x27;    // 匹配正则表达式/~ &#x27;^[h|a|t]&#x27; (仅限 MySQL/PG)</span><br><span class="line">[Op.notRegexp]: &#x27;^[h|a|t]&#x27; // 不匹配正则表达式/!~ &#x27;^[h|a|t]&#x27; (仅限 MySQL/PG)</span><br><span class="line">[Op.iRegexp]: &#x27;^[h|a|t]&#x27;    // ~* &#x27;^[h|a|t]&#x27; (仅限 PG)</span><br><span class="line">[Op.notIRegexp]: &#x27;^[h|a|t]&#x27; // !~* &#x27;^[h|a|t]&#x27; (仅限 PG)</span><br><span class="line">[Op.like]: &#123; [Op.any]: [&#x27;cat&#x27;, &#x27;hat&#x27;]&#125; // 包含任何数组[&#x27;cat&#x27;, &#x27;hat&#x27;] - 同样适用于 iLike 和 notLike</span><br><span class="line">[Op.overlap]: [1, 2]       // &amp;&amp; [1, 2] (PG数组重叠运算符)</span><br><span class="line">[Op.contains]: [1, 2]      // @&gt; [1, 2] (PG数组包含运算符)</span><br><span class="line">[Op.contained]: [1, 2]     // &lt;@ [1, 2] (PG数组包含于运算符)</span><br><span class="line">[Op.any]: [2,3]            // 任何数组[2, 3]::INTEGER (仅限PG)</span><br><span class="line"></span><br><span class="line">[Op.col]: &#x27;user.organization_id&#x27; // = &#x27;user&#x27;.&#x27;organization_id&#x27;, 使用数据库语言特定的列标识符, 本例使用 PG</span><br></pre></td></tr></table></figure>

<p>数据表结构</p>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">name</th>
<th align="left">age</th>
<th align="left">sex</th>
<th align="left">address</th>
<th align="left">math</th>
<th align="left">english</th>
</tr>
</thead>
<tbody><tr>
<td align="left">张三</td>
<td align="left">23</td>
<td align="left">男</td>
<td align="left">18</td>
<td align="left">云南</td>
<td align="left">60</td>
<td align="left">40</td>
</tr>
<tr>
<td align="left">李四</td>
<td align="left">23</td>
<td align="left">女</td>
<td align="left">22</td>
<td align="left">贵州</td>
<td align="left">20</td>
<td align="left">30</td>
</tr>
<tr>
<td align="left">王麻子</td>
<td align="left">23</td>
<td align="left">男</td>
<td align="left">30</td>
<td align="left">玉溪</td>
<td align="left">30</td>
<td align="left">26</td>
</tr>
<tr>
<td align="left">赵六</td>
<td align="left">23</td>
<td align="left">女</td>
<td align="left">26</td>
<td align="left">德州</td>
<td align="left">80</td>
<td align="left">38</td>
</tr>
<tr>
<td align="left">刘能</td>
<td align="left">23</td>
<td align="left">女</td>
<td align="left">19</td>
<td align="left">西凉</td>
<td align="left">100</td>
<td align="left">48</td>
</tr>
<tr>
<td align="left">段鱼</td>
<td align="left">23</td>
<td align="left">男</td>
<td align="left">28</td>
<td align="left">广州</td>
<td align="left">60</td>
<td align="left">52</td>
</tr>
<tr>
<td align="left">琳娜</td>
<td align="left">23</td>
<td align="left">男</td>
<td align="left">34</td>
<td align="left">泰国</td>
<td align="left">40</td>
<td align="left">46</td>
</tr>
<tr>
<td align="left">贝利</td>
<td align="left">23</td>
<td align="left">男</td>
<td align="left">42</td>
<td align="left">美国</td>
<td align="left">50</td>
<td align="left">69</td>
</tr>
<tr>
<td align="left">皮特</td>
<td align="left">23</td>
<td align="left">女</td>
<td align="left">50</td>
<td align="left">英国</td>
<td align="left">38</td>
<td align="left">70</td>
</tr>
<tr>
<td align="left">汤姆</td>
<td align="left">23</td>
<td align="left">男</td>
<td align="left">46</td>
<td align="left">缅甸</td>
<td align="left">42</td>
<td align="left">65</td>
</tr>
</tbody></table>
<hr>
<ul>
<li>查询年龄 &gt; 20 的学生</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">model.findAll(&#123;</span><br><span class="line">    <span class="attr">attributes</span>: [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>],</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="comment">// age &gt; 20</span></span><br><span class="line">        <span class="attr">age</span>: &#123;</span><br><span class="line">            [Op.gt]:<span class="number">20</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li>查询年龄 &gt; 20 &amp;&amp; &lt; 30 的学生</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">model.findAll(&#123;</span><br><span class="line">    <span class="attr">attributes</span>: [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>],</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">age</span>: &#123;</span><br><span class="line">            [Op.and]: &#123;</span><br><span class="line">                [Op.gt]:<span class="number">20</span>,</span><br><span class="line">                [Op.lt]:<span class="number">30</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="string">`student`</span>.<span class="string">`age`</span> &gt; <span class="number">20</span> AND <span class="string">`student`</span>.<span class="string">`age`</span> &lt; <span class="number">30</span></span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li>查询年龄 in 28 26 52</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">model.findAll(&#123;</span><br><span class="line">    <span class="attr">attributes</span>: [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>],</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">age</span>: &#123;</span><br><span class="line">            [Op.in]: [<span class="number">26</span>,<span class="number">28</span>,<span class="number">52</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="string">`student`</span>.<span class="string">`age`</span> IN (<span class="number">26</span>, <span class="number">28</span>, <span class="number">52</span>)</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li>查询英语成绩为null的</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">model.findAll(&#123;</span><br><span class="line">    <span class="attr">attributes</span>:[<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;english&#x27;</span>],</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">english</span>: &#123;</span><br><span class="line">            [Op.is]:<span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="string">`student`</span>.<span class="string">`english`</span> IS NULL</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li>查询英语成绩 IS NOT NULL 不为空</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Student.findAll(&#123;</span><br><span class="line">    <span class="attr">attributes</span>:[<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;english&#x27;</span>],</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">english</span>: &#123;</span><br><span class="line">            [Op.not]:<span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="string">`student`</span>.<span class="string">`english`</span> IS NOT NULL</span><br></pre></td></tr></table></figure>



<h4 id="模糊查询"><a href="#模糊查询" class="headerlink" title="模糊查询"></a>模糊查询</h4><ul>
<li>查询包含马的学生</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询姓名包含马的学生</span></span><br><span class="line"><span class="keyword">const</span> &#123; field = <span class="string">&#x27;&#x27;</span> &#125; = ctx.query</span><br><span class="line"><span class="keyword">const</span> fields = field.split(<span class="string">&#x27;;&#x27;</span>).filter(<span class="function"><span class="params">f</span> =&gt;</span> f)</span><br><span class="line">Student.findAll(&#123;</span><br><span class="line">    <span class="attr">attributes</span>: fields.length === <span class="number">0</span> ? <span class="string">&#x27;&#x27;</span> : fields,</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: &#123;</span><br><span class="line">            [Op.like]:<span class="string">&#x27;%马%&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="string">`student`</span>.<span class="string">`name`</span> LIKE <span class="string">&#x27;%马%&#x27;</span></span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li>查询姓名<strong>第二个字</strong>为中的学生</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; field = <span class="string">&#x27;&#x27;</span> &#125; = ctx.query</span><br><span class="line"><span class="keyword">const</span> fields = field.split(<span class="string">&#x27;;&#x27;</span>).filter(<span class="function"><span class="params">f</span> =&gt;</span> f)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询名字第二字包含中的学生</span></span><br><span class="line"><span class="keyword">const</span> ret = <span class="keyword">await</span> Student.findAll(&#123;</span><br><span class="line">    <span class="attr">attributes</span>: fields.length === <span class="number">0</span> ? <span class="string">&#x27;&#x27;</span> : fields,</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: &#123;</span><br><span class="line">            [Op.like]:<span class="string">&#x27;_中%&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="string">`student`</span>.<span class="string">`name`</span> LIKE <span class="string">&#x27;_中%&#x27;</span></span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li>查询姓名三个字的学生</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; field = <span class="string">&#x27;&#x27;</span> &#125; = ctx.query</span><br><span class="line"><span class="keyword">const</span> fields = field.split(<span class="string">&#x27;;&#x27;</span>).filter(<span class="function"><span class="params">f</span> =&gt;</span> f)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询姓名为3个字符的学生</span></span><br><span class="line"><span class="keyword">const</span> ret = <span class="keyword">await</span> Student.findAll(&#123;</span><br><span class="line">    <span class="attr">attributes</span>: fields.length === <span class="number">0</span> ? <span class="string">&#x27;&#x27;</span> : fields,</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">name</span>: &#123;</span><br><span class="line">            [Op.like]:<span class="string">&#x27;___&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="string">`student`</span>.<span class="string">`name`</span> LIKE <span class="string">&#x27;___&#x27;</span></span><br></pre></td></tr></table></figure>



<h4 id="排序查询"><a href="#排序查询" class="headerlink" title="排序查询"></a>排序查询</h4><h5 id="数学成绩从高到低排序"><a href="#数学成绩从高到低排序" class="headerlink" title="数学成绩从高到低排序"></a>数学成绩从高到低排序</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; field = <span class="string">&#x27;&#x27;</span> &#125; = ctx.query</span><br><span class="line"><span class="keyword">const</span> fields = ctx.helper.filterFields(field)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数学成绩从高到低排序</span></span><br><span class="line"><span class="keyword">const</span> ret = <span class="keyword">await</span> Student.findAll(&#123;</span><br><span class="line">    <span class="attr">attributes</span>: fields,</span><br><span class="line">    <span class="attr">order</span>: [</span><br><span class="line">        [<span class="string">&#x27;math&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>]</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line">ORDER BY <span class="string">`student`</span>.<span class="string">`math`</span> DESC;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="按照数学成绩排序，如果数学成绩一样，才按照英语成绩倒序排序"><a href="#按照数学成绩排序，如果数学成绩一样，才按照英语成绩倒序排序" class="headerlink" title="按照数学成绩排序，如果数学成绩一样，才按照英语成绩倒序排序"></a>按照数学成绩排序，如果数学成绩一样，才按照英语成绩倒序排序</h5><blockquote>
<p>注意！！！ 存在多排序条件时，首先满足第一排序条件，才会执行第二排序条件</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; field = <span class="string">&#x27;&#x27;</span> &#125; = ctx.query</span><br><span class="line"><span class="keyword">const</span> fields = ctx.helper.filterFields(field)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 按照数学成绩排序，如果数学成绩一样，才按照英语成绩倒序排序</span></span><br><span class="line"><span class="keyword">const</span> ret = <span class="keyword">await</span> Student.findAll(&#123;</span><br><span class="line">    <span class="attr">attributes</span>: fields,</span><br><span class="line">    <span class="attr">order</span>: [</span><br><span class="line">        [<span class="string">&#x27;math&#x27;</span>, <span class="string">&#x27;ASC&#x27;</span>],</span><br><span class="line">        [<span class="string">&#x27;english&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>]</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line">ORDER BY <span class="string">`student`</span>.<span class="string">`math`</span> ASC, <span class="string">`student`</span>.<span class="string">`english`</span> DESC;</span><br></pre></td></tr></table></figure>



<h4 id="聚合查询"><a href="#聚合查询" class="headerlink" title="聚合查询"></a>聚合查询</h4><blockquote>
<p>注意！！！ 使用聚合功能时,必须给它一个别名,以便能够从模型中访问它<br>聚合函数的计算，都是排除了 null 值，所以COUNT( id ) 一般推荐用非空的主键来计算</p>
</blockquote>
<h5 id="COUNT-计算数量"><a href="#COUNT-计算数量" class="headerlink" title="COUNT 计算数量"></a>COUNT 计算数量</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; Sequelize &#125; = app;</span><br><span class="line"><span class="comment">// 查询班级总人数，按照姓名聚合</span></span><br><span class="line"><span class="keyword">const</span> ret = <span class="keyword">await</span> Student.findAll(&#123;</span><br><span class="line">    <span class="attr">attributes</span>: [</span><br><span class="line">        <span class="comment">// col 列名称，&#x27;别名&#x27;</span></span><br><span class="line">        [Sequelize.fn(<span class="string">&#x27;COUNT&#x27;</span>, Sequelize.col(<span class="string">&#x27;name&#x27;</span>)), <span class="string">&#x27;no_name&#x27;</span>]</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br><span class="line">SELECT COUNT(<span class="string">`name`</span>) <span class="keyword">from</span> Student</span><br><span class="line"></span><br><span class="line">[&#123;<span class="string">&quot;no_name&quot;</span>:<span class="number">12</span>&#125;]</span><br></pre></td></tr></table></figure>

<h5 id="MAX-计算最大值"><a href="#MAX-计算最大值" class="headerlink" title="MAX 计算最大值"></a>MAX 计算最大值</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; Sequelize &#125; = app;</span><br><span class="line"><span class="comment">// 查询所有学生英语成绩最高分</span></span><br><span class="line"><span class="keyword">const</span> ret = <span class="keyword">await</span> Student.findAll(&#123;</span><br><span class="line">    <span class="attr">attributes</span>:[[Sequelize.fn(<span class="string">&#x27;MAX&#x27;</span>,Sequelize.col(<span class="string">&#x27;english&#x27;</span>)), <span class="string">&#x27;english_max&#x27;</span>]]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="MIN-计算最小值"><a href="#MIN-计算最小值" class="headerlink" title="MIN 计算最小值"></a>MIN 计算最小值</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询所有学生英语成绩最低分</span></span><br><span class="line"><span class="keyword">const</span> ret = <span class="keyword">await</span> Student.findAll(&#123;</span><br><span class="line">    <span class="attr">attributes</span>:[[Sequelize.fn(<span class="string">&#x27;MIN&#x27;</span>,Sequelize.col(<span class="string">&#x27;english&#x27;</span>)), <span class="string">&#x27;english_min&#x27;</span>]]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="SUN-求和"><a href="#SUN-求和" class="headerlink" title="SUN 求和"></a>SUN 求和</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; Sequelize &#125; = app;</span><br><span class="line"><span class="comment">// 查询所有学生英语成绩的总和</span></span><br><span class="line"><span class="keyword">const</span> ret = <span class="keyword">await</span> Student.findAll(&#123;</span><br><span class="line">    <span class="attr">attributes</span>:[[Sequelize.fn(<span class="string">&#x27;SUM&#x27;</span>,Sequelize.col(<span class="string">&#x27;english&#x27;</span>)), <span class="string">&#x27;english_sum&#x27;</span>]]</span><br><span class="line">&#125;)</span><br><span class="line">SELECT SUM(<span class="string">`english`</span>)  FROM ...</span><br></pre></td></tr></table></figure>

<h5 id="AVG-平均值"><a href="#AVG-平均值" class="headerlink" title="AVG 平均值"></a>AVG 平均值</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; Sequelize &#125; = app;</span><br><span class="line"><span class="comment">// 查询所有学生英语成绩的平均分</span></span><br><span class="line"><span class="keyword">const</span> ret = <span class="keyword">await</span> Student.findAll(&#123;</span><br><span class="line">    <span class="attr">attributes</span>:[[Sequelize.fn(<span class="string">&#x27;AVG&#x27;</span>,Sequelize.col(<span class="string">&#x27;english&#x27;</span>)), <span class="string">&#x27;english_avg&#x27;</span>]]</span><br><span class="line">&#125;)</span><br><span class="line">SELECT AVG(<span class="string">`english`</span>) FROM ...</span><br></pre></td></tr></table></figure>



<h4 id="分组查询"><a href="#分组查询" class="headerlink" title="分组查询"></a>分组查询</h4><h5 id="GROUP-分组查询"><a href="#GROUP-分组查询" class="headerlink" title="GROUP 分组查询"></a>GROUP 分组查询</h5><blockquote>
<p>分组查询，顾名思义就是按照组区分开，进行查询，比如按照性别分组<br>注意！！！ group by 后面分组的字段不能随便加，比如 group by ‘sex’ 那么，查询字段必须为 sex</p>
</blockquote>
<p>按照性别分组查询全部数学成绩的平均分</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; Sequelize &#125; = app;</span><br><span class="line"><span class="comment">// 按照性别分组查询全班数学成绩的平均分</span></span><br><span class="line"><span class="keyword">const</span> ret = <span class="keyword">await</span> Student.findAll(&#123;</span><br><span class="line">    <span class="comment">// 查询字段要和分组字段一致！！！！</span></span><br><span class="line">    <span class="attr">attributes</span>:[<span class="string">&#x27;sex&#x27;</span>, [ Sequelize.fn(<span class="string">&#x27;AVG&#x27;</span>, Sequelize.col(<span class="string">&#x27;math&#x27;</span>)), <span class="string">&#x27;math_avg&#x27;</span> ] ],</span><br><span class="line">    <span class="comment">// 分组字段</span></span><br><span class="line">    <span class="attr">group</span>: [<span class="string">&#x27;sex&#x27;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">SELECT <span class="string">`sex`</span>, AVG(<span class="string">`math`</span>)  FROM <span class="string">`student`</span>   GROUP BY <span class="string">`sex`</span>;</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;sex&quot;</span>: <span class="string">&quot;女&quot;</span>,</span><br><span class="line">        <span class="string">&quot;math_avg&quot;</span>: <span class="string">&quot;85.4286&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;sex&quot;</span>: <span class="string">&quot;男&quot;</span>,</span><br><span class="line">        <span class="string">&quot;math_avg&quot;</span>: <span class="string">&quot;78.0000&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<hr>
<p>按照性别分组，分别查询全班同学数学成绩平均分和总人数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 按照性别分组，分别查询全班同学数学成绩平均分和总人数</span></span><br><span class="line"><span class="keyword">const</span> ret = <span class="keyword">await</span> Student.findAll( &#123;</span><br><span class="line">    <span class="attr">attributes</span>:[</span><br><span class="line">        <span class="string">&#x27;sex&#x27;</span>,</span><br><span class="line">        [Sequelize.fn(<span class="string">&#x27;AVG&#x27;</span>, Sequelize.col(<span class="string">&#x27;math&#x27;</span>)), <span class="string">&#x27;match_avg&#x27;</span>],</span><br><span class="line">        [Sequelize.fn(<span class="string">&#x27;COUNT&#x27;</span>, Sequelize.col(<span class="string">&#x27;id&#x27;</span>)), <span class="string">&#x27;total_student&#x27;</span>]</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">group</span>: [<span class="string">&#x27;sex&#x27;</span>]</span><br><span class="line">&#125; )</span><br><span class="line"></span><br><span class="line">SELECT <span class="string">`sex`</span>, AVG(<span class="string">`math`</span>) , COUNT(<span class="string">`id`</span>)  FROM <span class="string">`student`</span> GROUP BY <span class="string">`sex`</span>;</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;sex&quot;</span>: <span class="string">&quot;女&quot;</span>,</span><br><span class="line">        <span class="string">&quot;match_avg&quot;</span>: <span class="string">&quot;85.4286&quot;</span>,</span><br><span class="line">        <span class="string">&quot;total_student&quot;</span>: <span class="number">7</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;sex&quot;</span>: <span class="string">&quot;男&quot;</span>,</span><br><span class="line">        <span class="string">&quot;match_avg&quot;</span>: <span class="string">&quot;78.0000&quot;</span>,</span><br><span class="line">        <span class="string">&quot;total_student&quot;</span>: <span class="number">5</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<hr>
<p>按照地区分组，分别统计每个地区数学成绩平均分 和 总人数，分数低于70分的同学不参与分组</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 按照地区分组，分别统计每个地区数学成绩平均分 和 总人数，分数低于70分的同学不参与分组</span></span><br><span class="line"><span class="keyword">const</span> ret = <span class="keyword">await</span> Student.findAll( &#123;</span><br><span class="line">    <span class="attr">attributes</span>:[</span><br><span class="line">        <span class="string">&#x27;address&#x27;</span>,</span><br><span class="line">        [ Sequelize.fn(<span class="string">&#x27;AVG&#x27;</span>, Sequelize.col(<span class="string">&#x27;math&#x27;</span>)), <span class="string">&#x27;math_avg&#x27;</span> ],</span><br><span class="line">        [ Sequelize.fn(<span class="string">&#x27;COUNT&#x27;</span>, Sequelize.col(<span class="string">&#x27;id&#x27;</span>)), <span class="string">&#x27;total_student&#x27;</span> ]</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">math</span>: &#123;</span><br><span class="line">            [Op.gt]:<span class="number">70</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">group</span>: [<span class="string">&#x27;address&#x27;</span>]</span><br><span class="line">&#125; )</span><br><span class="line"></span><br><span class="line">SELECT <span class="string">`address`</span>, AVG(<span class="string">`math`</span>) , COUNT(<span class="string">`id`</span>)  FROM <span class="string">`student`</span> WHERE  <span class="string">`math`</span> &gt; <span class="number">70</span> GROUP BY <span class="string">`address`</span>;</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;四川&quot;</span>,</span><br><span class="line">        <span class="string">&quot;math_avg&quot;</span>: <span class="string">&quot;84.0000&quot;</span>,</span><br><span class="line">        <span class="string">&quot;total_student&quot;</span>: <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;昆明&quot;</span>,</span><br><span class="line">        <span class="string">&quot;math_avg&quot;</span>: <span class="string">&quot;90.0000&quot;</span>,</span><br><span class="line">        <span class="string">&quot;total_student&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;潭州&quot;</span>,</span><br><span class="line">        <span class="string">&quot;math_avg&quot;</span>: <span class="string">&quot;92.0000&quot;</span>,</span><br><span class="line">        <span class="string">&quot;total_student&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;西凉&quot;</span>,</span><br><span class="line">        <span class="string">&quot;math_avg&quot;</span>: <span class="string">&quot;82.0000&quot;</span>,</span><br><span class="line">        <span class="string">&quot;total_student&quot;</span>: <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;贵州&quot;</span>,</span><br><span class="line">        <span class="string">&quot;math_avg&quot;</span>: <span class="string">&quot;86.2500&quot;</span>,</span><br><span class="line">        <span class="string">&quot;total_student&quot;</span>: <span class="number">4</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<hr>
<p>按照地区分组，分别统计每个地区学生的数学平均分，分数低于70分的同学不参与分组，并且参与分组的人数不能少于2人</p>
<blockquote>
<p>注意！！！where 和 having 的区别？<br>where 在分组之前进行限定，如果不满足条件，则不参与分组<br>having 在分组之后进行限定，如果不满足结果，则不会被查询出来<br>where 后不可以带上聚合函数判断，having 后可以带上聚合函数进行判断</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> Student.findAll( &#123;</span><br><span class="line">    <span class="attr">attributes</span>:[</span><br><span class="line">        <span class="string">&#x27;address&#x27;</span>,</span><br><span class="line">        [Sequelize.fn(<span class="string">&#x27;AVG&#x27;</span>, Sequelize.col(<span class="string">&#x27;math&#x27;</span>)), <span class="string">&#x27;math&#x27;</span>],</span><br><span class="line">        [Sequelize.fn(<span class="string">&#x27;COUNT&#x27;</span>, Sequelize.col(<span class="string">&#x27;id&#x27;</span>)), <span class="string">&#x27;total&#x27;</span>]</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">where</span>: &#123;</span><br><span class="line">        <span class="attr">math</span>: &#123;</span><br><span class="line">            [Op.gt]:<span class="number">70</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">group</span>: <span class="string">&#x27;address&#x27;</span>,</span><br><span class="line">    <span class="attr">having</span>: &#123;</span><br><span class="line">        <span class="attr">total</span>:&#123;</span><br><span class="line">            [Op.gt]:<span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">SELECT <span class="string">`address`</span>, AVG(<span class="string">`math`</span>),COUNT(<span class="string">`id`</span>) <span class="keyword">as</span> total FROM <span class="string">`student`</span> </span><br><span class="line">    WHERE <span class="string">`student`</span> &gt; <span class="number">70</span> </span><br><span class="line">    GROUP BY <span class="string">`address`</span> </span><br><span class="line">    HAVING <span class="string">`total`</span> &gt; <span class="number">2</span>;</span><br></pre></td></tr></table></figure>



<h4 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h4><h5 id="limt-分页查询"><a href="#limt-分页查询" class="headerlink" title="limt 分页查询"></a>limt 分页查询</h5><p>查询前3条记录</p>
<p>分页公式：<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/197016/14/11916/74577/615fd2a8E11a29f37/17e79d037c080963.png" alt="image.png"><br><code>(offset - 1) * limit</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT name  FROM <span class="string">`student`</span>  LIMIT <span class="number">0</span>, <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">Student.findAll( &#123;</span><br><span class="line">    <span class="attr">attributes</span>:[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">    <span class="comment">// 当前页</span></span><br><span class="line">    <span class="attr">offset</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="comment">// 每页显示的条数</span></span><br><span class="line">    <span class="attr">limit</span>:<span class="number">3</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<hr>
<p>分页案例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">router.get(<span class="string">&#x27;/getUserList&#x27;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> &#123; currentPage=<span class="number">1</span>, count=<span class="number">10</span> &#125; = ctx.request.header;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> userList = <span class="keyword">await</span> models.user.findAllAndCount(&#123;</span><br><span class="line">        <span class="attr">limit</span>: <span class="built_in">parseInt</span>( count ),</span><br><span class="line">        <span class="attr">offset</span>:(currentPage - <span class="number">1</span>) * count,</span><br><span class="line">        <span class="attr">include</span>: [&#123;</span><br><span class="line">            <span class="attr">model</span>: &#123; explore &#125;,</span><br><span class="line">            <span class="attr">as</span>: <span class="string">&#x27;order_info&#x27;</span></span><br><span class="line">        &#125;],</span><br><span class="line">        <span class="attr">distinct</span>: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> result = &#123;&#125;;</span><br><span class="line">        result.data = res.rows;</span><br><span class="line">        result.totalCount = res.count;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    ctx.body = userList;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h3 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="title">update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="built_in">this</span>.ctx;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="number">106</span>;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> ctx.model.User.findByPk(id);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      ctx.status = <span class="number">404</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> user.update(&#123; <span class="attr">name</span>:<span class="string">&quot;李四&quot;</span>, <span class="attr">age</span>:<span class="number">43</span> &#125;);</span><br><span class="line">    ctx.body = user;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">wait User.update(&#123; <span class="attr">lastName</span>: <span class="string">&quot;Doe&quot;</span> &#125;, &#123;</span><br><span class="line">  <span class="attr">where</span>: &#123;</span><br><span class="line">    <span class="attr">lastName</span>: <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>删除数据</p>
<p>force 设置为true 时，不进行物理删除，只是软删除<br><code>model.destroy( &#123; where:&#123; id:this.ctx.params.id &#125;&#125;, &#123; force: true &#125; )</code><br>恢复所有软删除数据<br><code>model.restore()</code><br>恢复指定ID数据<br><code>model.restore( &#123; where: &#123; id: 2 &#125; &#125; )</code></p>
<h3 id="获取器"><a href="#获取器" class="headerlink" title="获取器"></a>获取器</h3><p>get() 获取器，查询数据时触发</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> moment =  <span class="built_in">require</span>(<span class="string">&#x27;moment&#x27;</span>)</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; STRING, INTEGER, DATE &#125; = app.Sequelize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> User = app.model.define(<span class="string">&#x27;users&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">id</span>: &#123; <span class="attr">type</span>: INTEGER(<span class="number">20</span>).UNSIGNED, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">        <span class="attr">gender</span>: &#123; <span class="attr">type</span>: ENUM, <span class="attr">values</span>: [<span class="string">&#x27;男&#x27;</span>,<span class="string">&#x27;女&#x27;</span>,<span class="string">&#x27;保密&#x27;</span>], <span class="attr">allowNull</span>: <span class="literal">true</span>, <span class="attr">defaultValue</span>: <span class="string">&#x27;男&#x27;</span>, <span class="attr">comment</span>: <span class="string">&#x27;用户性别&#x27;</span>&#125;,</span><br><span class="line">        <span class="comment">// 查询数据时，格式化时间</span></span><br><span class="line">        <span class="attr">createdAt</span>: &#123;<span class="attr">type</span>: DATE, <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;<span class="keyword">return</span> moment(<span class="built_in">this</span>.getDataValue(<span class="string">&#x27;createdAt&#x27;</span>)).format(<span class="string">&#x27;YYYY-MM-DD HH:mm:ss&#x27;</span>)&#125;&#125;,</span><br><span class="line">        <span class="attr">updatedAt</span>: &#123;<span class="attr">type</span>: DATE, <span class="function"><span class="title">get</span>(<span class="params"></span>)</span> &#123;<span class="keyword">return</span>  moment(<span class="built_in">this</span>.getDataValue(<span class="string">&#x27;updatedAt&#x27;</span>)).format(<span class="string">&#x27;YYYY-MM-DD HH:mm:ss&#x27;</span>)&#125;&#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> User;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="修改器"><a href="#修改器" class="headerlink" title="修改器"></a>修改器</h3><p>set() 新增数据时触发</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> moment =  <span class="built_in">require</span>(<span class="string">&#x27;moment&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&#x27;bcryptjs&#x27;</span>)</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; STRING, INTEGER, DATE &#125; = app.Sequelize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> User = app.model.define(<span class="string">&#x27;user&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">id</span>: &#123; <span class="attr">type</span>: INTEGER(<span class="number">20</span>).UNSIGNED, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">        <span class="attr">nickname</span>: &#123; <span class="attr">type</span>: STRING&#125;,</span><br><span class="line">        <span class="attr">password</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: STRING,</span><br><span class="line">            <span class="comment">// 密码自动加盐</span></span><br><span class="line">            <span class="function"><span class="title">set</span>(<span class="params">val</span>)</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> salt = bcrypt.genSaltSync(<span class="number">10</span>)</span><br><span class="line">                <span class="keyword">const</span> pwd = bcrypt.hashSync(val, salt)</span><br><span class="line">                <span class="comment">// 传入2个参数，第一个是字段名称，第二个是加密字符串</span></span><br><span class="line">                <span class="built_in">this</span>.setDataValue(<span class="string">&#x27;password&#x27;</span>,pwd)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">email</span>: &#123; <span class="attr">type</span>: STRING&#125;,</span><br><span class="line">        <span class="attr">openid</span>: &#123; <span class="attr">type</span>: STRING&#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> User;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="静态属性"><a href="#静态属性" class="headerlink" title="静态属性"></a>静态属性</h3><p>模型静态属性</p>
<ul>
<li>model 定义一个模型</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; STRING, INTEGER, DATE &#125; = app.Sequelize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> Post = app.model.define(<span class="string">&#x27;post&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">id</span>: &#123;</span><br><span class="line">            <span class="attr">type</span>: INTEGER,</span><br><span class="line">            <span class="attr">primaryKey</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">autoIncrement</span>: <span class="literal">true</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">title</span>: STRING(<span class="number">30</span>),</span><br><span class="line">        <span class="attr">content</span>: STRING(<span class="number">255</span>),</span><br><span class="line">        <span class="attr">user_id</span>: INTEGER,</span><br><span class="line">        <span class="attr">created_at</span>: DATE,</span><br><span class="line">        <span class="attr">updated_at</span>: DATE,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 模型实例添加关联</span></span><br><span class="line">    Post.associate = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        app.model.Post.belongsTo(app.model.User, &#123; <span class="attr">as</span>: <span class="string">&#x27;user&#x27;</span>, <span class="attr">foreignKey</span>: <span class="string">&#x27;user_id&#x27;</span> &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 模型实例添加静态方法</span></span><br><span class="line">    Post.findByIdWithUser = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">id, userId</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="built_in">this</span>.findOne(&#123;</span><br><span class="line">            <span class="attr">where</span>: &#123; id, <span class="attr">user_id</span>: userId &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Post;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="title">update</span>(<span class="params">&#123; id, user_id, updates &#125;</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> post = <span class="keyword">await</span> <span class="built_in">this</span>.ctx.model.Post.findByIdWithUser(id, user_id);</span><br><span class="line">    <span class="keyword">if</span> (!post) <span class="built_in">this</span>.ctx.throw(<span class="number">404</span>, <span class="string">&#x27;post not found&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> post.update(updates);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="title">find</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> post = <span class="keyword">await</span> <span class="built_in">this</span>.ctx.model.Post.findByPk(id, &#123;</span><br><span class="line">        <span class="attr">include</span>: [&#123;</span><br><span class="line">            <span class="attr">model</span>: <span class="built_in">this</span>.ctx.model.User,</span><br><span class="line">            <span class="attr">as</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">            <span class="attr">attributes</span>: [ <span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span> ],</span><br><span class="line">        &#125;],</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (!post) &#123;</span><br><span class="line">        <span class="built_in">this</span>.ctx.throw(<span class="number">404</span>, <span class="string">&#x27;post not found&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> post;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="字段验证"><a href="#字段验证" class="headerlink" title="字段验证"></a>字段验证</h3><p>数据库字段约束</p>
<p>模型验证允许你为模型的每个属性指定格式/内容/继承验证.<br>验证会自动运行在<code>create</code>,<code>update</code>和<code>save</code>上. 你也可以调用<code>validate()</code>手动验证一个实例.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValidateMe</span> <span class="keyword">extends</span> <span class="title">Model</span> </span>&#123;&#125;</span><br><span class="line">ValidateMe.init(&#123;</span><br><span class="line">    <span class="attr">bar</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: Sequelize.STRING,</span><br><span class="line">        <span class="attr">validate</span>: &#123;</span><br><span class="line">            <span class="attr">is</span>: [<span class="string">&quot;^[a-z]+$&quot;</span>,<span class="string">&#x27;i&#x27;</span>],     <span class="comment">// 只允许字母</span></span><br><span class="line">            <span class="attr">is</span>: <span class="regexp">/^[a-z]+$/i</span>,          <span class="comment">// 与上一个示例相同,使用了真正的正则表达式</span></span><br><span class="line">            not: [<span class="string">&quot;[a-z]&quot;</span>,<span class="string">&#x27;i&#x27;</span>],       <span class="comment">// 不允许字母</span></span><br><span class="line">            <span class="attr">isEmail</span>: <span class="literal">true</span>,            <span class="comment">// 检查邮件格式 (foo@bar.com)</span></span><br><span class="line">            <span class="attr">isUrl</span>: <span class="literal">true</span>,              <span class="comment">// 检查连接格式 (http://foo.com)</span></span><br><span class="line">            <span class="attr">isIP</span>: <span class="literal">true</span>,               <span class="comment">// 检查 IPv4 (129.89.23.1) 或 IPv6 格式</span></span><br><span class="line">            <span class="attr">isIPv4</span>: <span class="literal">true</span>,             <span class="comment">// 检查 IPv4 (129.89.23.1) 格式</span></span><br><span class="line">            <span class="attr">isIPv6</span>: <span class="literal">true</span>,             <span class="comment">// 检查 IPv6 格式</span></span><br><span class="line">            <span class="attr">isAlpha</span>: <span class="literal">true</span>,            <span class="comment">// 只允许字母</span></span><br><span class="line">            <span class="attr">isAlphanumeric</span>: <span class="literal">true</span>,     <span class="comment">// 只允许使用字母数字</span></span><br><span class="line">            <span class="attr">isNumeric</span>: <span class="literal">true</span>,          <span class="comment">// 只允许数字</span></span><br><span class="line">            <span class="attr">isInt</span>: <span class="literal">true</span>,              <span class="comment">// 检查是否为有效整数</span></span><br><span class="line">            <span class="attr">isFloat</span>: <span class="literal">true</span>,            <span class="comment">// 检查是否为有效浮点数</span></span><br><span class="line">            <span class="attr">isDecimal</span>: <span class="literal">true</span>,          <span class="comment">// 检查是否为任意数字</span></span><br><span class="line">            <span class="attr">isLowercase</span>: <span class="literal">true</span>,        <span class="comment">// 检查是否为小写</span></span><br><span class="line">            <span class="attr">isUppercase</span>: <span class="literal">true</span>,        <span class="comment">// 检查是否为大写</span></span><br><span class="line">            <span class="attr">notNull</span>: <span class="literal">true</span>,            <span class="comment">// 不允许为空</span></span><br><span class="line">            <span class="attr">isNull</span>: <span class="literal">true</span>,             <span class="comment">// 只允许为空</span></span><br><span class="line">            <span class="attr">notEmpty</span>: <span class="literal">true</span>,           <span class="comment">// 不允许空字符串</span></span><br><span class="line">            <span class="attr">equals</span>: <span class="string">&#x27;specific value&#x27;</span>, <span class="comment">// 只允许一个特定值</span></span><br><span class="line">            <span class="attr">contains</span>: <span class="string">&#x27;foo&#x27;</span>,          <span class="comment">// 检查是否包含特定的子字符串</span></span><br><span class="line">            <span class="attr">notIn</span>: [[<span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;bar&#x27;</span>]],  <span class="comment">// 检查是否值不是其中之一</span></span><br><span class="line">            <span class="attr">isIn</span>: [[<span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;bar&#x27;</span>]],   <span class="comment">// 检查是否值是其中之一</span></span><br><span class="line">            <span class="attr">notContains</span>: <span class="string">&#x27;bar&#x27;</span>,       <span class="comment">// 不允许包含特定的子字符串</span></span><br><span class="line">            <span class="attr">len</span>: [<span class="number">2</span>,<span class="number">10</span>],              <span class="comment">// 只允许长度在2到10之间的值</span></span><br><span class="line">            <span class="attr">isUUID</span>: <span class="number">4</span>,                <span class="comment">// 只允许uuids</span></span><br><span class="line">            <span class="attr">isDate</span>: <span class="literal">true</span>,             <span class="comment">// 只允许日期字符串</span></span><br><span class="line">            <span class="attr">isAfter</span>: <span class="string">&quot;2011-11-05&quot;</span>,    <span class="comment">// 只允许在特定日期之后的日期字符串</span></span><br><span class="line">            <span class="attr">isBefore</span>: <span class="string">&quot;2011-11-05&quot;</span>,   <span class="comment">// 只允许在特定日期之前的日期字符串</span></span><br><span class="line">            <span class="attr">max</span>: <span class="number">23</span>,                  <span class="comment">// 只允许值 &lt;= 23</span></span><br><span class="line">            <span class="attr">min</span>: <span class="number">23</span>,                  <span class="comment">// 只允许值 &gt;= 23</span></span><br><span class="line">            <span class="attr">isCreditCard</span>: <span class="literal">true</span>,       <span class="comment">// 检查有效的信用卡号码</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 自定义验证器的示例:</span></span><br><span class="line">            <span class="function"><span class="title">isEven</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">parseInt</span>(value) % <span class="number">2</span> !== <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Only even values are allowed!&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">isGreaterThanOtherField</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">parseInt</span>(value) &lt;= <span class="built_in">parseInt</span>(<span class="built_in">this</span>.otherField)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;Bar must be greater than otherField.&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, &#123; sequelize &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Student = app.model.define(<span class="string">&#x27;student&#x27;</span>,&#123;</span><br><span class="line">    <span class="attr">id</span>: &#123; <span class="attr">type</span>: INTEGER, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    <span class="attr">name</span>: &#123; <span class="attr">type</span>: STRING, <span class="attr">allowNull</span>: <span class="literal">false</span> &#125;,</span><br><span class="line">    <span class="attr">age</span>: &#123;</span><br><span class="line">        <span class="attr">type</span>: INTEGER,</span><br><span class="line">        <span class="attr">allowNull</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">validate</span>: &#123;</span><br><span class="line">            <span class="attr">isEmail</span>: &#123;</span><br><span class="line">                <span class="attr">args</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">msg</span>: <span class="string">&#x27;不是邮箱类型&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>

<h3 id="外键约束"><a href="#外键约束" class="headerlink" title="外键约束"></a>外键约束</h3><p>主表：部门表<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/203333/15/9895/4190/615fd512E3130bc82/707220bcbde9945c.png" alt="image.png"><br>从表：员工表<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/204888/28/9965/4416/615fd52dE98229b16/f8ffa4011eeadfd1.png" alt="image.png"><br>添加外键：从表 dep_id 关联 主表 id</p>
<blockquote>
<p>CASCADE<br>级联更新 主表数据更新从表会更新外键<br>级联删除 主表数据删除，从表会一起删除<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/204225/3/10138/6453/615fd545E30a17745/9242a5aede4ac7ec.png" alt="image.png"></p>
</blockquote>
<h3 id="关联模型"><a href="#关联模型" class="headerlink" title="关联模型"></a>关联模型</h3><h4 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h4><p>满足条件：一个人只能对应一个身份证，一个身份证只能对应一个人<br>示例：<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/204161/37/10083/17098/615fde9fE31f4be30/fde296b9f495314a.png" alt="image.png"><br>student 学生表<br>card 身份证表</p>
<blockquote>
<p>一对一可以在任意一个表添加外键<br>注意！！！ 一对一外键需要添加 unique 唯一约束</p>
</blockquote>
<hr>
<p>反向关联</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> moment = <span class="built_in">require</span>(<span class="string">&#x27;moment&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; STRING, INTEGER, DATE &#125; = app.Sequelize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> Flow = app.model.define(<span class="string">&#x27;flow&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">id</span>: &#123; <span class="attr">type</span>: INTEGER.UNSIGNED, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">        <span class="attr">status</span>: &#123; <span class="attr">type</span>: INTEGER&#125;,</span><br><span class="line">        <span class="attr">index</span>: &#123; <span class="attr">type</span>: INTEGER &#125;,</span><br><span class="line">        <span class="attr">type</span>: &#123; <span class="attr">type</span>: INTEGER &#125;,</span><br><span class="line">        <span class="attr">art_id</span>: &#123; <span class="attr">type</span>: INTEGER &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    Flow.associate = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        app.model.Flow.belongsTo(app.model.Movie, &#123; <span class="attr">as</span>: <span class="string">&#x27;movie&#x27;</span>, <span class="attr">foreignKey</span>: <span class="string">&#x27;art_id&#x27;</span>, <span class="attr">targetKey</span>: <span class="string">&#x27;id&#x27;</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取最新期刊</span></span><br><span class="line">    Flow.getNewFlowByIndex = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> flow = <span class="keyword">await</span> <span class="built_in">this</span>.findOne(&#123;</span><br><span class="line">            <span class="comment">// 主表只查询的字段</span></span><br><span class="line">            <span class="attr">attributes</span>: [<span class="string">&#x27;index&#x27;</span>],</span><br><span class="line">            <span class="attr">include</span>: [&#123;</span><br><span class="line">                <span class="attr">model</span>: app.model.Movie,</span><br><span class="line">                <span class="attr">as</span>: <span class="string">&#x27;movie&#x27;</span>,</span><br><span class="line">                <span class="comment">// 副表查询的字段</span></span><br><span class="line">                <span class="attr">attributes</span>: [<span class="string">&#x27;image&#x27;</span>, <span class="string">&#x27;content&#x27;</span>, <span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">            &#125;],</span><br><span class="line">            <span class="attr">order</span>: [</span><br><span class="line">                [<span class="string">&#x27;index&#x27;</span>, <span class="string">&#x27;DESC&#x27;</span>]</span><br><span class="line">            ]</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> flow ? flow.dataValues : <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Flow;</span><br></pre></td></tr></table></figure>



<h4 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h4><p>描述：<br>一对多： 一个部门有很多员工，但一个员工只能从属于一个部门<br>多对一： 多个员工只能属于一个部门</p>
<hr>
<p>示例：<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/92081/36/18938/17670/615fdf71E7f48d61d/70d024de3285817a.png" alt="image.png"><br>department 部门表<br>employee 员工表</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>分类表：<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/201411/20/10482/3174/615fdf95E1471feae/0d6d58b8bb3b0fa9.png" alt="image.png"><br>商品表：<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/208424/28/4107/9331/615fdf9bE8abf5c51/6dacbf9689bda1cf.png" alt="image.png"><br>分类 1——n 商品</p>
<ol>
<li>model 里面建2张模型，分别是category.js goods.js</li>
<li>catrgory.js 模型代码：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;Sequelize&#125; = app</span><br><span class="line">    <span class="keyword">const</span> &#123;STRING,INTEGER&#125; = Sequelize</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> Category = app.model.define(<span class="string">&#x27;category&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">id</span>: &#123; <span class="attr">type</span>: INTEGER, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">        <span class="attr">title</span>: &#123; <span class="attr">type</span>: STRING &#125;</span><br><span class="line">    &#125;, &#123; <span class="attr">timestamps</span>: <span class="literal">false</span> , <span class="attr">paranoid</span>: <span class="literal">false</span>&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分类表关联商品表 1:n</span></span><br><span class="line">    Category.associate = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        app.model.Category.hasMany(app.model.Goods, &#123; <span class="attr">as</span>: <span class="string">&#x27;goods&#x27;</span>, <span class="attr">foreignKey</span>: <span class="string">&#x27;cate_id&#x27;</span>, <span class="attr">targetKey</span>: <span class="string">&#x27;id&#x27;</span>&#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Category;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>goods.js 模型代码：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;Sequelize&#125; = app</span><br><span class="line">    <span class="keyword">const</span> &#123;STRING,INTEGER&#125; = Sequelize</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> Goods = app.model.define(<span class="string">&#x27;goods&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">id</span>: &#123; <span class="attr">type</span>: INTEGER, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">        <span class="attr">title</span>: &#123; <span class="attr">type</span>: STRING &#125;,</span><br><span class="line">        <span class="attr">price</span>: &#123;<span class="attr">type</span>: INTEGER&#125;,</span><br><span class="line">        <span class="attr">cate_id</span>: &#123;<span class="attr">type</span>: INTEGER&#125;</span><br><span class="line">    &#125;, &#123; <span class="attr">timestamps</span>: <span class="literal">false</span> , <span class="attr">paranoid</span>: <span class="literal">false</span>&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 商品表从属分类 n-1</span></span><br><span class="line">    Goods.associate = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        app.model.Goods.belongsTo(app.model.Category, &#123; <span class="attr">as</span>: <span class="string">&#x27;cate&#x27;</span>, <span class="attr">foreignKey</span>: <span class="string">&#x27;cate_id&#x27;</span>, <span class="attr">targetKey</span>: <span class="string">&#x27;id&#x27;</span>&#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Goods;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>controller 查询</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;Op&#125; = <span class="built_in">this</span>.app.Sequelize;</span><br><span class="line"><span class="keyword">const</span> &#123;Sequelize&#125; = <span class="built_in">this</span>.app;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询所有分类下对应的所有商品 分类 1----n 商品</span></span><br><span class="line"><span class="keyword">const</span> cate = <span class="keyword">await</span> <span class="built_in">this</span>.ctx.model.Category.findAll(&#123;</span><br><span class="line">    <span class="attr">include</span>: [&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="built_in">this</span>.ctx.model.Goods,</span><br><span class="line">        <span class="attr">as</span>: <span class="string">&#x27;goods&#x27;</span>,</span><br><span class="line">        <span class="attr">attributes</span>:[[Sequelize.fn(<span class="string">&#x27;COUNT&#x27;</span>, Sequelize.col(<span class="string">&#x27;*&#x27;</span>)), <span class="string">&#x27;total_goods&#x27;</span>]]</span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="attr">attributes</span>: [<span class="string">&#x27;title&#x27;</span>],</span><br><span class="line">    <span class="attr">group</span>: <span class="string">&#x27;title&#x27;</span>,</span><br><span class="line">    <span class="attr">distinct</span>: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询商品所对应的分类 商品 n-----1 分类</span></span><br><span class="line"><span class="keyword">const</span> goods = <span class="keyword">await</span> <span class="built_in">this</span>.ctx.model.Goods.findAll(&#123;</span><br><span class="line">    <span class="attr">include</span>: [&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="built_in">this</span>.ctx.model.Category,</span><br><span class="line">        <span class="attr">as</span>: <span class="string">&#x27;cate&#x27;</span></span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="attr">distinct</span>: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h4 id="左外连接"><a href="#左外连接" class="headerlink" title="左外连接"></a>左外连接</h4><p>LEFT OUTER JOIN 左外连接</p>
<ul>
<li>需求：查询所有分类，如果该分类下没有商品，则不显示该分类</li>
<li>实现：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">    <span class="string">`goods`</span>.<span class="string">`id`</span>, </span><br><span class="line">    <span class="string">`goods`</span>.<span class="string">`title`</span>, </span><br><span class="line">    <span class="string">`goods`</span>.<span class="string">`price`</span>, </span><br><span class="line">    <span class="string">`goods`</span>.<span class="string">`cate_id`</span>, </span><br><span class="line">    <span class="string">`cate`</span>.<span class="string">`id`</span>, </span><br><span class="line">    <span class="string">`cate`</span>, </span><br><span class="line">    <span class="string">`cate.title`</span> </span><br><span class="line">        FROM </span><br><span class="line">            <span class="string">`goods`</span> </span><br><span class="line">        LEFT OUTER JOIN </span><br><span class="line">            <span class="string">`category`</span> AS <span class="string">`cate`</span> </span><br><span class="line">        ON </span><br><span class="line">            <span class="string">`goods`</span>.<span class="string">`cate_id`</span> = <span class="string">`cate`</span>.<span class="string">`id`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cate = <span class="keyword">await</span> <span class="built_in">this</span>.ctx.model.Category.findAll(&#123;</span><br><span class="line">    <span class="attr">include</span>: [&#123;</span><br><span class="line">        <span class="attr">model</span>: <span class="built_in">this</span>.ctx.model.Goods,</span><br><span class="line">        <span class="attr">as</span>: <span class="string">&#x27;goods&#x27;</span>,</span><br><span class="line">        <span class="attr">attributes</span>:[<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;price&#x27;</span>],</span><br><span class="line">        <span class="comment">// 实现 左外连接</span></span><br><span class="line">        <span class="attr">required</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="attr">distinct</span>: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>



<h4 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h4><p>多对多关联模型</p>
<p>满足条件：一个学生可以选择多个课程，一个课程也可以被多个学生选择<br>示例：<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/152513/18/22823/17812/615fe058E53894b7e/56a6d6afa1582e71.png" alt="image.png"><br>student 学生表<br>class 课程表<br>student_has_class 中间表</p>
<blockquote>
<p>多对多，需要借助第三个中间表，中间表包含了2个外键，分别是两个表的主键</p>
</blockquote>
<hr>
<p>我们假设有这样的一个场景，文章(Post)可以有多个标签(Tag),同样，一个Tag也可以对应多个Post，我们需要一张关联表PostTag来记录Post和Tag之间的关系。</p>
<h5 id="一、model-建立3张模型表"><a href="#一、model-建立3张模型表" class="headerlink" title="一、model 建立3张模型表"></a>一、model 建立3张模型表</h5><ul>
<li>tag 表</li>
<li>post 表</li>
<li>post_tag 表</li>
</ul>
<h5 id="二、建立表关系"><a href="#二、建立表关系" class="headerlink" title="二、建立表关系"></a>二、建立表关系</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">文章表</span><br><span class="line">Post.belongsToMany(Tag, &#123;</span><br><span class="line">    through: &#123;</span><br><span class="line">        model: PostTag,</span><br><span class="line">        unique: false,</span><br><span class="line">    &#125;,</span><br><span class="line">    foreignKey: &#x27;postId&#x27;, //通过外键postId</span><br><span class="line">    constraints: false</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">标签表</span><br><span class="line">Tag.belongsToMany(Post, &#123;</span><br><span class="line">    through: &#123;</span><br><span class="line">        model: PostTag,</span><br><span class="line">        unique: false,</span><br><span class="line">    &#125;,</span><br><span class="line">    foreignKey: &#x27;tagId&#x27;, //通过外键tagId</span><br><span class="line">    constraints: false</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>建议关联关系之后，Post会自动添加addTags、getTags、setTags方法。<br>Tag会自动添加addPosts、getPosts、setPosts方法。</p>
</blockquote>
<h5 id="三、添加"><a href="#三、添加" class="headerlink" title="三、添加"></a>三、添加</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">static async create(data) &#123;</span><br><span class="line">      //例如我们tag表有2条数据，[&#123;id:1,name:&#x27;标签1&#x27;&#125;,&#123;id:2,name:&#x27;标签2&#x27;&#125;]</span><br><span class="line">      //传递进来的data = &#123;name:&#x27;文章1&#x27;,tagIds:[1,2]&#125;</span><br><span class="line">        let newPost = await Post.create(&#123;name: data.name&#125;); //返回创建的post对象</span><br><span class="line">        let tags = await Tag.findAll(&#123;where: &#123;id: data[&#x27;tagIds&#x27;]&#125;&#125;)//找到对应的tagId对象</span><br><span class="line">        await newPost.setTags(tags) //通过setTags方法在postTag表添加记录</span><br><span class="line">        return true</span><br><span class="line">        </span><br><span class="line">        //以上操作会给post表创建一条新的记录，&#123;id:1,name:&#x27;文章1&#x27;&#125;</span><br><span class="line">        //给postTag表添加2条记录,[&#123;id:1,postId:1,tagId:1&#125;,&#123;id:2,post:1,tagId:2&#125;]</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://dd-static.jd.com/ddimg/jfs/t1/109109/6/19823/108833/615fe067E7949496c/935c86355f731637.png" alt="image.png"><br><img src="https://dd-static.jd.com/ddimg/jfs/t1/209552/17/4258/64268/615fe06dEee0923f2/126c8173a5a02c9a.png" alt="image.png"></p>
<h5 id="四、关联查询"><a href="#四、关联查询" class="headerlink" title="四、关联查询"></a>四、关联查询</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">async</span> <span class="function"><span class="title">allPost</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> Post.findAll(&#123;</span><br><span class="line">            <span class="attr">include</span>: [</span><br><span class="line">                &#123;<span class="attr">model</span>: Tag, <span class="attr">attributes</span>: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>]&#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询结果</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;code&quot;</span>: <span class="number">200</span>,</span><br><span class="line"><span class="string">&quot;msg&quot;</span>: <span class="string">&quot;查询成功！&quot;</span>,</span><br><span class="line"><span class="string">&quot;data&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;createdAt&quot;</span>: <span class="string">&quot;2018-12-10 13:18:11&quot;</span>,</span><br><span class="line">        <span class="string">&quot;updatedAt&quot;</span>: <span class="string">&quot;2018-12-10 13:18:11&quot;</span>,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;文章1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;tags&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;createdAt&quot;</span>: <span class="string">&quot;2018-12-10 13:21:37&quot;</span>,</span><br><span class="line">                <span class="string">&quot;updatedAt&quot;</span>: <span class="string">&quot;2018-12-10 13:21:37&quot;</span>,</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;标签1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;postTag&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;createdAt&quot;</span>: <span class="string">&quot;2018-12-10 13:18:11&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;updatedAt&quot;</span>: <span class="string">&quot;2018-12-10 13:18:11&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                    <span class="string">&quot;postId&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                    <span class="string">&quot;tagId&quot;</span>: <span class="number">1</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;createdAt&quot;</span>: <span class="string">&quot;2018-12-10 13:21:37&quot;</span>,</span><br><span class="line">                <span class="string">&quot;updatedAt&quot;</span>: <span class="string">&quot;2018-12-10 13:21:37&quot;</span>,</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;标签2&quot;</span>,</span><br><span class="line">                <span class="string">&quot;postTag&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;createdAt&quot;</span>: <span class="string">&quot;2018-12-10 13:18:11&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;updatedAt&quot;</span>: <span class="string">&quot;2018-12-10 13:18:11&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">                    <span class="string">&quot;postId&quot;</span>: <span class="number">1</span>,</span><br><span class="line">                    <span class="string">&quot;tagId&quot;</span>: <span class="number">2</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h5 id="五、更新"><a href="#五、更新" class="headerlink" title="五、更新"></a>五、更新</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">async</span> <span class="function"><span class="title">updatePost</span>(<span class="params">id, data</span>)</span> &#123;</span><br><span class="line">        <span class="comment">//id为需要修改的ID,data = &#123;name:&#x27;修改文章&#x27;,tagIds:[1]&#125;</span></span><br><span class="line">        <span class="keyword">let</span> tags = <span class="keyword">await</span> Tag.findAll(&#123;<span class="attr">where</span>: &#123;<span class="attr">id</span>: data[<span class="string">&#x27;tagIds&#x27;</span>]&#125;&#125;)</span><br><span class="line">        Post.findByPk(id).then(<span class="function"><span class="keyword">function</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">            post.update(&#123;<span class="attr">name</span>: data.name&#125;)</span><br><span class="line">            post.setTags(tags)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="六、事务"><a href="#六、事务" class="headerlink" title="六、事务"></a>六、事务</h5><p>多表更新中，我们总担心那一步出错，导致后期难以维护，这里可以使用transaction事务来处理。一旦那一步出错，自动回滚。我拿创建那一步写个范例。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">async</span> <span class="function"><span class="title">create</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> tags = <span class="keyword">await</span> Tag.findAll(&#123;<span class="attr">where</span>: &#123;<span class="attr">id</span>: data[<span class="string">&#x27;tagIds&#x27;</span>]&#125;&#125;)</span><br><span class="line">        <span class="keyword">return</span> Sequelize.transaction(<span class="function"><span class="keyword">function</span> (<span class="params">t</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Post.create(&#123;<span class="attr">name</span>: data.name&#125;, &#123;<span class="attr">transaction</span>: t&#125;)</span><br><span class="line">                .then(<span class="function"><span class="keyword">function</span> (<span class="params">post</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> post.setTags(tags, &#123;<span class="attr">transaction</span>: t&#125;)</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        &#125;).then(<span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 事务已被提交 result 是 promise 链返回到事务回调的结果</span></span><br><span class="line"></span><br><span class="line">        &#125;).catch(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 事务已被回滚 throw 抛出错误</span></span><br><span class="line">            <span class="keyword">throw</span> err;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h4 id="字段显示隐藏"><a href="#字段显示隐藏" class="headerlink" title="字段显示隐藏"></a>字段显示隐藏</h4><p>排除不显示字段</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Model.findAll(&#123;</span><br><span class="line">  <span class="attr">attributes</span>: &#123; <span class="attr">exclude</span>: [<span class="string">&#x27;baz&#x27;</span>] &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>





<h4 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h4><p>Egg.js中使用sequelize事务</p>
<p>对数据库的操作很多时候需要同时进行几个操作，比如需要同时改动几张表的数据，或者对同一张表中不同行（row）或列（column）做不同操作，比较典型的例子就是用户转账问题（A账户向B账号汇钱）：<br>1 从A账号中把余额读出来。<br>2 对A账号做减法操作。<br>3 把结果写回A账号中。<br>4 从B账号中把余额读出来。<br>5 对B账号做加法操作。<br>6 把结果写回B账号中。<br>为了数据的一致性，这6件事，要么操作全部成功，要么全部失败回滚。这就是事务的一个特性：原子性。关于事务的四大特性（ACID）这里不做深究。<br>项目使用的是 Egg+egg-sequelize 模式，查阅了一下 sequelize 的<a target="_blank" rel="noopener" href="http://sequelize.readthedocs.io/en/v3/docs/transactions/">官方文档</a>，使用方法如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> transaction;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// 开启事务</span></span><br><span class="line">  transaction = <span class="keyword">await</span> <span class="built_in">this</span>.ctx.model.transaction();</span><br><span class="line">  <span class="keyword">await</span> <span class="built_in">this</span>.service.xxx.xxx(parms, transaction);</span><br><span class="line">  <span class="keyword">await</span> <span class="built_in">this</span>.service.xxx.xxx(parms1, parms2, transaction);</span><br><span class="line">  <span class="keyword">await</span> transaction.commit();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="keyword">await</span> transaction.rollback();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="字段自增"><a href="#字段自增" class="headerlink" title="字段自增"></a>字段自增</h4><p>字段自增</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> flow = <span class="keyword">await</span> <span class="built_in">this</span>.ctx.model.Flow.findOne(&#123; <span class="attr">where</span>: &#123; art_id &#125; &#125;);</span><br><span class="line"><span class="keyword">await</span> flow.increment(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">by</span>: <span class="number">900</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>字段自减</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> flow = <span class="keyword">await</span> <span class="built_in">this</span>.ctx.model.Flow.findOne(&#123; <span class="attr">where</span>: &#123; art_id &#125; &#125;);</span><br><span class="line"><span class="keyword">await</span> flow.decrement(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">by</span>: <span class="number">900</span> &#125;);</span><br></pre></td></tr></table></figure>



<h3 id="请求数据验证"><a href="#请求数据验证" class="headerlink" title="请求数据验证"></a>请求数据验证</h3><h4 id="egg-validate"><a href="#egg-validate" class="headerlink" title="egg-validate"></a>egg-validate</h4><p>egg-validate的定制化升级</p>
<ul>
<li>egg-validate 基于 parameter 定制，可以用它所有的规则</li>
<li>文档：<a target="_blank" rel="noopener" href="https://github.com/node-modules/parameter">https://github.com/node-modules/parameter</a><br><img src="https://dd-static.jd.com/ddimg/jfs/t1/205661/22/10103/49539/615fe17cE89c8a408/a87276ba1ca37e7b.png" alt="image.png"></li>
</ul>
<hr>
<p>定制化egg-validate</p>
<ol>
<li>建立 app.js 入口文件</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppBootHook</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">app</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.app = app;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">didLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 引入validate目录，并注入app实例</span></span><br><span class="line">        <span class="keyword">const</span> directory = path.join(<span class="built_in">this</span>.app.config.baseDir, <span class="string">&#x27;app/validate&#x27;</span>);</span><br><span class="line">        app.loader.loadToApp(directory, <span class="string">&#x27;validate&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = AppBootHook;</span><br></pre></td></tr></table></figure>

<ol>
<li>建立自定义规则校验文件<br>app/validate/user.js</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> &#123; validator &#125; = app;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 校验用户名是否正确</span></span><br><span class="line">  validator.addRule(<span class="string">&#x27;userName&#x27;</span>, <span class="function">(<span class="params">rule, value</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(rule);</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/^\d+$/</span>.test(value)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;用户名应该是字符串&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (value.length &lt; <span class="number">3</span> || value.length &gt; <span class="number">10</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&quot;用户名的长度应该在3-10之间&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加自定义参数校验规则</span></span><br><span class="line">  validator.addRule(<span class="string">&#x27;123&#x27;</span>, <span class="function">(<span class="params">rule, value</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (value !== <span class="string">&#x27;123&#x27;</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&#x27;must be 123&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol>
<li>参数校验</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.validate(&#123;<span class="attr">username</span>:&#123;<span class="attr">type</span>:<span class="string">&#x27;userName&#x27;</span>&#125;&#125;, ctx.request.body )</span><br></pre></td></tr></table></figure>



<h4 id="indicative验证器"><a href="#indicative验证器" class="headerlink" title="indicative验证器"></a>indicative验证器</h4><p>indicative 验证器</p>
<ul>
<li>文档：<a target="_blank" rel="noopener" href="https://indicative.adonisjs.com/">https://indicative.adonisjs.com/</a></li>
<li>安装：cnpm i -S indicative</li>
</ul>
<h4 id="egg-validate-plus"><a href="#egg-validate-plus" class="headerlink" title="egg-validate-plus"></a>egg-validate-plus</h4><p><strong>egg-validate-plus 使用</strong></p>
<p>文档：<a target="_blank" rel="noopener" href="https://github.com/temool/egg-validate-plus">https://github.com/temool/egg-validate-plus</a><br><code>rules</code>中规则的编写，参见<a target="_blank" rel="noopener" href="https://github.com/yiminghe/async-validator">async-validator</a>中验证规则的编写</p>
<p><strong>开启插件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// config/plugin.&#123;env&#125;.js</span><br><span class="line">exports.validatePlus = &#123;</span><br><span class="line">  enable: true,</span><br><span class="line">  package: &#x27;egg-validate-plus&#x27;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>配置插件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// config/config.&#123;env&#125;.js</span><br><span class="line">config.validatePlus = &#123;</span><br><span class="line">  resolveError(ctx, errors) &#123;</span><br><span class="line">    if (errors.length) &#123;</span><br><span class="line">      ctx.type = &#x27;json&#x27;;</span><br><span class="line">      ctx.status = 400;</span><br><span class="line">      ctx.body = &#123;</span><br><span class="line">        code: 400,</span><br><span class="line">        error: errors,</span><br><span class="line">        message: &#x27;参数错误&#x27;,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>使用插件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">|- MY-PROJECT</span><br><span class="line">    |- app</span><br><span class="line">        |- controller</span><br><span class="line">            |- user.js</span><br><span class="line">            |- post.js</span><br><span class="line">        |- rules</span><br><span class="line">            |- user</span><br><span class="line">                |- login.js [用户登录参数校验规则]</span><br><span class="line">            |- post</span><br><span class="line">                |- add.js [创建 post 参数校验规则]</span><br><span class="line">    |- config</span><br><span class="line">        |- config.default.js</span><br><span class="line">        |- plugin.js</span><br><span class="line">    |- package.json</span><br><span class="line">    |- README.md</span><br></pre></td></tr></table></figure>

<p><strong>规则的传入方式</strong></p>
<p>1.传入字符串</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/xx.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; query &#125; = <span class="built_in">this</span>.ctx.request;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拿到验证结果</span></span><br><span class="line"><span class="keyword">const</span> validateResult = <span class="keyword">await</span> <span class="built_in">this</span>.ctx.validate(<span class="string">&#x27;user.login&#x27;</span>, query)</span><br><span class="line"><span class="comment">// 验证不通过时，阻止后面的代码执行</span></span><br><span class="line"><span class="keyword">if</span> (!validateResult) <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<p>注意：不要带上 rules</p>
<p>2.直接传入验证规则对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/xx.js</span></span><br><span class="line"><span class="comment">// 直接引入 rules 文件下的验证规则，也可以是自己写的验证规则对象</span></span><br><span class="line"><span class="keyword">const</span> rule = <span class="built_in">this</span>.app.rules.user.login</span><br><span class="line"><span class="comment">// 数据格式</span></span><br><span class="line"><span class="comment">// const rule = &#123;</span></span><br><span class="line"><span class="comment">//   id: [</span></span><br><span class="line"><span class="comment">//     &#123; required: true &#125;,</span></span><br><span class="line"><span class="comment">//     &#123; type: &#x27;number&#x27;, message: &#x27;id 必须为数字 &#125;</span></span><br><span class="line"><span class="comment">//   ],</span></span><br><span class="line"><span class="comment">//   password: [</span></span><br><span class="line"><span class="comment">//     &#123; required: true &#125;,</span></span><br><span class="line"><span class="comment">//     &#123; type: &#x27;string&#x27;, message: &#x27;password 必须为字符串 &#125;</span></span><br><span class="line"><span class="comment">//   ]</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 从客户端传入的参数 </span></span><br><span class="line"><span class="keyword">const</span> &#123; query &#125; = <span class="built_in">this</span>.ctx.request;</span><br><span class="line"><span class="comment">// 数据格式： </span></span><br><span class="line"><span class="comment">// query = &#123;</span></span><br><span class="line"><span class="comment">//   username: 123456,</span></span><br><span class="line"><span class="comment">//   password: &#x27;abcdefg&#x27;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 拿到验证结果</span></span><br><span class="line"><span class="keyword">const</span> validateResult = <span class="keyword">await</span> <span class="built_in">this</span>.ctx.validate(rule, query)</span><br><span class="line"><span class="comment">// 验证不通过时，阻止后面的代码执行</span></span><br><span class="line"><span class="keyword">if</span> (!validateResult) <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<p>添加signIn.js规则</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rule = &#123;</span><br><span class="line">  <span class="attr">email</span>: [</span><br><span class="line">    &#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&#x27;邮箱不能为空&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">&#x27;email&#x27;</span>, <span class="attr">message</span>: <span class="string">&#x27;邮箱格式不正确&#x27;</span> &#125;,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">password</span>: [</span><br><span class="line">    &#123; <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&#x27;密码不能为空&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">type</span>: <span class="string">&#x27;string&#x27;</span>, <span class="attr">message</span>: <span class="string">&#x27;密码字段需要是字符串&#x27;</span> &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// eslint-disable-next-line no-unused-vars</span></span><br><span class="line">      <span class="function"><span class="title">validator</span>(<span class="params">rule, value, callback, source, options</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> pattern = <span class="regexp">/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[^]&#123;8,16&#125;$/</span>;</span><br><span class="line">        <span class="keyword">if</span> (pattern.test(value)) &#123;</span><br><span class="line">          callback(); <span class="comment">// 验证通过</span></span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        callback(&#123; <span class="attr">message</span>: <span class="string">&#x27;密码最少包含一个大小写字母、数字并且为8-16位&#x27;</span> &#125;); <span class="comment">// 验证不通过</span></span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = rule;</span><br></pre></td></tr></table></figure>

<p>controller中login.js使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">&#x27;egg&#x27;</span>).Controller;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">loginIn</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, app &#125; = <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123; email, password &#125; = ctx.request.body;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> validateResult = <span class="keyword">await</span> ctx.validate(<span class="string">&#x27;login.signIn&#x27;</span>, &#123; email, password &#125;); <span class="comment">// 第一个参数对应于rules目录下目录或文件</span></span><br><span class="line">    <span class="keyword">if</span> (!validateResult) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> loginInfo = <span class="keyword">await</span> ctx.service.user.login(&#123; password, email &#125;);</span><br><span class="line">    <span class="comment">// 省略部分代码</span></span><br><span class="line">    ctx.returnBody(<span class="number">200</span>, <span class="string">&#x27;登录成功&#x27;</span>, loginInfo.userId); <span class="comment">// returnBody方法是基于context的扩展</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = LoginController;</span><br></pre></td></tr></table></figure>

<p>context.js扩展</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="function"><span class="title">returnBody</span>(<span class="params">status, message, data = <span class="literal">null</span></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.status = status;</span><br><span class="line">    <span class="built_in">this</span>.body = &#123;</span><br><span class="line">      message,</span><br><span class="line">      data,</span><br><span class="line">      <span class="attr">flag</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="betterValidate"><a href="#betterValidate" class="headerlink" title="betterValidate"></a>betterValidate</h4><h5 id="egg-中使用-BetterValidate"><a href="#egg-中使用-BetterValidate" class="headerlink" title="egg 中使用 BetterValidate"></a>egg 中使用 BetterValidate</h5><blockquote>
<p>BetterValidate 依赖于 validator 插件</p>
</blockquote>
<p>文档：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/validator">https://www.npmjs.com/package/validator</a></p>
<ol>
<li>app.js 构建 validate 目录 并且挂载到ctx</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="title">didLoad</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="comment">// 1.全局异常处理</span></span><br><span class="line">  <span class="keyword">const</span> &#123; HttpExceptions &#125; = <span class="built_in">require</span>(<span class="string">&#x27;./app/exceptions/http_exceptions&#x27;</span>)</span><br><span class="line">  <span class="built_in">global</span>.myErrors = HttpExceptions;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 2. betterValidate 挂载 ctx </span></span><br><span class="line">  <span class="keyword">const</span> validatorsPaths = <span class="built_in">this</span>.app.loader.getLoadUnits().map(<span class="function"><span class="params">unit</span> =&gt;</span> path.join(unit.path, <span class="string">&#x27;app/validators&#x27;</span>));</span><br><span class="line">  <span class="built_in">this</span>.app.loader.loadToContext(validatorsPaths, <span class="string">&#x27;validators&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">call</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">fieldClass</span>: <span class="string">&#x27;validatorsClasses&#x27;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<ol>
<li>建立 2个 BetterValidate 核心类库</li>
</ol>
<ul>
<li>app / cores / utils.js</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> findMembers = <span class="function"><span class="keyword">function</span> (<span class="params">instance, &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    prefix,</span></span></span><br><span class="line"><span class="params"><span class="function">    specifiedType,</span></span></span><br><span class="line"><span class="params"><span class="function">    filter</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 递归函数</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">_find</span>(<span class="params">instance</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//基线条件（跳出递归）</span></span><br><span class="line">        <span class="keyword">if</span> (instance.__proto__ === <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> names = <span class="built_in">Reflect</span>.ownKeys(instance)</span><br><span class="line">        names = names.filter(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 过滤掉不满足条件的属性或方法名</span></span><br><span class="line">            <span class="keyword">return</span> _shouldKeep(name)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [...names, ..._find(instance.__proto__)]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">_shouldKeep</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (filter) &#123;</span><br><span class="line">            <span class="keyword">if</span> (filter(value)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (prefix)</span><br><span class="line">            <span class="keyword">if</span> (value.startsWith(prefix))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">if</span> (specifiedType)</span><br><span class="line">            <span class="keyword">if</span> (instance[value] <span class="keyword">instanceof</span> specifiedType)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _find(instance)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    findMembers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li>app / cores / valitators.js</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> validator = <span class="built_in">require</span>(<span class="string">&#x27;validator&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">    HttpExceptions</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;../exceptions/http_exceptions&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">    get,</span><br><span class="line">    last,</span><br><span class="line">    set,</span><br><span class="line">    cloneDeep</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&quot;lodash&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123;</span><br><span class="line">    findMembers</span><br><span class="line">&#125; = <span class="built_in">require</span>(<span class="string">&#x27;./utils&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BetterValidate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.data = &#123;&#125;</span><br><span class="line">        <span class="built_in">this</span>.parsed = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">_assembleAllParams</span>(<span class="params">ctx</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">body</span>: ctx.request.body,</span><br><span class="line">            <span class="attr">query</span>: ctx.request.query,</span><br><span class="line">            <span class="attr">path</span>: ctx.params,</span><br><span class="line">            <span class="attr">header</span>: ctx.request.header</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params">path, parsed = <span class="literal">true</span></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (parsed) &#123;</span><br><span class="line">            <span class="keyword">const</span> value = get(<span class="built_in">this</span>.parsed, path, <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> keys = path.split(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">                <span class="keyword">const</span> key = last(keys)</span><br><span class="line">                <span class="keyword">return</span> get(<span class="built_in">this</span>.parsed.default, key)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> get(<span class="built_in">this</span>.data, path)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">_findMembersFilter</span>(<span class="params">key</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="regexp">/validate([A-Z])\w+/g</span>.test(key)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>[key] <span class="keyword">instanceof</span> <span class="built_in">Array</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>[key].forEach(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> isRuleType = value <span class="keyword">instanceof</span> Rule</span><br><span class="line">                <span class="keyword">if</span> (!isRuleType) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;验证数组必须全部为Rule类型&#x27;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">validate</span>(<span class="params">ctx, alias = &#123;&#125;</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.alias = alias</span><br><span class="line">        <span class="keyword">let</span> params = <span class="built_in">this</span>._assembleAllParams(ctx)</span><br><span class="line">        <span class="built_in">this</span>.data = cloneDeep(params)</span><br><span class="line">        <span class="built_in">this</span>.parsed = cloneDeep(params)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> memberKeys = findMembers(<span class="built_in">this</span>, &#123;</span><br><span class="line">            <span class="attr">filter</span>: <span class="built_in">this</span>._findMembersFilter.bind(<span class="built_in">this</span>)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> errorMsgs = []</span><br><span class="line">        <span class="comment">// const map = new Map(memberKeys)</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">of</span> memberKeys) &#123;</span><br><span class="line">            <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="built_in">this</span>._check(key, alias)</span><br><span class="line">            <span class="keyword">if</span> (!result.success) &#123;</span><br><span class="line">                errorMsgs.push(result.msg)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (errorMsgs.length != <span class="number">0</span>) &#123;</span><br><span class="line">            </span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> HttpExceptions(errorMsgs)</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.v = <span class="built_in">this</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">_check</span>(<span class="params">key, alias = &#123;&#125;</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> isCustomFunc = <span class="keyword">typeof</span> (<span class="built_in">this</span>[key]) == <span class="string">&#x27;function&#x27;</span> ? <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line">        <span class="keyword">let</span> result;</span><br><span class="line">        <span class="keyword">if</span> (isCustomFunc) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">await</span> <span class="built_in">this</span>[key](<span class="built_in">this</span>.data)</span><br><span class="line">                result = <span class="keyword">new</span> RuleResult(<span class="literal">true</span>)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">                result = <span class="keyword">new</span> RuleResult(<span class="literal">false</span>, error.msg || error.message || <span class="string">&#x27;参数错误&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 函数验证</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 属性验证, 数组，内有一组Rule</span></span><br><span class="line">            <span class="keyword">const</span> rules = <span class="built_in">this</span>[key]</span><br><span class="line">            <span class="keyword">const</span> ruleField = <span class="keyword">new</span> RuleField(rules)</span><br><span class="line">            <span class="comment">// 别名替换</span></span><br><span class="line">            key = alias[key] ? alias[key] : key</span><br><span class="line">            <span class="keyword">const</span> param = <span class="built_in">this</span>._findParam(key)</span><br><span class="line"></span><br><span class="line">            result = ruleField.validate(param.value)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (result.pass) &#123;</span><br><span class="line">                <span class="comment">// 如果参数路径不存在，往往是因为用户传了空值，而又设置了默认值</span></span><br><span class="line">                <span class="keyword">if</span> (param.path.length == <span class="number">0</span>) &#123;</span><br><span class="line">                    set(<span class="built_in">this</span>.parsed, [<span class="string">&#x27;default&#x27;</span>, key], result.legalValue)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    set(<span class="built_in">this</span>.parsed, param.path, result.legalValue)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!result.pass) &#123;</span><br><span class="line">            <span class="keyword">const</span> msg = <span class="string">`<span class="subst">$&#123;isCustomFunc ? <span class="string">&#x27;&#x27;</span> : key&#125;</span><span class="subst">$&#123;result.msg&#125;</span>`</span></span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="attr">msg</span>: msg,</span><br><span class="line">                <span class="attr">success</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">msg</span>: <span class="string">&#x27;ok&#x27;</span>,</span><br><span class="line">            <span class="attr">success</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">_findParam</span>(<span class="params">key</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> value</span><br><span class="line">        value = get(<span class="built_in">this</span>.data, [<span class="string">&#x27;query&#x27;</span>, key])</span><br><span class="line">        <span class="keyword">if</span> (value) &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                value,</span><br><span class="line">                <span class="attr">path</span>: [<span class="string">&#x27;query&#x27;</span>, key]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        value = get(<span class="built_in">this</span>.data, [<span class="string">&#x27;body&#x27;</span>, key])</span><br><span class="line">        <span class="keyword">if</span> (value) &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                value,</span><br><span class="line">                <span class="attr">path</span>: [<span class="string">&#x27;body&#x27;</span>, key]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        value = get(<span class="built_in">this</span>.data, [<span class="string">&#x27;path&#x27;</span>, key])</span><br><span class="line">        <span class="keyword">if</span> (value) &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                value,</span><br><span class="line">                <span class="attr">path</span>: [<span class="string">&#x27;path&#x27;</span>, key]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        value = get(<span class="built_in">this</span>.data, [<span class="string">&#x27;header&#x27;</span>, key])</span><br><span class="line">        <span class="keyword">if</span> (value) &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                value,</span><br><span class="line">                <span class="attr">path</span>: [<span class="string">&#x27;header&#x27;</span>, key]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">value</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">path</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RuleResult</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">pass, msg = <span class="string">&#x27;&#x27;</span></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">Object</span>.assign(<span class="built_in">this</span>, &#123;</span><br><span class="line">            pass,</span><br><span class="line">            msg</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RuleFieldResult</span> <span class="keyword">extends</span> <span class="title">RuleResult</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">pass, msg = <span class="string">&#x27;&#x27;</span>, legalValue = <span class="literal">null</span></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(pass, msg)</span><br><span class="line">        <span class="built_in">this</span>.legalValue = legalValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rule</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">name, msg, ...params</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">Object</span>.assign(<span class="built_in">this</span>, &#123;</span><br><span class="line">            name,</span><br><span class="line">            msg,</span><br><span class="line">            params</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">validate</span>(<span class="params">field</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.name == <span class="string">&#x27;isOptional&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RuleResult(<span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">if</span> (!validator[<span class="built_in">this</span>.name](field + <span class="string">&#x27;&#x27;</span>, ...this.params)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RuleResult(<span class="literal">false</span>, <span class="built_in">this</span>.msg || <span class="built_in">this</span>.message || <span class="string">&#x27;参数错误&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RuleResult(<span class="literal">true</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RuleField</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">rules</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rules = rules</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">validate</span>(<span class="params">field</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (field == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果字段为空</span></span><br><span class="line">            <span class="keyword">const</span> allowEmpty = <span class="built_in">this</span>._allowEmpty()</span><br><span class="line">            <span class="keyword">const</span> defaultValue = <span class="built_in">this</span>._hasDefault()</span><br><span class="line">            <span class="keyword">if</span> (allowEmpty) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> RuleFieldResult(<span class="literal">true</span>, <span class="string">&#x27;&#x27;</span>, defaultValue)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> RuleFieldResult(<span class="literal">false</span>, <span class="string">&#x27;字段是必填参数&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> filedResult = <span class="keyword">new</span> RuleFieldResult(<span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> rule <span class="keyword">of</span> <span class="built_in">this</span>.rules) &#123;</span><br><span class="line">            <span class="keyword">let</span> result = rule.validate(field)</span><br><span class="line">            <span class="keyword">if</span> (!result.pass) &#123;</span><br><span class="line">                filedResult.msg = result.msg</span><br><span class="line">                filedResult.legalValue = <span class="literal">null</span></span><br><span class="line">                <span class="comment">// 一旦一条校验规则不通过，则立即终止这个字段的验证</span></span><br><span class="line">                <span class="keyword">return</span> filedResult</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RuleFieldResult(<span class="literal">true</span>, <span class="string">&#x27;&#x27;</span>, <span class="built_in">this</span>._convert(field))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">_convert</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> rule <span class="keyword">of</span> <span class="built_in">this</span>.rules) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rule.name == <span class="string">&#x27;isInt&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">parseInt</span>(value)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (rule.name == <span class="string">&#x27;isFloat&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">parseFloat</span>(value)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (rule.name == <span class="string">&#x27;isBoolean&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> value ? <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">_allowEmpty</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> rule <span class="keyword">of</span> <span class="built_in">this</span>.rules) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rule.name == <span class="string">&#x27;isOptional&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">_hasDefault</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> rule <span class="keyword">of</span> <span class="built_in">this</span>.rules) &#123;</span><br><span class="line">            <span class="keyword">const</span> defaultValue = rule.params[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> (rule.name == <span class="string">&#x27;isOptional&#x27;</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> defaultValue</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    Rule,</span><br><span class="line">    BetterValidate</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<ol>
<li>使用BetterValidate 进行参数验证<br>app / validators / user / register.js</li>
</ol>
<ul>
<li>这里进行User模块的注册验证</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; BetterValidate, Rule &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../../cores/valitators&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户注册校验</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Register</span> <span class="keyword">extends</span> <span class="title">BetterValidate</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">         <span class="built_in">super</span>()</span><br><span class="line">         <span class="built_in">this</span>.email = [</span><br><span class="line">             <span class="keyword">new</span> Rule(<span class="string">&#x27;isEmail&#x27;</span>, <span class="string">&#x27;不符合Email规范&#x27;</span>)</span><br><span class="line">         ],</span><br><span class="line"></span><br><span class="line">         <span class="built_in">this</span>.password = [</span><br><span class="line">             <span class="keyword">new</span> Rule(<span class="string">&#x27;isLength&#x27;</span>, <span class="string">&#x27;密码至少6个字符，最多32个字符&#x27;</span>, &#123;</span><br><span class="line">                 <span class="attr">min</span>: <span class="number">6</span>,</span><br><span class="line">                 <span class="attr">max</span>: <span class="number">32</span></span><br><span class="line">             &#125;),</span><br><span class="line"></span><br><span class="line">             <span class="keyword">new</span> Rule(<span class="string">&#x27;matches&#x27;</span>, <span class="string">&#x27;密码必须是字母和数字组合&#x27;</span>, <span class="string">&#x27;^(?![0-9]+$)(?![a-zA-Z]+$)[0-9a-zA-Z]&#x27;</span>)</span><br><span class="line">         ],</span><br><span class="line"></span><br><span class="line">         <span class="built_in">this</span>.passwordConfirm = <span class="built_in">this</span>.password,</span><br><span class="line"></span><br><span class="line">         <span class="built_in">this</span>.nickname = [</span><br><span class="line">             <span class="keyword">new</span> Rule(<span class="string">&#x27;isLength&#x27;</span>, <span class="string">&#x27;昵称最少2个字符，最大6个字符&#x27;</span>, &#123;<span class="attr">min</span>:<span class="number">2</span>,<span class="attr">max</span>:<span class="number">30</span>&#125;)</span><br><span class="line">         ] </span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 自定义验证规则</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param <span class="type">&#123; String &#125;</span> </span>value POST表单提交过来的值</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="function"><span class="title">validatePassword</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">         <span class="comment">// body.password 表单提交的 password 字段</span></span><br><span class="line">         <span class="keyword">const</span> pwd = value.body.password;</span><br><span class="line">         <span class="keyword">const</span> pwdConfirm = value.body.passwordConfirm;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (!<span class="built_in">Object</span>.is(pwd,pwdConfirm)) &#123;</span><br><span class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;两次密码输入不一致!&#x27;</span>)</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="built_in">module</span>.exports = Register;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>更多验证规则</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; BetterValidate, Rule &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../../cores/valitators&#x27;</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户登录校验</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Login</span> <span class="keyword">extends</span> <span class="title">BetterValidate</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">         <span class="built_in">super</span>()</span><br><span class="line">         <span class="built_in">this</span>.account = [</span><br><span class="line">             <span class="keyword">new</span> Rule(<span class="string">&#x27;isLength&#x27;</span>, <span class="string">&#x27;账号最少4位，不能超过32位&#x27;</span>, &#123;</span><br><span class="line">                 <span class="attr">min</span>: <span class="number">4</span>,</span><br><span class="line">                 <span class="attr">max</span>: <span class="number">32</span></span><br><span class="line">             &#125;)</span><br><span class="line">         ],</span><br><span class="line">         <span class="built_in">this</span>.secret = [</span><br><span class="line">             <span class="comment">// 存在则验证，不存在则不验证</span></span><br><span class="line">             <span class="keyword">new</span> Rule(<span class="string">&#x27;isOptional&#x27;</span>),</span><br><span class="line">             <span class="keyword">new</span> Rule(<span class="string">&#x27;isLength&#x27;</span>, <span class="string">&#x27;至少6个字符&#x27;</span>, &#123;</span><br><span class="line">                 <span class="attr">min</span>: <span class="number">6</span>,</span><br><span class="line">                 <span class="attr">max</span>: <span class="number">128</span></span><br><span class="line">             &#125;)</span><br><span class="line">         ]</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 自定义验证规则</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param <span class="type">&#123; String &#125;</span> </span>value POST表单提交过来的值</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="function"><span class="title">validateType</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">         <span class="keyword">const</span> type = value.body.type;</span><br><span class="line">         <span class="keyword">if</span> (!type) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;type 不能为空!&#x27;</span>);</span><br><span class="line">         <span class="keyword">if</span> (!<span class="built_in">this</span>._checkTypes(type)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;type类型必须为 100 101 102 200&#x27;</span>);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 自定义枚举类型</span></span><br><span class="line">     <span class="function"><span class="title">_checkTypes</span>(<span class="params">type</span>)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> allowed = &#123;</span><br><span class="line">            <span class="attr">USER_MINI_PROGRAM</span>: <span class="number">100</span>,</span><br><span class="line">            <span class="attr">USER_EMAIL</span>: <span class="number">101</span>,</span><br><span class="line">            <span class="attr">USER_MOBILE</span>: <span class="number">102</span>,</span><br><span class="line">            <span class="attr">ADMIN_EMAIL</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="attr">WEIXIN_LOGIN</span>:<span class="number">300</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> [key, val] <span class="keyword">of</span> <span class="built_in">Object</span>.entries(allowed)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( val === <span class="built_in">Number</span>(type) ) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="built_in">module</span>.exports = Login;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>控制器进行参数验证</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用</span></span><br><span class="line">   <span class="keyword">const</span> v = <span class="keyword">await</span> <span class="keyword">new</span> RegisterValidator().validate(ctx);</span><br><span class="line">   <span class="comment">// 取数据</span></span><br><span class="line">   <span class="keyword">const</span> nickname = v.get(<span class="string">&quot;body.nickname&quot;</span>);</span><br><span class="line">   <span class="keyword">await</span> userDao.createUser(ctx, v);</span><br><span class="line">   ctx.json(</span><br><span class="line">     <span class="keyword">new</span> Success(&#123;</span><br><span class="line">       <span class="attr">msg</span>: <span class="string">&quot;用户创建成功&quot;</span></span><br><span class="line">     &#125;)</span><br><span class="line">   );</span><br></pre></td></tr></table></figure>



<h5 id="BetterValidate-校验规则"><a href="#BetterValidate-校验规则" class="headerlink" title="BetterValidate 校验规则"></a>BetterValidate 校验规则</h5><p><strong>类校验</strong></p>
<p>对于参数的校验，Lin 提供了类校验这种便捷，好用的方式，它会 对<code>ctx.request.body(上下文请求体)</code>、<code>ctx.request.query(上下文请求query参数)</code>、<code>ctx.request.header(上下文请求头)</code>、<code>ctx.param(路由参数)</code>这些参数进行统一校验 ，所以请保证你的参数名<strong>没有重复</strong>。</p>
<p>代码演示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegisterValidator</span> <span class="keyword">extends</span> <span class="title">LinValidator</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    <span class="built_in">this</span>.nickname = [</span><br><span class="line">      <span class="keyword">new</span> Rule(<span class="string">&quot;isNotEmpty&quot;</span>, <span class="string">&quot;昵称不可为空&quot;</span>),</span><br><span class="line">      <span class="keyword">new</span> Rule(<span class="string">&quot;isLength&quot;</span>, <span class="string">&quot;昵称长度必须在2~10之间&quot;</span>, <span class="number">2</span>, <span class="number">10</span>)</span><br><span class="line">      <span class="keyword">new</span> Rule(<span class="string">&quot;isInt&quot;</span>, <span class="string">&quot;分组id必须是整数，且大于0&quot;</span>, &#123; <span class="attr">min</span>: <span class="number">1</span> &#125;)</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.group_id = <span class="keyword">new</span> Rule(<span class="string">&quot;isInt&quot;</span>, <span class="string">&quot;分组id必须是整数，且大于0&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">min</span>: <span class="number">1</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">this</span>.email = [</span><br><span class="line">      <span class="keyword">new</span> Rule(<span class="string">&quot;isOptional&quot;</span>),</span><br><span class="line">      <span class="keyword">new</span> Rule(<span class="string">&quot;isEmail&quot;</span>, <span class="string">&quot;电子邮箱不符合规范，请输入正确的邮箱&quot;</span>)</span><br><span class="line">    ];</span><br><span class="line">    <span class="built_in">this</span>.password = [</span><br><span class="line">      <span class="keyword">new</span> Rule(</span><br><span class="line">        <span class="string">&quot;matches&quot;</span>,</span><br><span class="line">        <span class="string">&quot;密码长度必须在6~22位之间，包含字符、数字和 _ &quot;</span>,</span><br><span class="line">        <span class="regexp">/^[A-Za-z0-9_*&amp;$#@]&#123;6,22&#125;$/</span></span><br><span class="line">      )</span><br><span class="line">    ];</span><br><span class="line">    <span class="built_in">this</span>.confirm_password = <span class="keyword">new</span> Rule(<span class="string">&quot;isNotEmpty&quot;</span>, <span class="string">&quot;确认密码不可为空&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">validateConfirmPassword</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!data.body.password || !data.body.confirm_password) &#123;</span><br><span class="line">      <span class="keyword">return</span> [<span class="literal">false</span>, <span class="string">&quot;两次输入的密码不一致，请重新输入&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> ok = data.body.password === data.body.confirm_password;</span><br><span class="line">    <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">      <span class="keyword">return</span> ok;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> [<span class="literal">false</span>, <span class="string">&quot;两次输入的密码不一致，请重新输入&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>isOptional</strong></p>
<p><code>isOptional</code>这个 Rule 校验, 当字段存在时，则校验，不存在则不校验</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Rule(<span class="string">&quot;isOptional&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;pedrogao1996@gmail.com&quot;</span>),</span><br></pre></td></tr></table></figure>

<p>当<code>isOptional</code>Rule 被赋有默认值时，这个字段就会发生变化。以<code>email</code>为例，当前端没 有传入这个参数时，校验器中的<code>email</code>数据肯定是一个<code>undefined</code>。但是因为默认值的存 在，这个<code>email</code>会被赋予默认值，即<code>pedrogao1996@gmail.com</code></p>
<hr>
<p><strong>自定义规则函数</strong></p>
<p>规则函数是校验器中另一种用于对参数校验的方式，它比显示的 Rule 校验具有更加的灵活 性和可操作性。下面我们以一个小例子来深入理解规则函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">validateConfirmPassword</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (!data.body.password || !data.body.confirm_password) &#123;</span><br><span class="line">     <span class="keyword">return</span> [<span class="literal">false</span>, <span class="string">&quot;两次输入的密码不一致，请重新输入&quot;</span>];</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">let</span> ok = data.body.password === data.body.confirm_password;</span><br><span class="line">   <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">     <span class="keyword">return</span> ok;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> [<span class="literal">false</span>, <span class="string">&quot;两次输入的密码不一致，请重新输入&quot;</span>];</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>首先任何一个规则函数，满足以<code>validate</code>开头的类方法，除<code>validate()</code>这个函数外。都 会被带入一个重要的参数<code>data</code>。data 是前端传入参数的容器，它的整体结构如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.data = &#123;</span><br><span class="line">  <span class="attr">body</span>: ctx.request.body, <span class="comment">// body -&gt; body</span></span><br><span class="line">  <span class="attr">query</span>: ctx.request.query, <span class="comment">// query -&gt; query</span></span><br><span class="line">  <span class="attr">path</span>: ctx.params, <span class="comment">// params -&gt; path</span></span><br><span class="line">  <span class="attr">header</span>: ctx.request.header <span class="comment">// header -&gt; header</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>返回值的所有可选项类似如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">validateNameAndAge</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="comment">// 表示校验成功</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  <span class="comment">// 校验失败，并给定错误信息</span></span><br><span class="line">  <span class="keyword">return</span> [<span class="literal">false</span>,<span class="string">&quot;message&quot;</span>]</span><br><span class="line">  <span class="comment">// 校验失败，并给定错误信息，以及错误信息的键为nameAndAge</span></span><br><span class="line">  <span class="comment">// 一般情况下，我们会默认生成键，如这个函数生成的键为 NameAndAge，当然你也可以选择自定义</span></span><br><span class="line">  <span class="keyword">return</span> [<span class="literal">false</span>,<span class="string">&quot;message&quot;</span>,<span class="string">&quot;nameAndAge&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>规则函数除了通过返回值来判断失败之外，还可以通过抛出异常来提前结束规则函数并校验 失败。如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">validateNameAndAge</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="comment">// 抛出异常，即校验失败</span></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> ParametersException(&#123; <span class="attr">msg</span>: <span class="string">&quot;Lin will carry you!&quot;</span> &#125;);</span><br><span class="line">  <span class="comment">// 返回true，表示校验成功</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两种方式都可以使规则函数校验失败，但是我们推荐你使用第一种方式，即<strong>返回值方式</strong></p>
<hr>
<p><strong>继承</strong></p>
<p>校验器提供继承的方式，让你的参数可以被组合校验。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PositiveIdValidator</span> <span class="keyword">extends</span> <span class="title">LinValidator</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    <span class="built_in">this</span>.id = <span class="keyword">new</span> Rule(<span class="string">&quot;isInt&quot;</span>, <span class="string">&quot;id必须为正整数&quot;</span>, &#123; <span class="attr">min</span>: <span class="number">1</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们首先定义了一个<code>PositiveIdValidator</code>的校验器，它会被 id 这个参数进行正整数校 验，一般情况下 id 的校验被使用的很普遍，其他的校验器也需要使用，但是我们又不想重 新再写一遍。因此，我们可以继承<code>PositiveIdValidator</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpdateUserInfoValidator</span> <span class="keyword">extends</span> <span class="title">PositiveIdValidator</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    <span class="built_in">this</span>.group_id = <span class="keyword">new</span> Rule(<span class="string">&quot;isInt&quot;</span>, <span class="string">&quot;分组id必须是正整数&quot;</span>, &#123;</span><br><span class="line">      <span class="attr">min</span>: <span class="number">1</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">this</span>.email = <span class="keyword">new</span> Rule(<span class="string">&quot;isEmail&quot;</span>, <span class="string">&quot;电子邮箱不符合规范，请输入正确的邮箱&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里<code>UpdateUserInfoValidator</code>继承了<code>PositiveIdValidator</code>，因 此<code>UpdateUserInfoValidator</code>也可对 id 参数进行校验，而且扩展了 group_id 和 email 两个参数的校验。</p>
<hr>
<p><strong>别名</strong></p>
<p>validator 不仅仅提供继承，还提供另一种解放劳动力的方式——别名。如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PositiveIdValidator</span> <span class="keyword">extends</span> <span class="title">LinValidator</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>();</span><br><span class="line">    <span class="built_in">this</span>.id = <span class="keyword">new</span> Rule(<span class="string">&quot;isInt&quot;</span>, <span class="string">&quot;id必须为正整数&quot;</span>, &#123; <span class="attr">min</span>: <span class="number">1</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>PositiveIdValidator</code>会对 id 参数进行校验，但是有时候参数的校验逻辑是一样的，但 是参数的名字不相同。如 uid 这个参数，它跟 id 这个参数的 Rule 一样。那么我们是不 是还需要重新再写一个校验器定义一个 uid 的 Rule 了。这可行，但不优雅。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> v = <span class="keyword">await</span> <span class="keyword">new</span> PositiveIdValidator().validate(ctx, &#123; <span class="attr">id</span>: <span class="string">&quot;uid&quot;</span> &#125;);</span><br></pre></td></tr></table></figure>

<p>我们可以通过上面的方式来给 id 一个别名，这个别名为 uid。当使用了别名之后，校验器 不会对 id 这个参数做校验，<strong>但是会对 uid 这个参数做校验</strong>。</p>
<h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><p>中间件（Middleware）</p>
<p>Egg 是基于 Koa 实现的，所以 Egg 的中间件形式和 Koa 的中间件形式是一样的，都是基于<a href="#e">洋葱圈模型</a>。每次我们编写一个中间件，就相当于在洋葱外面包了一层。</p>
<h3 id="编写中间件"><a href="#编写中间件" class="headerlink" title="编写中间件"></a>编写中间件</h3><p>写法</p>
<p>我们先来通过编写一个简单的 gzip 中间件，来看看中间件的写法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/middleware/gzip.js</span></span><br><span class="line"><span class="keyword">const</span> isJSON = <span class="built_in">require</span>(<span class="string">&#x27;koa-is-json&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> zlib = <span class="built_in">require</span>(<span class="string">&#x27;zlib&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">gzip</span>(<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> next();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 后续中间件执行完成后将响应体转换成 gzip</span></span><br><span class="line">  <span class="keyword">let</span> body = ctx.body;</span><br><span class="line">  <span class="keyword">if</span> (!body) <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (isJSON(body)) body = <span class="built_in">JSON</span>.stringify(body);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置 gzip body，修正响应头</span></span><br><span class="line">  <span class="keyword">const</span> stream = zlib.createGzip();</span><br><span class="line">  stream.end(body);</span><br><span class="line">  ctx.body = stream;</span><br><span class="line">  ctx.set(<span class="string">&#x27;Content-Encoding&#x27;</span>, <span class="string">&#x27;gzip&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，框架的中间件和 Koa 的中间件写法是一模一样的，所以任何 Koa 的中间件都可以直接被框架使用。</p>
<h4 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h4><p>一般来说中间件也会有自己的配置。在框架中，一个完整的中间件是包含了配置处理的。我们约定一个中间件是一个放置在 <code>app/middleware</code> 目录下的单独文件，它需要 exports 一个普通的 function，接受两个参数：</p>
<ul>
<li>options: 中间件的配置项，框架会将 <code>app.config[$&#123;middlewareName&#125;]</code> 传递进来。</li>
<li>app: 当前应用 Application 的实例。</li>
</ul>
<p>我们将上面的 gzip 中间件做一个简单的优化，让它支持指定只有当 body 大于配置的 threshold 时才进行 gzip 压缩，我们要在 <code>app/middleware</code> 目录下新建一个文件 <code>gzip.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/middleware/gzip.js</span></span><br><span class="line"><span class="keyword">const</span> isJSON = <span class="built_in">require</span>(<span class="string">&#x27;koa-is-json&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> zlib = <span class="built_in">require</span>(<span class="string">&#x27;zlib&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">options</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">gzip</span>(<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 后续中间件执行完成后将响应体转换成 gzip</span></span><br><span class="line">    <span class="keyword">let</span> body = ctx.body;</span><br><span class="line">    <span class="keyword">if</span> (!body) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 支持 options.threshold</span></span><br><span class="line">    <span class="keyword">if</span> (options.threshold &amp;&amp; ctx.length &lt; options.threshold) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isJSON(body)) body = <span class="built_in">JSON</span>.stringify(body);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 gzip body，修正响应头</span></span><br><span class="line">    <span class="keyword">const</span> stream = zlib.createGzip();</span><br><span class="line">    stream.end(body);</span><br><span class="line">    ctx.body = stream;</span><br><span class="line">    ctx.set(<span class="string">&#x27;Content-Encoding&#x27;</span>, <span class="string">&#x27;gzip&#x27;</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="使用中间件"><a href="#使用中间件" class="headerlink" title="使用中间件"></a>使用中间件</h3><p>中间件编写完成后，我们还需要手动挂载，支持以下方式：</p>
<h4 id="在应用中使用中间件"><a href="#在应用中使用中间件" class="headerlink" title="在应用中使用中间件"></a>在应用中使用中间件</h4><p>在应用中，我们可以完全通过配置来加载自定义的中间件，并决定它们的顺序。</p>
<p>如果我们需要加载上面的 gzip 中间件，在 <code>config.default.js</code> 中加入下面的配置就完成了中间件的开启和配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 配置需要的中间件，数组顺序即为中间件的加载顺序</span></span><br><span class="line">  <span class="attr">middleware</span>: [ <span class="string">&#x27;gzip&#x27;</span> ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 配置 gzip 中间件的配置</span></span><br><span class="line">  <span class="attr">gzip</span>: &#123;</span><br><span class="line">    <span class="attr">threshold</span>: <span class="number">1024</span>, <span class="comment">// 小于 1k 的响应体不压缩</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>该配置最终将在启动时合并到 <code>app.config.appMiddleware</code>。</p>
<h4 id="在框架和插件中使用中间件"><a href="#在框架和插件中使用中间件" class="headerlink" title="在框架和插件中使用中间件"></a>在框架和插件中使用中间件</h4><p>框架和插件不支持在 <code>config.default.js</code> 中匹配 <code>middleware</code>，需要通过以下方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 在中间件最前面统计请求时间</span></span><br><span class="line">  app.config.coreMiddleware.unshift(<span class="string">&#x27;report&#x27;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/middleware/report.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> startTime = <span class="built_in">Date</span>.now();</span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    <span class="comment">// 上报请求时间</span></span><br><span class="line">    reportTime(<span class="built_in">Date</span>.now() - startTime);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>应用层定义的中间件（<code>app.config.appMiddleware</code>）和框架默认中间件（<code>app.config.coreMiddleware</code>）都会被加载器加载，并挂载到 <code>app.middleware</code> 上。</p>
<h4 id="router-中使用中间件"><a href="#router-中使用中间件" class="headerlink" title="router 中使用中间件"></a>router 中使用中间件</h4><p>以上两种方式配置的中间件是全局的，会处理每一次请求。 如果你只想针对单个路由生效，可以直接在 <code>app/router.js</code> 中实例化和挂载，如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> gzip = app.middleware.gzip(&#123; <span class="attr">threshold</span>: <span class="number">1024</span> &#125;);</span><br><span class="line">  app.router.get(<span class="string">&#x27;/needgzip&#x27;</span>, gzip, app.controller.handler);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="框架默认中间件"><a href="#框架默认中间件" class="headerlink" title="框架默认中间件"></a>框架默认中间件</h3><p>除了应用层加载中间件之外，框架自身和其他的插件也会加载许多中间件。所有的这些自带中间件的配置项都通过在配置中修改中间件同名配置项进行修改，例如<a target="_blank" rel="noopener" href="https://github.com/eggjs/egg/tree/master/app/middleware">框架自带的中间件</a>中有一个 bodyParser 中间件（框架的加载器会将文件名中的各种分隔符都修改成驼峰形式的变量名），我们想要修改 bodyParser 的配置，只需要在 <code>config/config.default.js</code> 中编写</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">bodyParser</span>: &#123;</span><br><span class="line">    <span class="attr">jsonLimit</span>: <span class="string">&#x27;10mb&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>注意：框架和插件加载的中间件会在应用层配置的中间件之前，框架默认中间件不能被应用层中间件覆盖，如果应用层有自定义同名中间件，在启动时会报错。</strong></p>
<h3 id="使用-Koa-的中间件"><a href="#使用-Koa-的中间件" class="headerlink" title="使用 Koa 的中间件"></a>使用 Koa 的中间件</h3><p>在框架里面可以非常容易的引入 Koa 中间件生态。</p>
<p>以 <a target="_blank" rel="noopener" href="https://github.com/koajs/compress">koa-compress</a> 为例，在 Koa 中使用时：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> koa = <span class="built_in">require</span>(<span class="string">&#x27;koa&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> compress = <span class="built_in">require</span>(<span class="string">&#x27;koa-compress&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = koa();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> options = &#123; <span class="attr">threshold</span>: <span class="number">2048</span> &#125;;</span><br><span class="line">app.use(compress(options));</span><br></pre></td></tr></table></figure>

<p>我们按照框架的规范来在应用中加载这个 Koa 的中间件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/middleware/compress.js</span></span><br><span class="line"><span class="comment">// koa-compress 暴露的接口(`(options) =&gt; middleware`)和框架对中间件要求一致</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="built_in">require</span>(<span class="string">&#x27;koa-compress&#x27;</span>);</span><br><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">middleware</span>: [ <span class="string">&#x27;compress&#x27;</span> ],</span><br><span class="line">  <span class="attr">compress</span>: &#123;</span><br><span class="line">    <span class="attr">threshold</span>: <span class="number">2048</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如果使用到的 Koa 中间件不符合入参规范，则可以自行处理下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">webpack</span>: &#123;</span><br><span class="line">    <span class="attr">compiler</span>: &#123;&#125;,</span><br><span class="line">    <span class="attr">others</span>: &#123;&#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/middleware/webpack.js</span></span><br><span class="line"><span class="keyword">const</span> webpackMiddleware = <span class="built_in">require</span>(<span class="string">&#x27;some-koa-middleware&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">options, app</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> webpackMiddleware(options.compiler, options.others);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="通用配置"><a href="#通用配置" class="headerlink" title="通用配置"></a>通用配置</h3><p>无论是应用层加载的中间件还是框架自带中间件，都支持几个通用的配置项：</p>
<ul>
<li>enable：控制中间件是否开启。</li>
<li>match：设置只有符合某些规则的请求才会经过这个中间件。</li>
<li>ignore：设置符合某些规则的请求不经过这个中间件。</li>
</ul>
<h4 id="enable"><a href="#enable" class="headerlink" title="enable"></a>enable</h4><p>如果我们的应用并不需要默认的 bodyParser 中间件来进行请求体的解析，此时我们可以通过配置 enable 为 false 来关闭它</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">bodyParser</span>: &#123;</span><br><span class="line">    <span class="attr">enable</span>: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="match-和-ignore"><a href="#match-和-ignore" class="headerlink" title="match 和 ignore"></a>match 和 ignore</h4><p>match 和 ignore 支持的参数都一样，只是作用完全相反，match 和 ignore 不允许同时配置。</p>
<p>如果我们想让 gzip 只针对 <code>/static</code> 前缀开头的 url 请求开启，我们可以配置 match 选项</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">  gzip: &#123;</span><br><span class="line">    match: &#x27;/static&#x27;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>match 和 ignore 支持多种类型的配置方式</p>
<ol>
<li>字符串：当参数为字符串类型时，配置的是一个 url 的路径前缀，所有以配置的字符串作为前缀的 url 都会匹配上。 当然，你也可以直接使用字符串数组。</li>
<li>正则：当参数为正则时，直接匹配满足正则验证的 url 的路径。</li>
<li>函数：当参数为一个函数时，会将请求上下文传递给这个函数，最终取函数返回的结果（true/false）来判断是否匹配。</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">gzip</span>: &#123;</span><br><span class="line">    <span class="function"><span class="title">match</span>(<span class="params">ctx</span>)</span> &#123;</span><br><span class="line">      <span class="comment">// 只有 ios 设备才开启</span></span><br><span class="line">      <span class="keyword">const</span> reg = <span class="regexp">/iphone|ipad|ipod/i</span>;</span><br><span class="line">      <span class="keyword">return</span> reg.test(ctx.get(<span class="string">&#x27;user-agent&#x27;</span>));</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>有关更多的 match 和 ignore 配置情况，详见 <a href="#">egg-path-matching</a>.</p>
<h2 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h2><h3 id="数据加密"><a href="#数据加密" class="headerlink" title="数据加密"></a>数据加密</h3><p>bcrypt 数据加密</p>
<p>文档：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/bcryptjs">https://www.npmjs.com/package/bcryptjs</a><br>安装：cnpm i -S bcryptjs</p>
<ul>
<li>使用：</li>
</ul>
<ol>
<li>封装helper函数 app / extend / helper.js</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入加密插件</span></span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&#x27;bcryptjs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>)</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码加密助手函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;String&#125;</span> </span>password 原始密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return <span class="type">&#123;String&#125;</span> </span>返回加密后的密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="title">bcryptData</span>(<span class="params">password</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 生成盐</span></span><br><span class="line">        <span class="keyword">const</span> salt = bcrypt.genSaltSync(<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">return</span> bcrypt.hashSync(password, salt)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解密助手函数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>password 未加密的密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>user_password 加密的密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return </span>Promise 两个密码比对，比对成功返回true 失败返回 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">     <span class="keyword">async</span> <span class="function"><span class="title">comparePwd</span>(<span class="params">password, user_password</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> bcrypt.compare(password, user_password)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成 jwt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123;*&#125;</span> </span>data 需要加密的用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="title">generateToken</span>(<span class="params">data</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> jwt.sign(&#123;</span><br><span class="line">            data</span><br><span class="line">        &#125;, <span class="built_in">this</span>.config.token.key, &#123; <span class="attr">expiresIn</span>: <span class="built_in">this</span>.config.token.expiresIn &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>控制器中使用<br><code>ctx.body = ctx.helper.bcryptData(&#39;123456&#39;)</code></li>
</ol>
<h3 id="单向加密"><a href="#单向加密" class="headerlink" title="单向加密"></a>单向加密</h3><h4 id="crypto-加密实例代码"><a href="#crypto-加密实例代码" class="headerlink" title="crypto 加密实例代码"></a>crypto 加密实例代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="comment">//引用crypto模块</span></span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&quot;crypto&quot;</span>);</span><br><span class="line"><span class="comment">//-------------MD5 可以任意多次调用update(),update()默认字符串编码是UTF-8</span></span><br><span class="line"><span class="keyword">const</span> hash = crypto.createHash(<span class="string">&quot;md5&quot;</span>);</span><br><span class="line">hash.update(<span class="string">&quot;hello, world!&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(hash.digest(<span class="string">&quot;hex&quot;</span>));</span><br><span class="line"><span class="comment">//--------------SHA1</span></span><br><span class="line"><span class="keyword">const</span> sha1 = crypto.createHash(<span class="string">&quot;sha1&quot;</span>);</span><br><span class="line">sha1.update(<span class="string">&quot;hello,world!&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(sha1.digest(<span class="string">&quot;hex&quot;</span>));</span><br><span class="line"><span class="comment">//-------------SHA256</span></span><br><span class="line"><span class="keyword">const</span> sha256 = crypto.createHash(<span class="string">&quot;sha256&quot;</span>);</span><br><span class="line">sha256.update(<span class="string">&quot;hello,world!&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(sha256.digest(<span class="string">&quot;hex&quot;</span>));</span><br><span class="line"><span class="comment">//------------SHA512</span></span><br><span class="line"><span class="keyword">const</span> sha512 = crypto.createHash(<span class="string">&quot;sha512&quot;</span>);</span><br><span class="line">sha512.update(<span class="string">&quot;hello,world!&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(sha512.digest(<span class="string">&quot;hex&quot;</span>));</span><br><span class="line"><span class="comment">//------------Hmac</span></span><br><span class="line"><span class="keyword">const</span> hmac = crypto.createHash(<span class="string">&quot;sha256&quot;</span>,<span class="string">&quot;secret-key&quot;</span>);</span><br><span class="line">hmac.update(<span class="string">&quot;hello world!&quot;</span>);</span><br><span class="line"><span class="built_in">console</span>.log(hmac.digest(<span class="string">&quot;hex&quot;</span>));</span><br><span class="line"><span class="comment">//-----------AES</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aesEncrypt</span>(<span class="params">data, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> cipher = crypto.createCipher(<span class="string">&quot;aes192&quot;</span>, key);</span><br><span class="line">    <span class="keyword">var</span> crypted = cipher.update(data, <span class="string">&quot;utf8&quot;</span>, <span class="string">&quot;hex&quot;</span>);</span><br><span class="line">    crypted += cipher.final(<span class="string">&quot;hex&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> crypted;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aesDecrypt</span>(<span class="params">encrypted, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> decipher = crypto.createDecipher(<span class="string">&quot;aes192&quot;</span>, key);</span><br><span class="line">    <span class="keyword">var</span> decrypted = decipher.update(encrypted, <span class="string">&quot;hex&quot;</span>, <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">    decrypted += decipher.final(<span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> decrypted;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> data = <span class="string">&quot;hello this a secret message!&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> key = <span class="string">&quot;password&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> encrypted = aesEncrypt(data,key);</span><br><span class="line"><span class="keyword">var</span> decrypted = aesDecrypt(encrypted, key);</span><br><span class="line"> </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;plain text:&quot;</span> + data);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Encrypted text:&quot;</span> +encrypted);</span><br><span class="line"><span class="built_in">console</span>.log((<span class="string">&quot;Decrypted text:&quot;</span> + decrypted));</span><br><span class="line"><span class="comment">//------------------diffie-hellman</span></span><br><span class="line"><span class="keyword">var</span> ming = crypto.createDiffieHellman(<span class="number">512</span>);</span><br><span class="line"><span class="keyword">var</span> ming_keys = ming.generateKeys();</span><br><span class="line"><span class="keyword">var</span> prime = ming.getPrime();</span><br><span class="line"><span class="keyword">var</span> generator = ming.getGenerator();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Prime:&quot;</span> + prime.toString(<span class="string">&quot;hex&quot;</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Generator:&quot;</span> + generator.toString(<span class="string">&quot;hex&quot;</span>) );</span><br><span class="line"> </span><br><span class="line"><span class="keyword">var</span> hong = crypto.createDiffieHellman(prime, generator);</span><br><span class="line"><span class="keyword">var</span> hong_keys = hong.generateKeys();</span><br><span class="line"> </span><br><span class="line"><span class="keyword">var</span> ming_secret = ming.computeSecret(hong_keys);</span><br><span class="line"><span class="keyword">var</span> hong_secret = hong.computeSecret(ming_keys);</span><br><span class="line"> </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Secret of xiao ming:&quot;</span> + ming_secret.toString(<span class="string">&quot;hex&quot;</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Secret of xiao hong:&quot;</span> + hong_secret.toString(<span class="string">&quot;hex&quot;</span>));</span><br><span class="line"><span class="comment">//----------RSA</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="comment">//从文件加载key</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadKey</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fs.readFileSync(file,<span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span>  prvKey = loadKey(<span class="string">&quot;./rsa-prv.pem&quot;</span>);</span><br><span class="line"><span class="keyword">let</span>  pubKey = loadKey(<span class="string">&quot;./rsa-pub.pem&quot;</span>);</span><br><span class="line"><span class="keyword">let</span>  message = <span class="string">&quot;hello world!&quot;</span>;</span><br><span class="line"><span class="comment">//使用私钥加密公钥解密</span></span><br><span class="line"><span class="keyword">let</span> enc_by_prv = crypto.privateEncrypt(prvKey,Buffer.from(message,<span class="string">&quot;utf8&quot;</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;encrypted by private key:&quot;</span> + enc_by_prv.toString(<span class="string">&quot;hex&quot;</span>));</span><br><span class="line"><span class="keyword">let</span>  dec_by_pub = crypto.publicDecrypt(pubKey, enc_by_prv);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;decrypted by public key:&quot;</span> + dec_by_pub.toString(<span class="string">&quot;utf8&quot;</span>));</span><br><span class="line"><span class="comment">//使用公钥进行加密私钥解密</span></span><br><span class="line"><span class="keyword">let</span> enc_by_pub = crypto.publicEncrypt(pubKey,Buffer.from(message,<span class="string">&quot;utf8&quot;</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;encrypted by public key:&quot;</span> + enc_by_pub.toString(<span class="string">&quot;hex&quot;</span>));</span><br><span class="line"><span class="keyword">let</span> dec_by_prv = crypto.privateDecrypt(prvKey,enc_by_pub);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;decrypted by private key:&quot;</span> + dec_by_prv.toString(<span class="string">&quot;utf8&quot;</span>));</span><br></pre></td></tr></table></figure>

<h4 id="封装Crypto作为egg-js-专用加密函数"><a href="#封装Crypto作为egg-js-专用加密函数" class="headerlink" title="封装Crypto作为egg.js 专用加密函数"></a>封装Crypto作为egg.js 专用加密函数</h4><ol>
<li>安装 <code>npm install crypto --save</code></li>
<li>配置文件配置 config / config.default.js</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config.crypto = &#123;</span><br><span class="line">    <span class="attr">secret</span>:  <span class="string">&#x27;ghdgw@45njashdaksh2!#@3nxjdas_*672&#x27;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol>
<li>扩展application对象 app / extend / application.js</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="keyword">get</span> <span class="title">jwt</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> jwt;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">cryptoHmac</span>(<span class="params">param</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> hmac = crypto.createHash(<span class="string">&quot;sha256&quot;</span>,<span class="built_in">this</span>.config.crypto.secret);</span><br><span class="line">        hmac.update(param);</span><br><span class="line">        <span class="keyword">return</span> hmac.digest(<span class="string">&quot;hex&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="上传"><a href="#上传" class="headerlink" title="上传"></a>上传</h2><h3 id="path模块"><a href="#path模块" class="headerlink" title="path模块"></a>path模块</h3><h4 id="egg-单文件上传"><a href="#egg-单文件上传" class="headerlink" title="egg 单文件上传"></a>egg 单文件上传</h4><ul>
<li>获取路径：path.dirname(filepath)</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path=<span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>); </span><br><span class="line"><span class="keyword">var</span> filepath=<span class="string">&#x27;/node/base/path/test.js&#x27;</span>; </span><br><span class="line"><span class="built_in">console</span>.log( path.dirname(filepath) )</span><br><span class="line"> <span class="comment">//输出/node/base/path</span></span><br></pre></td></tr></table></figure>

<ul>
<li>获取文件名：path.basename(filename)</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>); </span><br><span class="line"><span class="built_in">console</span>.log(path.basename(<span class="string">&quot;/node/base/path/test.js&quot;</span>,<span class="string">&quot;.js&quot;</span>)); </span><br><span class="line"><span class="comment">//输出 test</span></span><br></pre></td></tr></table></figure>

<ul>
<li>获取扩展名：path.extname(filepath)</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>); </span><br><span class="line"><span class="built_in">console</span>.log(path.extname(<span class="string">&quot;/node/base/path/test.js&quot;</span>,<span class="string">&quot;.js&quot;</span>));</span><br><span class="line"> <span class="comment">//输出 .js</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="文件路径分解-组合"><a href="#文件路径分解-组合" class="headerlink" title="文件路径分解/组合"></a>文件路径分解/组合</h4><ul>
<li>path.join([…paths])</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path=<span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line">path.join(<span class="string">&quot;/temp&quot;</span>,<span class="string">&#x27;node&#x27;</span>,<span class="string">&#x27;/js/test.js&#x27;</span>)</span><br><span class="line"><span class="comment">//输出    \temp\node\js\test.js</span></span><br><span class="line">path.join(<span class="string">&quot;/temp&quot;</span>,<span class="string">&#x27;node&#x27;</span>,<span class="string">&#x27;/js/test.js/&#x27;</span>,<span class="string">&#x27;..&#x27;</span>)</span><br><span class="line"><span class="comment">//输出    \temp\node\js</span></span><br></pre></td></tr></table></figure>



<h3 id="单文件上传"><a href="#单文件上传" class="headerlink" title="单文件上传"></a>单文件上传</h3><h4 id="egg-单文件上传-1"><a href="#egg-单文件上传-1" class="headerlink" title="egg 单文件上传"></a>egg 单文件上传</h4><ul>
<li><p>通过<code>ctx.getFileStream</code>便捷的获取到用户上传的文件，需要满足两个条件：</p>
</li>
<li><p>只支持上传一个文件。</p>
</li>
<li><p>上传文件必须在所有其他的 fields 后面，否则在拿到文件流时可能还获取不到 fields。</p>
</li>
</ul>
<hr>
<p>文档：<a target="_blank" rel="noopener" href="https://eggjs.org/zh-cn/basics/controller.html">https://eggjs.org/zh-cn/basics/controller.html</a><br>代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">&#x27;egg&#x27;</span>).Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> sendToWormhole = <span class="built_in">require</span>(<span class="string">&#x27;stream-wormhole&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传用户头像</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">upload</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; ctx &#125; = <span class="built_in">this</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取表单提交的文件流</span></span><br><span class="line">        <span class="keyword">const</span> stream = <span class="keyword">await</span> ctx.getFileStream()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取上传的文件名  like.jpg dog.png </span></span><br><span class="line">        <span class="keyword">const</span> file_name = path.basename(stream.filename)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 拼接上传路径</span></span><br><span class="line">        <span class="keyword">const</span> upload_path = <span class="string">&#x27;app/public/admin/uploads/&#x27;</span> + file_name</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个可以写入的流</span></span><br><span class="line">        <span class="keyword">const</span> writeStream = fs.createWriteStream(upload_path)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 把读取到的表单信息流写入创建的可写流</span></span><br><span class="line">            result = <span class="keyword">await</span> stream.pipe(writeStream)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="comment">// 上传失败销毁流</span></span><br><span class="line">            <span class="keyword">await</span> sendToWormhole(stream)</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">throw</span> err</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        ctx.body = &#123;</span><br><span class="line">            <span class="attr">url</span>: upload_path, <span class="comment">// 上传路径</span></span><br><span class="line">            <span class="attr">fields</span>: stream.fields <span class="comment">// 所有表单字段都能通过 `stream.fields` 获取到</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = UserController;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="使用-pump-插件上传"><a href="#使用-pump-插件上传" class="headerlink" title="使用 pump 插件上传"></a>使用 pump 插件上传</h4><ul>
<li>文档：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/pump">https://www.npmjs.com/package/pump</a></li>
<li>首先安装 npm install pump</li>
<li>代码：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">&#x27;egg&#x27;</span>).Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> pump = <span class="built_in">require</span>(<span class="string">&#x27;pump&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传用户头像</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">upload</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; ctx &#125; = <span class="built_in">this</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取表单提交的文件流</span></span><br><span class="line">        <span class="keyword">const</span> stream = <span class="keyword">await</span> ctx.getFileStream()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取上传的文件名  like.jpg dog.png </span></span><br><span class="line">        <span class="keyword">const</span> file_name = path.basename(stream.filename)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 拼接上传路径</span></span><br><span class="line">        <span class="keyword">const</span> upload_path = <span class="string">&#x27;app/public/admin/uploads/&#x27;</span> + file_name</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个可以写入的流</span></span><br><span class="line">        <span class="keyword">const</span> writeStream = fs.createWriteStream(upload_path)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第一个参数读取流，第二个参数可写流, 上传失败会自动销毁流</span></span><br><span class="line">        <span class="keyword">await</span> pump(stream, writeStream)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">        ctx.body = &#123;</span><br><span class="line">            <span class="attr">url</span>: upload_path, <span class="comment">// 上传路径</span></span><br><span class="line">            <span class="attr">fields</span>: stream.fields <span class="comment">// 所有表单字段都能通过 `stream.fields` 获取到</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = UserController;</span><br></pre></td></tr></table></figure>



<h3 id="多文件上传"><a href="#多文件上传" class="headerlink" title="多文件上传"></a>多文件上传</h3><h4 id="egg-多文件上传"><a href="#egg-多文件上传" class="headerlink" title="egg 多文件上传"></a>egg 多文件上传</h4><blockquote>
<p>如果要获取同时上传的多个文件，不能通过<code>ctx.getFileStream()</code>来获取<br>需要通过 ctx.multipart({ autoFields:true }) 获取<br>autoFields: true 表示获取除了文件字段以外的其他信息字段</p>
</blockquote>
<p>用户可以通过在<code>config/config.default.js</code>中配置来新增支持的文件扩展名，或者重写整个白名单<br>更多上传配置项：<a target="_blank" rel="noopener" href="https://github.com/eggjs/egg-multipart">https://github.com/eggjs/egg-multipart</a></p>
<ul>
<li>新增支持的文件扩展名</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">multipart</span>: &#123;</span><br><span class="line">    <span class="attr">fileExtensions</span>: [ <span class="string">&#x27;.apk&#x27;</span> ] <span class="comment">// 增加对 apk 扩展名的文件支持</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>覆盖整个白名单</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">multipart</span>: &#123;</span><br><span class="line">    <span class="attr">whitelist</span>: [ <span class="string">&#x27;.png&#x27;</span> ], <span class="comment">// 覆盖整个白名单，只允许上传 &#x27;.png&#x27; 格式</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li>多文件上传代码：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">&#x27;egg&#x27;</span>).Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> pump = <span class="built_in">require</span>(<span class="string">&#x27;pump&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 多文件上传</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">uploadMore</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;ctx&#125; = <span class="built_in">this</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取多个文件提交的数据流，多文件上传专用</span></span><br><span class="line">        <span class="keyword">const</span> parts = ctx.multipart(&#123; <span class="attr">autoFields</span>:<span class="literal">true</span> &#125;)</span><br><span class="line">        <span class="keyword">const</span> files = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> stream</span><br><span class="line">        <span class="keyword">while</span>( ( stream = <span class="keyword">await</span> parts() ) != <span class="literal">null</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 判断用户是否选择上传图片</span></span><br><span class="line">            <span class="keyword">if</span> (!stream.filename)</span><br><span class="line">            &#123;</span><br><span class="line">                ctx.throw(<span class="string">&#x27;请选择上传的图片!&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// filename 获取上传的文件名 xxx.jpg</span></span><br><span class="line">            <span class="keyword">const</span> filename = stream.filename.toLowerCase()</span><br><span class="line">           </span><br><span class="line">            <span class="comment">// fieldname 获取文件表单提交的字段名称 </span></span><br><span class="line">            <span class="keyword">const</span> fieldname = stream.fieldname</span><br><span class="line">          </span><br><span class="line">            <span class="comment">// 拼接上传路径</span></span><br><span class="line">            <span class="keyword">const</span> target = <span class="string">&#x27;app/public/admin/uploads/&#x27;</span>+path.basename(filename)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建可写流</span></span><br><span class="line">            <span class="keyword">const</span> writeStream = fs.createWriteStream(target)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 读取文件 &amp;&amp; 写入 &amp;&amp; 销毁当前流</span></span><br><span class="line">            <span class="keyword">await</span> pump(stream, writeStream)</span><br><span class="line">            </span><br><span class="line">            files.push(&#123;</span><br><span class="line">                [fieldname]: target</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ctx.body = &#123;</span><br><span class="line">            files,</span><br><span class="line">            <span class="attr">fields</span>:parts.field</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = UserController;</span><br></pre></td></tr></table></figure>



<h3 id="按照日期存储"><a href="#按照日期存储" class="headerlink" title="按照日期存储"></a>按照日期存储</h3><h4 id="基于egg-封装公共上传类"><a href="#基于egg-封装公共上传类" class="headerlink" title="基于egg 封装公共上传类"></a>基于egg 封装公共上传类</h4><ol>
<li>配置上传路径 config.default.js</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 上传文件类型限制</span></span><br><span class="line">config.multipart = &#123;</span><br><span class="line">  <span class="attr">fileExtensions</span>: [ <span class="string">&#x27;.apk&#x27;</span> ] <span class="comment">// 增加对 apk 扩展名的文件支持</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// add your user config here</span></span><br><span class="line"><span class="keyword">const</span> userConfig = &#123;</span><br><span class="line">  <span class="comment">// 上传路径配置</span></span><br><span class="line">  <span class="attr">upload_path</span>: <span class="string">&#x27;app/public/admin/uploads&#x27;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>2.导入上传类<br>app / service / uploads.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Service = <span class="built_in">require</span>(<span class="string">&#x27;egg&#x27;</span>).Service;</span><br><span class="line"><span class="comment">// 日期格式化插件</span></span><br><span class="line"><span class="keyword">const</span> sd = <span class="built_in">require</span>(<span class="string">&#x27;silly-datetime&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="comment">// 创建文件夹模块</span></span><br><span class="line"><span class="keyword">const</span> mkdirp = <span class="built_in">require</span>(<span class="string">&#x27;mz-modules/mkdirp&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> pump = <span class="built_in">require</span>(<span class="string">&#x27;mz-modules/pump&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 公共文件上传类</span></span><br><span class="line"><span class="comment">   * 安装 silly-datetime 日期格式化插件 文档：https://www.npmjs.com/package/silly-datetime</span></span><br><span class="line"><span class="comment">   * 安装 mz-modules 模块 需要里面的 mkdirp 递归创建目录</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UploadService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Public</span></span><br><span class="line"><span class="comment">     * 上传文件 支持多文件 单文件上传</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return <span class="type">&#123; files: 数据库保存的上传路径 fields: POST 提交的表单字段 &#125;</span></span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">uploadMoreAndSingle</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; ctx &#125; = <span class="built_in">this</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取多个文件提交的数据流，多文件上传专用</span></span><br><span class="line">        <span class="keyword">let</span> parts = ctx.multipart(&#123; <span class="attr">autoFields</span>: <span class="literal">true</span> &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// let files = [] // 数组形式</span></span><br><span class="line">        <span class="keyword">let</span> files = &#123;&#125; <span class="comment">// 对象形式</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> stream</span><br><span class="line">        <span class="keyword">while</span> ((stream = <span class="keyword">await</span> parts()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 判断用户是否选择上传图片</span></span><br><span class="line">            <span class="keyword">if</span> (!stream.filename) &#123;</span><br><span class="line">                ctx.throw(<span class="string">&#x27;请选择上传的图片!&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// filename 获取上传的文件名 xxx.jpg</span></span><br><span class="line">            <span class="keyword">let</span> filename = stream.filename.toLowerCase()</span><br><span class="line"></span><br><span class="line">            <span class="comment">// fieldname 获取文件表单提交的字段名称 </span></span><br><span class="line">            <span class="keyword">let</span> fieldname = stream.fieldname</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 拼接上传路径</span></span><br><span class="line">            <span class="keyword">let</span> dir = <span class="keyword">await</span> <span class="built_in">this</span>._getUploadDir(filename)</span><br><span class="line">            <span class="keyword">let</span> target = dir.uploadDir</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建可写流</span></span><br><span class="line">            <span class="keyword">let</span> writeStream = fs.createWriteStream(target)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 读取文件 &amp;&amp; 写入 &amp;&amp; 销毁当前流</span></span><br><span class="line">            <span class="keyword">await</span> pump(stream, writeStream)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对象形式</span></span><br><span class="line">            files = <span class="built_in">Object</span>.assign(files, &#123;</span><br><span class="line">                [fieldname]: dir.saveDir</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 数组形式</span></span><br><span class="line">            <span class="comment">// files.push(&#123;</span></span><br><span class="line">            <span class="comment">//     [fieldname]: dir.saveDir</span></span><br><span class="line">            <span class="comment">// &#125;)</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="comment">// 数据库保存的上传路径</span></span><br><span class="line">            files,</span><br><span class="line">            <span class="comment">// 提交的表单字段</span></span><br><span class="line">            <span class="attr">fields</span>: parts.field</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Private </span></span><br><span class="line"><span class="comment">    * 返回上传路径</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@filename </span>当前 POST 表单获取的文件流</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return <span class="type">&#123; uploadDir 上传保存的硬路径 saveDir 数据库保存的路径 &#125;</span></span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">_getUploadDir</span>(<span class="params">filename</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取当前日期</span></span><br><span class="line">        <span class="keyword">const</span> today = sd.format(<span class="keyword">new</span> <span class="built_in">Date</span>(), <span class="string">&#x27;YYYYMMDD&#x27;</span>)</span><br><span class="line">        <span class="comment">// 拼接上传地址 当前时间 + 上传目录</span></span><br><span class="line">        <span class="keyword">const</span> upload_dir = path.join(<span class="built_in">this</span>.config.upload_path, today)</span><br><span class="line">        <span class="comment">// 创建文件夹 目录不存在则创建</span></span><br><span class="line">        <span class="keyword">await</span> mkdirp(upload_dir)</span><br><span class="line">        <span class="comment">// 以当前时间戳 毫秒数 作为文件名保存</span></span><br><span class="line">        <span class="keyword">const</span> d = (<span class="keyword">new</span> <span class="built_in">Date</span>()).getTime()</span><br><span class="line">        <span class="comment">// 返回图片保存路径 app\public\admin\uploads\20190712\1562946142820.jpg</span></span><br><span class="line">        <span class="keyword">const</span> file_dir = path.join(upload_dir, <span class="string">`<span class="subst">$&#123;d&#125;</span><span class="subst">$&#123;path.extname(filename)&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">uploadDir</span>: file_dir,</span><br><span class="line">            <span class="comment">// 数据库保存地址 正则可以一次替换多个路径</span></span><br><span class="line">            <span class="attr">saveDir</span>: file_dir.slice(<span class="number">3</span>).replace(<span class="regexp">/\\/g</span>, <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = UploadService;</span><br></pre></td></tr></table></figure>



<h2 id="工具函数"><a href="#工具函数" class="headerlink" title="工具函数"></a>工具函数</h2><h3 id="egg常用工具函数"><a href="#egg常用工具函数" class="headerlink" title="egg常用工具函数"></a>egg常用工具函数</h3><h4 id="数值转整形"><a href="#数值转整形" class="headerlink" title="数值转整形"></a>数值转整形</h4><p>extend / helper.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="function"><span class="title">parseInt</span>(<span class="params">string</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> string === <span class="string">&#x27;number&#x27;</span>) <span class="keyword">return</span> string;</span><br><span class="line">        <span class="keyword">if</span> (!string) <span class="keyword">return</span> string;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">parseInt</span>(string) || <span class="number">0</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="筛选字段"><a href="#筛选字段" class="headerlink" title="筛选字段"></a>筛选字段</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">filterFields</span>(<span class="params">field</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> fields = field.split(<span class="string">&#x27;;&#x27;</span>).filter(<span class="function"><span class="params">f</span>  =&gt;</span> f);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> fields.length ===  <span class="number">0</span>  ?  <span class="string">&#x27;&#x27;</span>  : fields;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> &#123; field = <span class="string">&#x27;&#x27;</span> &#125; = ctx.query</span><br><span class="line"><span class="keyword">const</span> fields = ctx.helper.filterFields(field)</span><br></pre></td></tr></table></figure>



<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><h3 id="配置缓存插件"><a href="#配置缓存插件" class="headerlink" title="配置缓存插件"></a>配置缓存插件</h3><h4 id="egg-redis"><a href="#egg-redis" class="headerlink" title="egg-redis"></a>egg-redis</h4><p>文档：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/egg-redis">https://www.npmjs.com/package/egg-redis</a><br>安装：npm i egg-redis –save<br>开启插件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Change $&#123;app_root&#125;/config/plugin.js to enable redis plugin:</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.redis = &#123;</span><br><span class="line">  <span class="attr">enable</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">package</span>: <span class="string">&#x27;egg-redis&#x27;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>设置redis连接</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Configure redis information <span class="keyword">in</span> $&#123;app_root&#125;/config/config.default.js:</span><br><span class="line"></span><br><span class="line">Single Client</span><br><span class="line"></span><br><span class="line">config.redis = &#123;</span><br><span class="line">  <span class="attr">client</span>: &#123;</span><br><span class="line">    <span class="attr">port</span>: <span class="number">6379</span>,          <span class="comment">// Redis port</span></span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,   <span class="comment">// Redis host</span></span><br><span class="line">    <span class="attr">password</span>: <span class="string">&#x27;auth&#x27;</span>,</span><br><span class="line">    <span class="attr">db</span>: <span class="number">0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="封装常用redis操作类"><a href="#封装常用redis操作类" class="headerlink" title="封装常用redis操作类"></a>封装常用redis操作类</h4><ul>
<li>service / cache.js</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Service = <span class="built_in">require</span>(<span class="string">&#x27;egg&#x27;</span>).Service;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CacheService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 设置 redis 缓存</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123; String &#125;</span> </span>key 键</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;String | Object | array&#125;</span> </span>value 值</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123; Number &#125;</span> </span>expir 过期时间 单位秒</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123; String &#125;</span> </span>返回成功字符串OK</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">set</span>(<span class="params">key,value,expir=<span class="number">0</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; redis &#125; = <span class="built_in">this</span>.app</span><br><span class="line">    <span class="keyword">if</span> (expir === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> redis.set(key, <span class="built_in">JSON</span>.stringify(value))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> redis.set(key, <span class="built_in">JSON</span>.stringify(value), <span class="string">&#x27;EX&#x27;</span>, expir)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取 redis 缓存</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123; String &#125;</span> </span>key 键</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123; String | array | Object &#125;</span> </span>返回获取的数据</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">get</span>(<span class="params">key</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; redis &#125; = <span class="built_in">this</span>.app</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> redis.get(key)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">JSON</span>.parse(result)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * redis 自增</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123; String &#125;</span> </span>key 键</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123; Number &#125;</span> </span>value 自增的值 </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123; Number &#125;</span> </span>返回递增值</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">incr</span>(<span class="params">key, number=<span class="number">1</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; redis &#125; = <span class="built_in">this</span>.app</span><br><span class="line">    <span class="keyword">if</span> (number === <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> redis.incr(key)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> redis.incrby(key, number)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查询长度</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123; String &#125;</span> <span class="variable">key</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return <span class="type">&#123; Number &#125;</span> </span>返回数据长度</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">strlen</span>(<span class="params">key</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; redis &#125; = <span class="built_in">this</span>.app</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> redis.strlen(key)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = CacheService;</span><br></pre></td></tr></table></figure>



<h3 id="设置缓存"><a href="#设置缓存" class="headerlink" title="设置缓存"></a>设置缓存</h3><h4 id="set-设置普通类型的值"><a href="#set-设置普通类型的值" class="headerlink" title="set 设置普通类型的值"></a>set 设置普通类型的值</h4><ul>
<li>设置 set</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set(key: string, <span class="attr">value</span>: string expiryMode: string[ EX 秒 PX 分钟 ], <span class="attr">time</span>: number )</span><br></pre></td></tr></table></figure>

<blockquote>
<p>key: 键名称<br>value：存储的值<br>expiryMode：添加过期时间类型 EX 秒 PX 分钟<br>time：过期时间</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存储一个key为gender，value 为 男人的数据，10秒后过期</span></span><br><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.set(<span class="string">&#x27;gender&#x27;</span>, <span class="string">&#x27;男人&#x27;</span>, <span class="string">&#x27;EX&#x27;</span>, <span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="expire-为一个key重新设置过期时间"><a href="#expire-为一个key重新设置过期时间" class="headerlink" title="expire 为一个key重新设置过期时间"></a>expire 为一个key重新设置过期时间</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.expire(<span class="string">&#x27;name&#x27;</span>, <span class="number">20</span>) 秒</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="rpush-数组右侧新增"><a href="#rpush-数组右侧新增" class="headerlink" title="rpush 数组右侧新增"></a>rpush 数组右侧新增</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.rpush(<span class="string">&#x27;userList&#x27;</span>,<span class="string">&#x27;张三&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.rpush(<span class="string">&#x27;userList&#x27;</span>,<span class="string">&#x27;李四&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.rpush(<span class="string">&#x27;userList&#x27;</span>, <span class="string">&#x27;王五&#x27;</span>)</span><br><span class="line"></span><br><span class="line">返回一个数组 [<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;王五&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h4 id="lpush-数组左边新增"><a href="#lpush-数组左边新增" class="headerlink" title="lpush 数组左边新增"></a>lpush 数组左边新增</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.lpush(<span class="string">&#x27;userList&#x27;</span>, <span class="string">&#x27;数组左边新增的&#x27;</span>)</span><br><span class="line">[</span><br><span class="line">    <span class="string">&quot;数组左边新增的&quot;</span>,</span><br><span class="line">    <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="sadd-创建一个集合"><a href="#sadd-创建一个集合" class="headerlink" title="sadd 创建一个集合"></a>sadd 创建一个集合</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.sadd(<span class="string">&#x27;setList&#x27;</span>, <span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;李四&#x27;</span>,<span class="string">&#x27;赵六&#x27;</span>)</span><br><span class="line"></span><br><span class="line">返回值：[<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;赵六&#x27;</span>]</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="hset-设置哈希类型-就是存储一个对象"><a href="#hset-设置哈希类型-就是存储一个对象" class="headerlink" title="hset 设置哈希类型 就是存储一个对象"></a>hset 设置哈希类型 就是存储一个对象</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.hset(<span class="string">&#x27;loginUser&#x27;</span>, <span class="string">&#x27;id&#x27;</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.hset(<span class="string">&#x27;loginUser&#x27;</span>, <span class="string">&#x27;uname&#x27;</span>, <span class="string">&#x27;张三&#x27;</span>)</span><br><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.hset(<span class="string">&#x27;loginUser&#x27;</span>, <span class="string">&#x27;phone&#x27;</span>, <span class="string">&#x27;18888888888&#x27;</span>)</span><br><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.hset(<span class="string">&#x27;loginUser&#x27;</span>, <span class="string">&#x27;address&#x27;</span>, <span class="string">&#x27;北京市朝阳区&#x27;</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uname&quot;</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="string">&quot;phone&quot;</span>: <span class="string">&quot;18888888888&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: <span class="string">&quot;北京市朝阳区&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="hmset-一次性设置多个值"><a href="#hmset-一次性设置多个值" class="headerlink" title="hmset 一次性设置多个值"></a>hmset 一次性设置多个值</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.hmset(<span class="string">&#x27;userInfo&#x27;</span>,<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;张三&#x27;</span>,<span class="string">&#x27;age&#x27;</span>,<span class="number">18</span>,<span class="string">&#x27;address&#x27;</span>,<span class="string">&#x27;回龙观&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="获取缓存"><a href="#获取缓存" class="headerlink" title="获取缓存"></a>获取缓存</h3><h4 id="get-获取普通类型的值"><a href="#get-获取普通类型的值" class="headerlink" title="get 获取普通类型的值"></a>get 获取普通类型的值</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取key 为 gender 的数据</span></span><br><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.get(<span class="string">&#x27;gender&#x27;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="type-获取数据类型"><a href="#type-获取数据类型" class="headerlink" title="type 获取数据类型"></a>type 获取数据类型</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ctx.body = <span class="keyword">await</span> <span class="built_in">this</span>.app.redis.type(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">返回 string</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="lrange-获取-list-类型中所有数据"><a href="#lrange-获取-list-类型中所有数据" class="headerlink" title="lrange 获取 list 类型中所有数据"></a>lrange 获取 list 类型中所有数据</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 表示获取数组中所有的值 0 ，-1</span></span><br><span class="line">ctx.body = <span class="keyword">await</span> <span class="built_in">this</span>.app.redis.lrange(<span class="string">&#x27;userList&#x27;</span>,<span class="number">0</span>,-<span class="number">1</span>)</span><br><span class="line">[</span><br><span class="line">    <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="string">&quot;李四&quot;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="smembers-获取集合中的所有数据"><a href="#smembers-获取集合中的所有数据" class="headerlink" title="smembers 获取集合中的所有数据"></a>smembers 获取集合中的所有数据</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.smembers(<span class="string">&#x27;setList&#x27;</span>)</span><br><span class="line">[</span><br><span class="line">    <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="string">&quot;李四&quot;</span>,</span><br><span class="line">    <span class="string">&quot;赵六&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="hgetall-获取哈希类型所有数据"><a href="#hgetall-获取哈希类型所有数据" class="headerlink" title="hgetall 获取哈希类型所有数据"></a>hgetall 获取哈希类型所有数据</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ctx.body = <span class="keyword">await</span> <span class="built_in">this</span>.app.redis.hgetall(<span class="string">&#x27;loginUser&#x27;</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;uname&quot;</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="string">&quot;phone&quot;</span>: <span class="string">&quot;18888888888&quot;</span>,</span><br><span class="line">    <span class="string">&quot;address&quot;</span>: <span class="string">&quot;北京市朝阳区&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="hget-获取-Hash-指定数据"><a href="#hget-获取-Hash-指定数据" class="headerlink" title="hget 获取 Hash 指定数据"></a>hget 获取 Hash 指定数据</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.body = <span class="keyword">await</span> <span class="built_in">this</span>.app.redis.hget(<span class="string">&#x27;loginUser&#x27;</span>, <span class="string">&#x27;address&#x27;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="hmget-一次性获取多个值"><a href="#hmget-一次性获取多个值" class="headerlink" title="hmget 一次性获取多个值"></a>hmget 一次性获取多个值</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.hmget(<span class="string">&#x27;userInfo&#x27;</span>, <span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;age&#x27;</span>,<span class="string">&#x27;address&#x27;</span>)</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">    <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="string">&quot;18&quot;</span>,</span><br><span class="line">    <span class="string">&quot;回龙观&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<h3 id="删除缓存"><a href="#删除缓存" class="headerlink" title="删除缓存"></a>删除缓存</h3><h4 id="del-清空指定缓存"><a href="#del-清空指定缓存" class="headerlink" title="del 清空指定缓存"></a>del 清空指定缓存</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.del(<span class="string">&#x27;name&#x27;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="flushall-清空所有缓存"><a href="#flushall-清空所有缓存" class="headerlink" title="flushall 清空所有缓存"></a>flushall 清空所有缓存</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.flushall()</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="lpop-从数组最左边删除一项"><a href="#lpop-从数组最左边删除一项" class="headerlink" title="lpop 从数组最左边删除一项"></a>lpop 从数组最左边删除一项</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.lpop(<span class="string">&#x27;userList&#x27;</span>)</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="rpop-从数组最右边删除一项"><a href="#rpop-从数组最右边删除一项" class="headerlink" title="rpop 从数组最右边删除一项"></a>rpop 从数组最右边删除一项</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> <span class="built_in">this</span>.app.redis.rpop(<span class="string">&#x27;userList&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h2 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h2><h3 id="egg-amqplib"><a href="#egg-amqplib" class="headerlink" title="egg-amqplib"></a>egg-amqplib</h3><p>基于 rabbitmq 消息队列封装的库<br>文档：<a target="_blank" rel="noopener" href="https://github.com/zubincheung/egg-amqplib">https://github.com/zubincheung/egg-amqplib</a><br>示例代码：<a target="_blank" rel="noopener" href="https://github.com/zubincheung/egg-amqplib/blob/master/test/fixtures/apps/amqplib-test/app/controller/home.js">https://github.com/zubincheung/egg-amqplib/blob/master/test/fixtures/apps/amqplib-test/app/controller/home.js</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">&#x27;egg&#x27;</span>).Controller;</span><br><span class="line"><span class="keyword">const</span> queueName = <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">publish</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; msg &#125; = <span class="built_in">this</span>.ctx.query;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ch = <span class="keyword">await</span> <span class="built_in">this</span>.app.amqplib.createChannel();</span><br><span class="line">    <span class="keyword">await</span> ch.assertQueue(queueName, &#123; <span class="attr">durable</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    <span class="keyword">const</span> ok = <span class="keyword">await</span> ch.sendToQueue(queueName, Buffer.from(msg));</span><br><span class="line">    <span class="keyword">await</span> ch.close();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.ctx.body = ok;</span><br><span class="line">    <span class="built_in">this</span>.ctx.status = <span class="number">200</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">consume</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ch = <span class="keyword">await</span> <span class="built_in">this</span>.app.amqplib.createChannel();</span><br><span class="line">    <span class="keyword">await</span> ch.assertQueue(queueName, &#123; <span class="attr">durable</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    <span class="keyword">const</span> msg = <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> ch.consume(queueName, <span class="function"><span class="params">msg</span> =&gt;</span> resolve(msg)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msg !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ch.ack(msg);</span><br><span class="line">      <span class="keyword">await</span> ch.close();</span><br><span class="line"></span><br><span class="line">      <span class="built_in">this</span>.ctx.status = <span class="number">200</span>;</span><br><span class="line">      <span class="built_in">this</span>.ctx.body = &#123; <span class="attr">msg</span>: msg.content.toString() &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.ctx.status = <span class="number">500</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = HomeController;</span><br></pre></td></tr></table></figure>

<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="rabbitMQ-安装"><a href="#rabbitMQ-安装" class="headerlink" title="rabbitMQ 安装"></a>rabbitMQ 安装</h4><ol>
<li>安装<br>安装完成，打开RabbitMQ Command 命令行提示窗口，输入以下命令<br><code>rabbitmq-plugins enable rabbitmq_management</code></li>
</ol>
<hr>
<ol>
<li>打开浏览器 <a target="_blank" rel="noopener" href="http://localhost:15672/">http://localhost:15672/</a> 默认账号：guest 密码：guest</li>
</ol>
<hr>
<ol>
<li>创建一个管理员<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/112322/4/19179/29102/615fe60eEc5ee6bc1/3596b453106f7407.png" alt="image.png"></li>
</ol>
<hr>
<ol>
<li>virtual hosts</li>
</ol>
<blockquote>
<p>virtual hosts 相当于 mysql 的数据库 数据库1 数据库2 数据库3…<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/207195/15/4204/12995/615fe614E3f83cf17/224e53962e7ced58.png" alt="image.png"></p>
</blockquote>
<hr>
<ol>
<li>创建一个 virtual hosts 库，相当于添加一个数据库</li>
</ol>
<blockquote>
<p>名字以 / 开头<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/108841/29/20167/41783/615fe61aE777f4285/e053856d85785484.png" alt="image.png"></p>
</blockquote>
<hr>
<ol>
<li>为用户授权这个库<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/198351/14/12064/33381/615fe621E9b04051c/6b3544f166682c66.png" alt="image.png"><br><img src="https://dd-static.jd.com/ddimg/jfs/t1/209181/35/4065/14205/615fe62dE7a75e350/acc47710f3b4eb68.png" alt="image.png"></li>
</ol>
<h3 id="简单队列"><a href="#简单队列" class="headerlink" title="简单队列"></a>简单队列</h3><h4 id="MQ-简单队列实战"><a href="#MQ-简单队列实战" class="headerlink" title="MQ 简单队列实战"></a>MQ 简单队列实战</h4><ul>
<li>模型：<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/200603/34/11881/6193/615fe68bE53065cce/195808094e0f6f74.png" alt="image.png"></li>
</ul>
<blockquote>
<p>P 是我们的生产者<br>中间的框是一个队列,代表消费者保留的消息缓冲区。<br>C 是我们的消费者</p>
</blockquote>
<hr>
<p>代码演示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">&#x27;egg&#x27;</span>).Controller;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一对一队列演示</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 频道名称</span></span><br><span class="line"><span class="keyword">const</span> queueName = <span class="string">&#x27;hasone&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生成者</span></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">send</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 获取要发送的消息</span></span><br><span class="line">    <span class="keyword">const</span> &#123; msg &#125; = <span class="built_in">this</span>.ctx.query</span><br><span class="line">    <span class="comment">// 2. 创建频道</span></span><br><span class="line">    <span class="keyword">const</span> ch = <span class="keyword">await</span> <span class="built_in">this</span>.app.amqplib.createChannel();</span><br><span class="line">    <span class="comment">// 3. 创建队列 durable 关闭持久化存储</span></span><br><span class="line">    <span class="keyword">await</span> ch.assertQueue(queueName, &#123; <span class="attr">durable</span>: <span class="literal">false</span> &#125;  );</span><br><span class="line">    <span class="comment">// 4. 发送消息</span></span><br><span class="line">    <span class="keyword">const</span> ok = <span class="keyword">await</span> ch.sendToQueue(queueName, Buffer.from(msg));</span><br><span class="line">    <span class="comment">// 5. 关闭连接</span></span><br><span class="line">    <span class="keyword">await</span> ch.close();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.ctx.body = ok;</span><br><span class="line">    <span class="built_in">this</span>.ctx.status = <span class="number">200</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 消费者</span></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">work</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 创建频道</span></span><br><span class="line">    <span class="keyword">const</span> ch = <span class="keyword">await</span> <span class="built_in">this</span>.app.amqplib.createChannel();</span><br><span class="line">    <span class="comment">// 2. 选择队列</span></span><br><span class="line">    <span class="keyword">await</span> ch.assertQueue(queueName, &#123; <span class="attr">durable</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    <span class="comment">//3. 接收队列的消息</span></span><br><span class="line">    <span class="keyword">const</span> resultMsg = <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> ch.consume(queueName, <span class="function"><span class="params">msg</span> =&gt;</span> resolve(msg), &#123; <span class="attr">noAck</span>: <span class="literal">true</span> &#125;));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 显示消息内容</span></span><br><span class="line">    <span class="keyword">if</span> (resultMsg !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ch.ack(resultMsg);</span><br><span class="line">      <span class="keyword">await</span> ch.close();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> &#123; content &#125; = resultMsg;</span><br><span class="line">      <span class="built_in">this</span>.status = <span class="number">200</span>;</span><br><span class="line">      <span class="built_in">this</span>.ctx.body = &#123; <span class="attr">msg</span>: content.toString() &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.ctx.body = <span class="string">&#x27;队列消费失败&#x27;</span></span><br><span class="line">      <span class="built_in">this</span>.ctx.status = <span class="number">500</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = UserController;</span><br></pre></td></tr></table></figure>



<h3 id="工作队列"><a href="#工作队列" class="headerlink" title="工作队列"></a>工作队列</h3><h4 id="rabbitMQ-工作队列-轮询分发"><a href="#rabbitMQ-工作队列-轮询分发" class="headerlink" title="rabbitMQ 工作队列 轮询分发"></a>rabbitMQ 工作队列 轮询分发</h4><p><img src="https://dd-static.jd.com/ddimg/jfs/t1/200887/37/10802/14137/615fe6aeE1a9d8ba3/a13b4b4d66f0cbdc.png" alt="image.png"></p>
<blockquote>
<p>简单队列是一对一的关系，一个生成者对应一个消费者，实际开发中，一般消费者是以业务相结合的，需要时间去处理业务，如果只有一个消费者，那么生产者就会积压很多消息，消费不出去</p>
</blockquote>
<hr>
<p>代码演示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">&#x27;egg&#x27;</span>).Controller;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 队列一对多演示</span></span><br><span class="line"><span class="comment"> * 生产者 ----&gt;  队列 ----&gt; 消费者</span></span><br><span class="line"><span class="comment">*                    ----&gt; 消费者</span></span><br><span class="line"><span class="comment">                     ----&gt; 消费者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 频道名称</span></span><br><span class="line"><span class="keyword">const</span> queueName = <span class="string">&#x27;hasMany&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生成者</span></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">send</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; msg &#125; = <span class="built_in">this</span>.ctx.query;</span><br><span class="line">    <span class="comment">//1. 创建频道</span></span><br><span class="line">    <span class="keyword">const</span> ch = <span class="keyword">await</span> <span class="built_in">this</span>.app.amqplib.createChannel();</span><br><span class="line">    <span class="comment">// 2. 创建队列 开启持久化存储</span></span><br><span class="line">    <span class="keyword">await</span> ch.assertQueue(queueName, &#123; <span class="attr">durable</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    <span class="comment">// 3. 发送消息</span></span><br><span class="line">    <span class="keyword">let</span> ok = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;<span class="number">50</span>; i++) &#123;</span><br><span class="line">      <span class="comment">// 此时我们确信即使RabbitMQ重新启动，task_queue队列也不会丢失。现在我们需要将消息标记为持久性 - 通过使用持久性选项Channel.sendToQueue。</span></span><br><span class="line">      ok = <span class="keyword">await</span> ch.sendToQueue(queueName, Buffer.from(msg+i), &#123; <span class="attr">persistent</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4. 关闭连接</span></span><br><span class="line">    <span class="keyword">await</span> ch.close();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.ctx.body = ok;</span><br><span class="line">    <span class="built_in">this</span>.ctx.status = <span class="number">200</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 消费者</span></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">work1</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">   <span class="comment">// 1. 创建频道</span></span><br><span class="line">   <span class="keyword">const</span> ch = <span class="keyword">await</span> <span class="built_in">this</span>.app.amqplib.createChannel();</span><br><span class="line">   <span class="comment">//2. 选择队列</span></span><br><span class="line">   <span class="keyword">await</span> ch.assertQueue(queueName, &#123; <span class="attr">durable</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">   <span class="comment">// 3. 接收消息 noAck 关闭消息自动确认模式</span></span><br><span class="line">，需要手动 ack</span><br><span class="line">   <span class="keyword">const</span> resultMsg = <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> ch.consume(queueName, <span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      resolve(msg)</span><br><span class="line">     &#125;, <span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">   &#125;, &#123; <span class="attr">noAck</span>: <span class="literal">false</span> &#125;) );</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (resultMsg !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; content &#125; = resultMsg;</span><br><span class="line">     <span class="comment">//消费者发回ack（nowledgement）告诉RabbitMQ已收到，处理了特定消息，RabbitMQ可以自由删除它</span></span><br><span class="line">    ch.ack(resultMsg);</span><br><span class="line">    <span class="keyword">await</span> ch.close();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.ctx.body = &#123; <span class="attr">work1</span>: content.toString() &#125;;</span><br><span class="line">    <span class="built_in">this</span>.ctx.status = <span class="number">200</span>;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>.ctx.body = <span class="string">&#x27;消费者1号失败&#x27;</span></span><br><span class="line">     <span class="built_in">this</span>.ctx.status = <span class="number">500</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">work2</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="comment">// 1. 创建频道</span></span><br><span class="line">   <span class="keyword">const</span> ch = <span class="keyword">await</span> <span class="built_in">this</span>.app.amqplib.createChannel();</span><br><span class="line">   <span class="comment">//2. 选择队列 RabbitMQ永远不会丢失我们的队列。为此，我们需要声明它是持久的</span></span><br><span class="line">   <span class="keyword">await</span> ch.assertQueue(queueName, &#123; <span class="attr">durable</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">   <span class="comment">// 3. 接收消息 noAck 开启自动确认模式</span></span><br><span class="line">   <span class="keyword">const</span> resultMsg = <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> ch.consume(queueName, <span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      resolve(msg)</span><br><span class="line">     &#125;, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line">   &#125;, &#123; <span class="attr">noAck</span>: <span class="literal">false</span> &#125;) );</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (resultMsg !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; content &#125; = resultMsg;</span><br><span class="line">    ch.ack(resultMsg);</span><br><span class="line">    <span class="keyword">await</span> ch.close();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.ctx.body = &#123; <span class="attr">work2</span>: content.toString() &#125;;</span><br><span class="line">    <span class="built_in">this</span>.ctx.status = <span class="number">200</span>;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>.ctx.body = <span class="string">&#x27;消费者2号失败&#x27;</span></span><br><span class="line">     <span class="built_in">this</span>.ctx.status = <span class="number">500</span></span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">work3</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">     <span class="comment">// 1. 创建频道</span></span><br><span class="line">   <span class="keyword">const</span> ch = <span class="keyword">await</span> <span class="built_in">this</span>.app.amqplib.createChannel();</span><br><span class="line">   <span class="comment">//2. 选择队列</span></span><br><span class="line">   <span class="keyword">await</span> ch.assertQueue(queueName, &#123; <span class="attr">durable</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">   <span class="comment">// 3. 接收消息 noAck 开启自动确认模式</span></span><br><span class="line">   <span class="keyword">const</span> resultMsg = <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> ch.consume(queueName, <span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      resolve(msg)</span><br><span class="line">     &#125;, <span class="number">1500</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   &#125;, &#123; <span class="attr">noAck</span>: <span class="literal">false</span> &#125;) );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (resultMsg !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; content &#125; = resultMsg;</span><br><span class="line">    <span class="comment">//消费者发回ack（nowledgement）告诉RabbitMQ已收到，处理了特定消息，RabbitMQ可以自由删除它</span></span><br><span class="line">    ch.ack(resultMsg);</span><br><span class="line">    <span class="keyword">await</span> ch.close();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.ctx.body = &#123; <span class="attr">work3</span>: content.toString() &#125;;</span><br><span class="line">    <span class="built_in">this</span>.ctx.status = <span class="number">200</span>;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="built_in">this</span>.ctx.body = <span class="string">&#x27;消费者3号失败&#x27;</span></span><br><span class="line">     <span class="built_in">this</span>.ctx.status = <span class="number">500</span></span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = UserController;</span><br></pre></td></tr></table></figure>



<h3 id="消息应答"><a href="#消息应答" class="headerlink" title="消息应答"></a>消息应答</h3><h4 id="消息应答-ack"><a href="#消息应答-ack" class="headerlink" title="消息应答 ack"></a>消息应答 ack</h4><blockquote>
<p>noAck: false 手动接收消息模式</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="title">consume</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ch = <span class="keyword">await</span> <span class="built_in">this</span>.app.amqplib.createChannel();</span><br><span class="line">    <span class="keyword">await</span> ch.assertQueue(queueName, &#123; <span class="attr">durable</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    <span class="keyword">const</span> msg = <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> ch.consume(queueName, <span class="function"><span class="params">msg</span> =&gt;</span> resolve(msg) , &#123; <span class="attr">noAck</span>: <span class="literal">false</span> &#125; ));</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (msg !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 告诉MQ 我已经收到消息并处理完成了，MQ会删除队列中的消息，并从内存中删除</span></span><br><span class="line">      ch.ack(msg);</span><br><span class="line">      <span class="keyword">await</span> ch.close();</span><br><span class="line"></span><br><span class="line">      <span class="built_in">this</span>.ctx.status = <span class="number">200</span>;</span><br><span class="line">      <span class="built_in">this</span>.ctx.body = &#123; <span class="attr">msg</span>: msg.content.toString() &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.ctx.status = <span class="number">500</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="邮件系统"><a href="#邮件系统" class="headerlink" title="邮件系统"></a>邮件系统</h2><h3 id="nodeMailer"><a href="#nodeMailer" class="headerlink" title="nodeMailer"></a>nodeMailer</h3><h4 id="egg-js-封装-nodeMailer-邮件发送类"><a href="#egg-js-封装-nodeMailer-邮件发送类" class="headerlink" title="egg.js 封装 nodeMailer 邮件发送类"></a>egg.js 封装 nodeMailer 邮件发送类</h4><p>文档：<a target="_blank" rel="noopener" href="https://nodemailer.com/about/">https://nodemailer.com/about/</a></p>
<ul>
<li>安装：npm install nodemailer –save</li>
<li>邮箱授权：<br>进入邮箱 》 设置 》 账户 》POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务<br>开启POP3/SMYP服务，获取授权码<br><img src="https://box.kancloud.cn/0d3cfa1f406928101ea7d3094ee017e7_801x189.png" alt="img"></li>
<li>使用nodemailer</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里举简单例子，也可以封装成service来调用</span></span><br><span class="line"><span class="comment">// 引入nodemailer</span></span><br><span class="line"><span class="keyword">const</span> nodemailer = <span class="built_in">require</span>(<span class="string">&#x27;nodemailer&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 封装发送者信息</span></span><br><span class="line"><span class="keyword">const</span> transporter = nodemailer.createTransport(&#123;</span><br><span class="line">  <span class="attr">service</span>: <span class="string">&#x27;qq&#x27;</span>, <span class="comment">// 调用qq服务器</span></span><br><span class="line">  <span class="attr">secureConnection</span>: <span class="literal">true</span>, <span class="comment">// 启动SSL</span></span><br><span class="line">  <span class="attr">port</span>: <span class="number">465</span>, <span class="comment">// 端口就是465</span></span><br><span class="line">  <span class="attr">auth</span>: &#123;</span><br><span class="line">    <span class="attr">user</span>: <span class="string">&#x27;xxxxx@qq.com&#x27;</span>, <span class="comment">// 账号</span></span><br><span class="line">    <span class="attr">pass</span>: <span class="string">&#x27;xxxxxxxxxx&#x27;</span>, <span class="comment">// 授权码,</span></span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 邮件参数及内容</span></span><br><span class="line"><span class="keyword">const</span> mailOptions = &#123;</span><br><span class="line">  <span class="attr">from</span>: <span class="string">&#x27;xxxxx@qq.com&#x27;</span>, <span class="comment">// 发送者,与上面的user一致</span></span><br><span class="line">  <span class="attr">to</span>: <span class="string">&#x27;xxxx@xxx.com&#x27;</span>, <span class="comment">// 接收者,可以同时发送多个,以逗号隔开</span></span><br><span class="line">  <span class="attr">subject</span>: <span class="string">&#x27;测试的邮件&#x27;</span>, <span class="comment">// 标题</span></span><br><span class="line">  <span class="comment">// text: &#x27;测试内容&#x27;, // 文本</span></span><br><span class="line">  <span class="attr">html</span>: <span class="string">&#x27;&lt;h2&gt;测试一下:&lt;/h2&gt;&lt;a class=&quot;elem-a&quot; href=&quot;https://baidu.com&quot;&gt;&lt;span class=&quot;content-elem-span&quot;&gt;测试链接&lt;/span&gt;&lt;/a&gt;&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用函数，发送邮件</span></span><br><span class="line"><span class="keyword">await</span> transporter.sendMail(mailOptions, <span class="function"><span class="keyword">function</span>(<span class="params">err, info</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(info);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li>简单封装<br>上面是直接使用nodemailer，在实际开发中，我们可以对其进行简单封装，以便调用<br>在app/service/tool.js文件</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/service/tool.js</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Service = <span class="built_in">require</span>(<span class="string">&#x27;egg&#x27;</span>).Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> nodemailer = <span class="built_in">require</span>(<span class="string">&#x27;nodemailer&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> user_email = <span class="string">&#x27;example@qq.com&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> auth_code = <span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> transporter = nodemailer.createTransport(&#123;</span><br><span class="line">  <span class="attr">service</span>: <span class="string">&#x27;qq&#x27;</span>,</span><br><span class="line">  <span class="attr">secureConnection</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">port</span>: <span class="number">465</span>,</span><br><span class="line">  <span class="attr">auth</span>: &#123;</span><br><span class="line">    <span class="attr">user</span>: user_email, <span class="comment">// 账号</span></span><br><span class="line">    <span class="attr">pass</span>: auth_code, <span class="comment">// 授权码</span></span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ToolService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">sendMail</span>(<span class="params">email, subject, text, html</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> mailOptions = &#123;</span><br><span class="line">      <span class="attr">from</span>: user_email, <span class="comment">// 发送者,与上面的user一致</span></span><br><span class="line">      <span class="attr">to</span>: email,   <span class="comment">// 接收者,可以同时发送多个,以逗号隔开</span></span><br><span class="line">      subject,   <span class="comment">// 标题</span></span><br><span class="line">      text,   <span class="comment">// 文本</span></span><br><span class="line">      html,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> transporter.sendMail(mailOptions);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = ToolService;</span><br></pre></td></tr></table></figure>

<ul>
<li>在测试controller中调用， app/controller/test.js</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/controller/test.js</span></span><br><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">&#x27;egg&#x27;</span>).Controller;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">testSendMail</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  	<span class="keyword">const</span> ctx = <span class="built_in">this</span>.ctx;</span><br><span class="line">  	</span><br><span class="line">  	<span class="keyword">const</span> email = <span class="string">&#x27;xxxxxx@163.com&#x27;</span>;  <span class="comment">// 接收者的邮箱</span></span><br><span class="line">    <span class="keyword">const</span> subject = <span class="string">&#x27;测试邮件&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> text = <span class="string">&#x27;这是一封测试邮件&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> html = <span class="string">&#x27;&lt;h2&gt;测试一下::&lt;/h2&gt;&lt;a class=&quot;elem-a&quot; href=&quot;https://baidu.com&quot;&gt;&lt;span class=&quot;content-elem-span&quot;&gt;测试链接&lt;/span&gt;&lt;/a&gt;&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> has_send = <span class="keyword">await</span> <span class="built_in">this</span>.service.tool.sendMail(email, subject, html);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (has_send) &#123;</span><br><span class="line">		ctx.body=&#123;</span><br><span class="line">			<span class="attr">message</span>: <span class="string">&#x27;发送成功&#x27;</span>,</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	ctx.body=&#123;</span><br><span class="line">		<span class="attr">message</span>: <span class="string">&#x27;发送失败&#x27;</span>,</span><br><span class="line">	&#125;;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = TestController;</span><br></pre></td></tr></table></figure>



<h2 id="第三方模块"><a href="#第三方模块" class="headerlink" title="第三方模块"></a>第三方模块</h2><h3 id="生成随机数"><a href="#生成随机数" class="headerlink" title="生成随机数"></a>生成随机数</h3><p>random 生成随机数包</p>
<p>文档：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/random">https://www.npmjs.com/package/random</a><br>安装：npm install –save random<br>封装代码：<br>app / extend / context.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入 jwt</span></span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>)</span><br><span class="line"><span class="comment">// 导入随机数包</span></span><br><span class="line"><span class="keyword">const</span> random = <span class="built_in">require</span>(<span class="string">&#x27;random&#x27;</span>)</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="comment">// 获取 jwt ctx.jwt</span></span><br><span class="line">    <span class="keyword">get</span> <span class="title">jwt</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> jwt</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 生成4位纯数字随机数 ctx.random</span></span><br><span class="line">    <span class="function"><span class="title">random</span>(<span class="params">min=<span class="number">1000</span>, max=<span class="number">9999</span></span>)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> random.int(min, max)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 返回json格式的信息</span></span><br><span class="line">    <span class="function"><span class="title">returnBody</span>(<span class="params">code=<span class="number">0</span>,msg=<span class="string">&#x27;&#x27;</span>,httpCode=<span class="number">200</span>,data=&#123;&#125;</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.status = httpCode</span><br><span class="line">        <span class="built_in">this</span>.body = &#123;</span><br><span class="line">            code,</span><br><span class="line">            msg,</span><br><span class="line">            data</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><h3 id="JWT鉴权"><a href="#JWT鉴权" class="headerlink" title="JWT鉴权"></a>JWT鉴权</h3><h4 id="基于JSON-WEB-TOKEN-封装-中间件鉴权"><a href="#基于JSON-WEB-TOKEN-封装-中间件鉴权" class="headerlink" title="基于JSON WEB TOKEN 封装 中间件鉴权"></a>基于JSON WEB TOKEN 封装 中间件鉴权</h4><ol>
<li>导入 jsonwebtoken 包<br>文档：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/jsonwebtoken">https://www.npmjs.com/package/jsonwebtoken</a><br>安装：<code>npm install jsonwebtoken</code></li>
</ol>
<hr>
<ol start="2">
<li>egg 框架配置<br>config / config.default.js 中配置 jwt</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/********** token 配置 **********/</span></span><br><span class="line">config.jwt = &#123;</span><br><span class="line"><span class="attr">secret</span>: <span class="string">&#x27;bcrypt&#x27;</span>,</span><br><span class="line"><span class="attr">expiresIn</span>: <span class="number">60</span>*<span class="number">60</span>*<span class="number">2</span> <span class="comment">// 2小时过期</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>secret : token 加密密钥<br>expiresIn：token 有效期</p>
</blockquote>
<p>app / extend / context.js 扩展 ctx 属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Cryptojs = <span class="built_in">require</span>(<span class="string">&#x27;crypto-js&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">get</span> <span class="title">jwt</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> jwt</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="title">returnSucc</span>(<span class="params">msg=<span class="string">&#x27;成功&#x27;</span>, code=<span class="number">0</span>, httpCode=<span class="number">200</span></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">global</span>.myErrors(msg, code, httpCode)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">returnError</span>(<span class="params">msg=<span class="string">&#x27;失败&#x27;</span>, code=<span class="number">1</span>, httpCode=<span class="number">400</span></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">global</span>.myErrors(msg, code, httpCode)</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">crypto</span>(<span class="params">value</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Cryptojs.HmacSHA256(value, <span class="string">&#x27;drw_admin888&#x27;</span>).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<ol start="3">
<li>配置中间件<br>app / config / config.default.js</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/********** 中间件配置 **********/</span></span><br><span class="line">config.middleware = [<span class="string">&#x27;errorHandler&#x27;</span>, <span class="string">&#x27;auth&#x27;</span>];</span><br><span class="line">config.auth = &#123;</span><br><span class="line">    <span class="attr">allowed</span>: [</span><br><span class="line">      <span class="string">&#x27;/api/v1/user/register&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;/api/v1/user/login&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>allowed：不需要token验证的路由</p>
</blockquote>
<hr>
<ol start="4">
<li>书写中间件<br>app / middleware / auth.js</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * token 访问授权</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>oprions &#123; Array &#125; 配置项：不需要鉴权的路由</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>app &#123; Object &#125; 当前应用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">options, app</span>) =&gt;</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.排除不需要验证 token 的路由</span></span><br><span class="line">        <span class="keyword">if</span> (options.allowed.indexOf(ctx.request.url) &gt; -<span class="number">1</span>) <span class="keyword">return</span> <span class="keyword">await</span> next(options);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 获取 header 头token        </span></span><br><span class="line">        <span class="keyword">const</span> &#123; authorization = <span class="string">&#x27;&#x27;</span> &#125; = ctx.header;</span><br><span class="line">        <span class="keyword">if</span> (!authorization) ctx.returnError(<span class="string">&#x27;您没有权限访问该接口!&#x27;</span>, <span class="number">0</span>, <span class="number">401</span>);</span><br><span class="line">        <span class="keyword">let</span> token = authorization.replace(<span class="string">&#x27;Bearer &#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">       </span><br><span class="line">        <span class="comment">//3. 根据token解密，换取用户信息</span></span><br><span class="line">        <span class="keyword">let</span> user = &#123;&#125;;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            user = ctx.jwt.verify(token, app.config.jwt.secret)</span><br><span class="line">        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            err.name === <span class="string">&#x27;TokenExpiredError&#x27;</span> ? ctx.returnError(<span class="string">&#x27;token 已过期! 请重新获取令牌&#x27;</span>)</span><br><span class="line">                : ctx.returnError(<span class="string">&#x27;Token 令牌不合法!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//4. 把 user 信息挂载到全局ctx上</span></span><br><span class="line">       ctx.auth = &#123;</span><br><span class="line">           <span class="attr">uid</span>: user.uid,</span><br><span class="line">           <span class="attr">scope</span>: user.scope</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 5. 继续执行</span></span><br><span class="line">       <span class="keyword">await</span> next(options);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="生成Token"><a href="#生成Token" class="headerlink" title="生成Token"></a>生成Token</h3><h4 id="JSON-WEB-TOKEN-生成令牌"><a href="#JSON-WEB-TOKEN-生成令牌" class="headerlink" title="JSON WEB TOKEN 生成令牌"></a>JSON WEB TOKEN 生成令牌</h4><p>扩展egg中的app对象，使用app.generateToken() 生成token</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成 Token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123; Object &#125;</span> </span>params </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="title">generateToken</span>(<span class="params"> params=&#123;&#125; </span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> jwt.sign(params, <span class="built_in">this</span>.config.jwt.secret, &#123; <span class="attr">expiresIn</span>: <span class="built_in">this</span>.config.jwt.expiresIn &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="短信服务"><a href="#短信服务" class="headerlink" title="短信服务"></a>短信服务</h2><h3 id="阿里短信验证码"><a href="#阿里短信验证码" class="headerlink" title="阿里短信验证码"></a>阿里短信验证码</h3><p>egg 集成阿里短信验证码</p>
<ol>
<li>安装Node.js SDK<br><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/112185.html?spm=a2c4g.11174283.6.634.36bf2c42lebO4R">https://help.aliyun.com/document_detail/112185.html?spm=a2c4g.11174283.6.634.36bf2c42lebO4R</a></li>
</ol>
<hr>
<ol>
<li>阿里控制器 添加签名<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/207920/30/4116/48611/615fe7e4E30551f2d/f6e16f56e85c5aba.png" alt="image.png"></li>
</ol>
<hr>
<ol>
<li>添加一个短信模板<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/201943/22/10238/40306/615fe7e9Ec8d61fb4/4006fe1c5a285398.png" alt="image.png"></li>
</ol>
<hr>
<ol>
<li>生成短信发送NodeJS类<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/205095/27/10045/37975/615fe7f3Ea3c76960/c31fda846f433ec0.png" alt="image.png"></li>
</ol>
<hr>
<ol>
<li>封装阿里生成的类，适用于eggJS</li>
</ol>
<ul>
<li>app / service / alisms.js 新建一个短信发送的服务类</li>
<li>详情请看附录</li>
</ul>
<hr>
<ol>
<li>新建一个 api.js 专属配置文件，然后合并到主配置文件 config / config.default.js<br><img src="https://dd-static.jd.com/ddimg/jfs/t1/210765/12/4110/10887/615fe7c7E44446d09/519474834cc0172f.png" alt="image.png"></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">config / api.js</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 阿里短信发送流程</span></span><br><span class="line"><span class="comment"> * 1. 到控制台 / 短信服务 / 国内消息 添加一个签名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="comment">/** 阿里大鱼短信验证码配置  **/</span></span><br><span class="line">    aliSMS: &#123;</span><br><span class="line">        <span class="attr">isopen</span>: <span class="literal">true</span>, <span class="comment">// 是否开启短信发送</span></span><br><span class="line">        <span class="attr">expire</span>: <span class="number">60</span>, <span class="comment">// 短信验证码有效期</span></span><br><span class="line">        <span class="attr">accessKeyId</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">accessSecret</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">regionId</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">product</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">version</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">SignName</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">TemplateCode</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="发送短信逻辑"><a href="#发送短信逻辑" class="headerlink" title="发送短信逻辑"></a>发送短信逻辑</h3><p>egg 发送短信逻辑 service</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Service = <span class="built_in">require</span>(<span class="string">&#x27;egg&#x27;</span>).Service;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 发送验证码</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">sendCode</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">//1. 获取用户手机号</span></span><br><span class="line">    <span class="keyword">const</span> &#123; phone &#125; = <span class="built_in">this</span>.ctx.request.body;</span><br><span class="line">    <span class="comment">//2. 缓存中查询该手机号是否存在</span></span><br><span class="line">    <span class="keyword">const</span> sendCodePhone = <span class="keyword">await</span> <span class="built_in">this</span>.service.cache.get(<span class="string">`sendCode_<span class="subst">$&#123;phone&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">if</span> (sendCodePhone) <span class="built_in">this</span>.ctx.errorHandle(<span class="string">&#x27;您操作的太快了，验证码还未过期!&#x27;</span>, &#123;&#125;, <span class="number">30001</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 生成随机四位验证码</span></span><br><span class="line">    <span class="keyword">const</span> randomCode = <span class="built_in">this</span>.ctx.random();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调试环境 不请求阿里服务器</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.config.aliSMS.isopen) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="built_in">this</span>._devCode(phone, randomCode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4. 请求阿里云API发送验证码</span></span><br><span class="line">    <span class="keyword">const</span> ret = <span class="keyword">await</span> <span class="built_in">this</span>.service.alisms.sendSMS(phone, randomCode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret.Code === <span class="string">&quot;OK&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// 5.发送成功写入redis缓存 60 秒过期</span></span><br><span class="line">      <span class="built_in">this</span>.service.cache.set(<span class="string">`sendCode_<span class="subst">$&#123;phone&#125;</span>`</span>, randomCode, <span class="built_in">this</span>.config.aliSMS.expire);</span><br><span class="line">      <span class="comment">// 6.写入消息队列</span></span><br><span class="line"></span><br><span class="line">      <span class="built_in">this</span>.ctx.succHandle(<span class="string">&#x27;发送验证码成功!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 模拟发送短信验证码</span></span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="title">_devCode</span>(<span class="params">phone, randomCode</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.service.cache.set(<span class="string">`sendCode_<span class="subst">$&#123;phone&#125;</span>`</span>, randomCode, <span class="built_in">this</span>.config.aliSMS.expire);</span><br><span class="line">    <span class="built_in">this</span>.ctx.succHandle(<span class="string">&#x27;请求验证码成功!&#x27;</span>, &#123; randomCode &#125;, <span class="number">30002</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = UserService;</span><br></pre></td></tr></table></figure>



<h3 id="阿里短信Node类"><a href="#阿里短信Node类" class="headerlink" title="阿里短信Node类"></a>阿里短信Node类</h3><p>封装基于eggJS短信发送类 Service 层</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="comment">// 引入阿里SDK</span></span><br><span class="line"><span class="keyword">const</span> Core = <span class="built_in">require</span>(<span class="string">&#x27;@alicloud/pop-core&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> Service = <span class="built_in">require</span>(<span class="string">&#x27;egg&#x27;</span>).Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 阿里短信验证码封装类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AlismsService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送短信</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123; String &#125;</span> </span>phone 用户手机号 </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param <span class="type">&#123; String &#125;</span> </span>code 生成的随机验证码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">sendSMS</span>(<span class="params">phone, code</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> client = <span class="keyword">await</span> <span class="built_in">this</span>._client();</span><br><span class="line">        <span class="keyword">const</span> params = <span class="keyword">await</span> <span class="built_in">this</span>._params(phone, code);</span><br><span class="line">        <span class="keyword">const</span> requestOption = <span class="keyword">await</span> <span class="built_in">this</span>._requestOption();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> ret = <span class="keyword">await</span> <span class="built_in">this</span>._send(client, params, requestOption);</span><br><span class="line">            <span class="comment">// &#123;&quot;Message&quot;:&quot;OK&quot;,&quot;RequestId&quot;:&quot;80A35575-6DD3-4A7D-B4AD-723F918CBBA5&quot;,&quot;BizId&quot;:&quot;627317463804615179^0&quot;,&quot;Code&quot;:&quot;OK&quot;&#125;</span></span><br><span class="line">           <span class="keyword">return</span> <span class="built_in">JSON</span>.parse(ret);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">            <span class="built_in">this</span>.ctx.errorHandle(err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">_client</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Core(&#123;</span><br><span class="line">            <span class="attr">accessKeyId</span>: <span class="built_in">this</span>.config.aliSMS.accessKeyId,</span><br><span class="line">            <span class="attr">accessKeySecret</span>: <span class="built_in">this</span>.config.aliSMS.accessSecret,</span><br><span class="line">            <span class="attr">endpoint</span>: <span class="string">&#x27;https://dysmsapi.aliyuncs.com&#x27;</span>,</span><br><span class="line">            <span class="attr">apiVersion</span>: <span class="string">&#x27;2017-05-25&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">_params</span>(<span class="params">phone, code</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;RegionId&quot;</span>: <span class="built_in">this</span>.config.aliSMS.regionId,</span><br><span class="line">            <span class="string">&quot;PhoneNumbers&quot;</span>: <span class="string">`<span class="subst">$&#123;phone&#125;</span>`</span>,</span><br><span class="line">            <span class="string">&quot;SignName&quot;</span>: <span class="built_in">this</span>.config.aliSMS.SignName,</span><br><span class="line">            <span class="string">&quot;TemplateCode&quot;</span>: <span class="built_in">this</span>.config.aliSMS.TemplateCode,</span><br><span class="line">            <span class="string">&quot;TemplateParam&quot;</span>: <span class="string">`&#123;\&quot;code\&quot;:<span class="subst">$&#123;code&#125;</span>&#125;`</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">_requestOption</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="function"><span class="title">_send</span>(<span class="params">client, params, requestOption</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            client.request(<span class="string">&#x27;SendSms&#x27;</span>, params, requestOption).then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">                resolve(<span class="built_in">JSON</span>.stringify(result))</span><br><span class="line">            &#125;, <span class="function">(<span class="params">ex</span>) =&gt;</span> &#123;</span><br><span class="line">                reject(ex)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = AlismsService;</span><br></pre></td></tr></table></figure>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://blog.xiaoandx.club/article/202110081126/" title="Egg.js 开发常用框架整合" target="_blank" rel="external">https://blog.xiaoandx.club/article/202110081126/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/xiaoandx" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/xiaoandx" target="_blank"><span class="text-dark">WEI.ZHOU</span><small class="ml-1x">大眼睛工程师</small></a></h3>
        <div>个人简介</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="lv-container" data-id="city" data-uid="MTAyMC81MTk2My8yODQ0NA==">
        <noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
      </div>    
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    
    <li class="next">
      <a href="/article/202110061446/" title="Egg.js自定义插件(xml解析器)"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>感谢您的支持，我会继续努力的!</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.jpg" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.jpg" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/xiaoandx" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="https://www.xiaoandx.club" target="_blank" title="Resume" data-toggle=tooltip data-placement=top><i class="icon icon-resume"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/xiaoandx" target="_blank"> xiaoandx </a>base on <a href="https://www.xiaoandx.club" target="_blank">resume</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





   
    
<script defer type="text/javascript">
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];

    if (typeof LivereTower === 'function') { return; }

    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;

    e.parentNode.insertBefore(j, e);
  })(document, 'script');
</script>








</body>
</html>